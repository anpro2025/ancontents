<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AN PRODUCTION AI FILMS - PROMPT STUDIO</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .hidden { display: none !important; }
        .script-item { display: flex; justify-content: space-between; align-items: center; }
        .script-item.active { background-color: #3b82f6; color: white; }
        .delete-btn { visibility: hidden; opacity: 0; transition: opacity 0.2s, visibility 0.2s; }
        .script-item:hover .delete-btn { visibility: visible; opacity: 1; }
        .loader {
            border: 2px solid #f3f3f3;
            border-top: 2px solid #4a90e2;
            border-radius: 50%;
            width: 16px;
            height: 16px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #111827; }
        ::-webkit-scrollbar-thumb { background: #4b5563; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #6b7280; }
        textarea { resize: none; }
        textarea:read-only, input:read-only { background-color: #374151; cursor: default; }
    </style>
</head>
<body class="bg-gray-900 text-white h-screen flex flex-col">
    <header class="text-center py-6 flex-shrink-0">
        <h1 class="text-4xl font-bold tracking-wider uppercase text-white">PROMPT STUDIO</h1>
    </header>
    
    <div class="flex space-x-8 flex-grow p-8 overflow-hidden">
        <!-- Left Sidebar with Buttons -->
        <aside id="sidebar" class="w-64 flex-shrink-0">
            <div class="flex flex-col space-y-4">
                <div class="flex flex-col space-y-2 items-start">
                    <!-- Memory Buttons -->
                    <div class="flex flex-wrap gap-2">
                        <button data-type="script" title="Đầu vào Dự án" class="memory-btn bg-yellow-600 hover:bg-yellow-700 text-gray-900 font-bold p-3 rounded-full transition duration-300"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z" /></svg></button>
                        <button data-type="prompt" title="Đầu vào Se" class="memory-btn bg-yellow-600 hover:bg-yellow-700 text-gray-900 font-bold p-3 rounded-full transition duration-300 flex items-center justify-center w-12 h-12"><span class="text-lg font-bold">Se</span></button>
                        <button data-type="voiceOver" title="Đầu vào VO" class="memory-btn bg-yellow-600 hover:bg-yellow-700 text-gray-900 font-bold p-3 rounded-full transition duration-300 flex items-center justify-center w-12 h-12"><span class="text-sm font-bold">VO</span></button>
                    </div>
                     <div class="flex flex-wrap gap-2">
                        <button data-type="mainScripts" title="Bộ nhớ Scripts" class="memory-btn bg-blue-600 hover:bg-blue-700 text-white font-bold p-3 rounded-full transition duration-300 flex items-center justify-center w-12 h-12"><span class="text-lg font-bold">S</span></button>
                        <button data-type="sections" title="Bộ nhớ Sections" class="memory-btn bg-blue-600 hover:bg-blue-700 text-white font-bold p-3 rounded-full transition duration-300 flex items-center justify-center w-12 h-12"><span class="text-sm font-bold">Se</span></button>
                        <button data-type="mainPrompts" title="Bộ nhớ Prompts" class="memory-btn bg-blue-600 hover:bg-blue-700 text-white font-bold p-3 rounded-full transition duration-300 flex items-center justify-center w-12 h-12"><span class="text-lg font-bold">P</span></button>
                        <button data-type="mainVoiceOvers" title="Bộ nhớ Voice Off" class="memory-btn bg-blue-600 hover:bg-blue-700 text-white font-bold p-3 rounded-full transition duration-300 flex items-center justify-center w-12 h-12"><span class="text-sm font-bold">VO</span></button>
                        <button data-type="trash" title="Bộ nhớ Rác" class="memory-btn bg-red-600 hover:bg-red-700 text-white font-bold p-3 rounded-full transition duration-300 flex items-center justify-center w-12 h-12"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg></button>
                    </div>
                </div>
                <div class="border-t border-gray-600 pt-4"></div>
                <a href="/ancontents/" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-8 rounded-lg transition duration-300 text-lg w-full text-left">P2S</a>
                <a href="/ancontents/S2Se/" class="bg-purple-600 hover:bg-purple-700 text-white font-bold py-3 px-8 rounded-lg transition duration-300 text-lg w-full text-left mt-4 inline-block">S2Se</a>
                <a href="/ancontents/Prompts-Studio/" class="bg-teal-600 hover:bg-teal-700 text-white font-bold py-3 px-8 rounded-lg transition duration-300 text-lg w-full text-left mt-4 inline-block">Prompt Studio</a>
            </div>
        </aside>

        <!-- Main Content Area -->
        <main id="main-workspace" class="flex-grow flex space-x-8 overflow-x-auto relative">
            <!-- Input Column -->
            <div class="w-1/3 flex-shrink-0 bg-gray-800 p-6 rounded-lg flex flex-col space-y-4">
                <div class="flex-grow flex flex-col min-h-0">
                    <div class="flex-shrink-0 mb-4">
                        <h2 class="text-xl font-bold mb-2">Soạn thảo Prompt</h2>
                        <label for="prompt-input-select" class="block text-sm font-medium text-blue-400">Hoặc chọn từ bộ nhớ Section (Se)</label>
                        <select id="prompt-input-select" class="mt-1 block w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-purple-500"></select>
                    </div>
                    <textarea id="prompt-input-content" class="block w-full h-full bg-gray-900 border border-gray-700 rounded-md p-3" placeholder="Nhập mô tả cảnh của bạn vào đây..."></textarea>
                </div>

                <!-- Output Options -->
                <div class="flex-shrink-0 space-y-3">
                     <h3 class="text-lg font-semibold border-t border-gray-700 pt-4">Tùy chọn đầu ra</h3>
                     <div>
                         <label for="camera-angle" class="block text-sm font-medium text-gray-300">Góc máy</label>
                         <select id="camera-angle" class="mt-1 block w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-md">
                             <option value="">AI tự chọn</option>
                             <option value="Wide Shot">Toàn cảnh (Wide Shot)</option>
                             <option value="Medium Shot">Trung cảnh (Medium Shot)</option>
                             <option value="Close-up Shot">Cận cảnh (Close-up)</option>
                             <option value="High-angle Shot">Góc máy từ trên cao</option>
                             <option value="Low-angle Shot">Góc máy từ dưới thấp</option>
                             <option value="Point of View (POV) Shot">Góc nhìn nhân vật (POV)</option>
                         </select>
                     </div>
                      <div>
                         <label for="lighting-style" class="block text-sm font-medium text-gray-300">Ánh sáng</label>
                         <select id="lighting-style" class="mt-1 block w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-md">
                             <option value="">AI tự chọn</option>
                             <option value="Daylight">Ánh sáng ban ngày</option>
                             <option value="Night lighting">Ánh sáng ban đêm</option>
                             <option value="High contrast, Chiaroscuro">Tương phản cao (Chiaroscuro)</option>
                             <option value="Soft light">Ánh sáng dịu</option>
                             <option value="Neon lights">Đèn neon</option>
                             <option value="Golden hour">Giờ vàng</option>
                         </select>
                     </div>
                      <div>
                         <label for="composition-style" class="block text-sm font-medium text-gray-300">Bố cục</label>
                         <select id="composition-style" class="mt-1 block w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-md">
                             <option value="">AI tự chọn</option>
                             <option value="Rule of Thirds">Quy tắc 1/3</option>
                             <option value="Symmetrical">Đối xứng</option>
                             <option value="Leading lines">Đường dẫn</option>
                             <option value="Frame within a frame">Khung trong khung</option>
                         </select>
                     </div>
                      <div>
                         <label for="extra-style" class="block text-sm font-medium text-gray-300">Mở rộng (Phong cách)</label>
                         <select id="extra-style" class="mt-1 block w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-md">
                             <option value="">AI tự chọn</option>
                             <option value="Cinematic, 8k, hyperrealistic">Điện ảnh, 8K, Siêu thực</option>
                             <option value="Anime style">Phong cách Anime</option>
                             <option value="Oil painting style">Phong cách Tranh sơn dầu</option>
                             <option value="Film grain">Tông màu phim (Film grain)</option>
                         </select>
                     </div>
                </div>

                <div class="flex-shrink-0 pt-4">
                     <div class="flex justify-end space-x-4">
                        <button type="submit" id="generate-btn" class="bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-4 rounded-md min-w-[100px] flex justify-center items-center">
                            <span class="btn-text">Gửi</span><span class="loader hidden ml-2"></span>
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Result Column -->
            <div id="result-container" class="w-2/3 flex-1 bg-gray-800 p-6 rounded-lg flex-col min-h-0 hidden overflow-y-auto">
                 <div class="flex justify-between items-center mb-4 flex-shrink-0">
                    <h2 class="text-xl font-bold">Các Prompts được tạo</h2>
                 </div>
                 <div class="space-y-4">
                    <!-- Background Prompt -->
                    <div>
                        <div class="flex justify-between items-center mb-1">
                            <h3 class="text-lg font-semibold text-teal-300">Prompt Bối cảnh (T2I)</h3>
                            <button data-target="background-prompt-output" class="copy-btn bg-gray-600 hover:bg-gray-500 text-white font-bold p-1 rounded-md text-xs">Copy</button>
                        </div>
                        <textarea id="background-prompt-output" rows="4" readonly class="mt-1 block w-full bg-gray-900 border border-gray-700 rounded-md p-2 text-sm"></textarea>
                    </div>
                    <!-- Character Prompt -->
                    <div>
                         <div class="flex justify-between items-center mb-1">
                            <h3 class="text-lg font-semibold text-teal-300">Prompt Nhân vật</h3>
                            <button data-target="character-prompt-output" class="copy-btn bg-gray-600 hover:bg-gray-500 text-white font-bold p-1 rounded-md text-xs">Copy</button>
                        </div>
                        <textarea id="character-prompt-output" rows="4" readonly class="mt-1 block w-full bg-gray-900 border border-gray-700 rounded-md p-2 text-sm"></textarea>
                    </div>
                     <!-- Seed Image Prompt -->
                    <div>
                         <div class="flex justify-between items-center mb-1">
                            <h3 class="text-lg font-semibold text-teal-300">Prompt Ảnh mồi (I2V)</h3>
                            <button data-target="seed-image-prompt-output" class="copy-btn bg-gray-600 hover:bg-gray-500 text-white font-bold p-1 rounded-md text-xs">Copy</button>
                        </div>
                        <textarea id="seed-image-prompt-output" rows="5" readonly class="mt-1 block w-full bg-gray-900 border border-gray-700 rounded-md p-2 text-sm"></textarea>
                    </div>
                     <!-- Video Prompt -->
                    <div>
                         <div class="flex justify-between items-center mb-1">
                            <h3 class="text-lg font-semibold text-teal-300">Prompt Video (T2V)</h3>
                            <button data-target="video-prompt-output" class="copy-btn bg-gray-600 hover:bg-gray-500 text-white font-bold p-1 rounded-md text-xs">Copy</button>
                        </div>
                        <textarea id="video-prompt-output" rows="5" readonly class="mt-1 block w-full bg-gray-900 border border-gray-700 rounded-md p-2 text-sm"></textarea>
                    </div>
                 </div>
            </div>
        </main>
    </div>
    
    <!-- Modals are omitted for brevity but should be included from the main file -->
    <div id="memory-modal-container" class="modal-overlay hidden fixed inset-0 bg-black bg-opacity-70 backdrop-blur-sm flex items-center justify-center z-50 p-4">...</div>
    <div id="api-key-container" class="modal-overlay hidden fixed inset-0 bg-black bg-opacity-70 backdrop-blur-sm flex items-center justify-center z-50 p-4">...</div>
    <div id="delete-confirm-modal" class="modal-overlay hidden fixed inset-0 bg-black bg-opacity-70 backdrop-blur-sm flex items-center justify-center z-[60] p-4">...</div>
    
    <div id="toast-container" class="fixed top-5 left-5 z-[100] space-y-2"></div>
    
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- UI Elements ---
            const generateBtn = document.getElementById('generate-btn');
            const promptInputContent = document.getElementById('prompt-input-content');
            const promptInputSelect = document.getElementById('prompt-input-select');
            
            const resultContainer = document.getElementById('result-container');
            const backgroundOutput = document.getElementById('background-prompt-output');
            const characterOutput = document.getElementById('character-prompt-output');
            const seedImageOutput = document.getElementById('seed-image-prompt-output');
            const videoOutput = document.getElementById('video-prompt-output');

            const cameraAngleSelect = document.getElementById('camera-angle');
            const lightingStyleSelect = document.getElementById('lighting-style');
            const compositionStyleSelect = document.getElementById('composition-style');
            const extraStyleSelect = document.getElementById('extra-style');
            
            // --- Modal Elements ---
            // (Assuming full modal HTML is present)
            const apiKeyBtn = document.getElementById('api-key-btn');
            const apiKeyContainer = document.querySelector('#api-key-container');

            // --- State & Config ---
            const memoryConfig = {
                script: { title: 'Đầu vào Dự án', storageKey: 'input_scripts' },
                prompt: { title: 'Đầu vào Se', storageKey: 'input_prompts' },
                voiceOver: { title: 'Đầu vào VO', storageKey: 'input_voiceOvers' },
                mainScripts: { title: 'Bộ nhớ Scripts', storageKey: 'memory_mainScripts' },
                sections: { title: 'Bộ nhớ Sections', storageKey: 'memory_sections' },
                mainPrompts: { title: 'Bộ nhớ Prompts', storageKey: 'memory_mainPrompts' },
                mainVoiceOvers: { title: 'Bộ nhớ Voice Off', storageKey: 'memory_mainVoiceOvers' },
                trash: { title: 'Bộ nhớ Rác', storageKey: 'memory_trash' }
            };
            
            const state = {
                sections: JSON.parse(localStorage.getItem(memoryConfig.sections.storageKey)) || [],
                settings: {
                    apiKey: localStorage.getItem('apiKey') || '',
                    aiModel: localStorage.getItem('aiModel') || 'gemini-2.5-flash-preview-05-20'
                },
            };

            // --- UI Helper Functions ---
            function showToast(message, type = 'info') {
                const colors = { success: 'bg-green-600', error: 'bg-red-600', info: 'bg-blue-600' };
                const toastContainer = document.getElementById('toast-container');
                const toast = document.createElement('div');
                toast.className = `text-white py-2 px-4 rounded-lg shadow-lg transform transition-all duration-300 -translate-x-full ${colors[type] || colors.info}`;
                toast.textContent = message;
                toastContainer.appendChild(toast);
                setTimeout(() => toast.classList.remove('-translate-x-full'), 10);
                setTimeout(() => {
                    toast.classList.add('-translate-x-full');
                    toast.addEventListener('transitionend', () => toast.remove());
                }, 3000);
            }
            
            function setButtonLoading(button, isLoading) {
                if (!button) return;
                const btnText = button.querySelector('.btn-text');
                const loader = button.querySelector('.loader');
                button.disabled = isLoading;
                if (btnText) btnText.textContent = isLoading ? 'Đang gửi...' : 'Gửi';
                if (loader) loader.classList.toggle('hidden', !isLoading);
            }

            // --- API Calls ---
            async function generateStructuredPrompt(prompt, submitButton) {
                setButtonLoading(submitButton, true);
                if (!state.settings.apiKey) {
                    setButtonLoading(submitButton, false);
                    throw new Error('Vui lòng nhập API Key trong Cài đặt.');
                }
                try {
                    const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${state.settings.aiModel}:generateContent?key=${state.settings.apiKey}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            contents: [{ parts: [{ text: prompt }] }],
                            generationConfig: { 
                                responseMimeType: "application/json",
                                responseSchema: {
                                    type: "OBJECT",
                                    properties: {
                                        background_prompt: { type: "STRING" },
                                        character_prompt: { type: "STRING" },
                                        seed_image_prompt: { type: "STRING" },
                                        video_prompt: { type: "STRING" }
                                    },
                                    required: ["background_prompt", "character_prompt", "seed_image_prompt", "video_prompt"]
                                }
                            }
                        })
                    });
                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(errorData.error?.message || `Lỗi HTTP: ${response.status}`);
                    }
                    const result = await response.json();
                    const text = result.candidates?.[0]?.content?.parts?.[0]?.text;
                    if (!text) throw new Error("Không nhận được phản hồi hợp lệ từ AI.");
                    return JSON.parse(text);
                } finally {
                    setButtonLoading(submitButton, false);
                }
            }
            
            // --- Initial Setup & Event Listeners ---
            function populateSectionDropdown() {
                promptInputSelect.innerHTML = `<option value="">Chọn từ bộ nhớ Se...</option>`;
                [...state.sections].sort((a, b) => b.id - a.id).forEach(item => {
                    promptInputSelect.innerHTML += `<option value="${item.id}">${item.title}</option>`;
                });
            }

            generateBtn.addEventListener('click', async () => {
                const baseDescription = promptInputContent.value.trim();
                if (!baseDescription) return showToast('Vui lòng nhập mô tả cảnh.', 'error');
                if (!state.settings.apiKey) {
                    showToast('Vui lòng nhập API Key trong Cài đặt.', 'error');
                    apiKeyBtn.click();
                    return;
                }

                resultContainer.classList.remove('hidden');
                backgroundOutput.value = characterOutput.value = seedImageOutput.value = videoOutput.value = 'Đang tạo...';

                const masterPrompt = `
                    You are an expert prompt engineer for generative AI models (image and video).
                    Your task is to take a user's scene description and expand it into four detailed, effective prompts for different AI models.
                    The user will provide a base description and may optionally provide specific cinematic styles.

                    Based on the following information:
                    - Base Description: ${baseDescription}
                    - Camera Angle: ${cameraAngleSelect.value || 'AI choice'}
                    - Lighting Style: ${lightingStyleSelect.value || 'AI choice'}
                    - Composition: ${compositionStyleSelect.value || 'AI choice'}
                    - Extra Style: ${extraStyleSelect.value || 'AI choice'}

                    Generate a JSON object with four keys: "background_prompt", "character_prompt", "seed_image_prompt", and "video_prompt".

                    - "background_prompt": A detailed text-to-image prompt focusing ONLY on the environment, setting, and atmosphere. Exclude any characters.
                    - "character_prompt": A detailed text-to-image prompt focusing ONLY on the character(s) described, their appearance, clothing, and expression. Use a plain, neutral background (e.g., 'plain gray background').
                    - "seed_image_prompt": A text-to-image prompt that combines the background and character into a single, highly detailed, cinematic keyframe. This image will be used as a reference for an image-to-video model. It should describe a specific moment of action or emotion.
                    - "video_prompt": A text-to-video prompt describing the entire scene in motion. It should detail the character's actions, camera movement, and changes in the environment or lighting over a short duration (e.g., 3-5 seconds).

                    If the user does not specify a style for camera, lighting, etc., you must choose a suitable and creative option that fits the scene.

                    Return ONLY the valid JSON object.`;

                try {
                    const result = await generateStructuredPrompt(masterPrompt, generateBtn);
                    backgroundOutput.value = result.background_prompt || 'Không có dữ liệu';
                    characterOutput.value = result.character_prompt || 'Không có dữ liệu';
                    seedImageOutput.value = result.seed_image_prompt || 'Không có dữ liệu';
                    videoOutput.value = result.video_prompt || 'Không có dữ liệu';
                } catch (error) {
                    console.error('Lỗi khi tạo prompts:', error);
                    showToast(`Lỗi: ${error.message}`, 'error');
                    const errorMessage = `Đã xảy ra lỗi: ${error.message}`;
                    backgroundOutput.value = characterOutput.value = seedImageOutput.value = videoOutput.value = errorMessage;
                }
            });

            promptInputSelect.addEventListener('change', (e) => {
                const selectedId = e.target.value;
                if (selectedId) {
                    const selectedItem = state.sections.find(p => p.id == selectedId);
                    if (selectedItem) promptInputContent.value = selectedItem.content;
                }
            });

            document.body.addEventListener('click', e => {
                const button = e.target.closest('button.copy-btn');
                if (!button) return;
                const targetId = button.dataset.target;
                const contentEl = document.getElementById(targetId);
                if (contentEl && contentEl.value) {
                    navigator.clipboard.writeText(contentEl.value).then(() => showToast('Đã sao chép!', 'success'));
                }
            });

            // --- Initial Load ---
            function initialLoad() {
                const dataFromS2Se = localStorage.getItem('promptStudioInput');
                if (dataFromS2Se) {
                    promptInputContent.value = dataFromS2Se;
                    localStorage.removeItem('promptStudioInput');
                }
                populateSectionDropdown();
            }

            initialLoad();
            
            // NOTE: The full modal logic and other event listeners from the original file 
            // should be included here for full functionality. This script is focused on the new features.
        });
    </script>
</body>
</html>

