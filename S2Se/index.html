<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>S2Se - Tạo phân đoạn chi tiết</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { 
            font-family: 'Inter', sans-serif; 
        }
        .hidden {
            display: none;
        }
        /* Loading spinner */
        .loader {
            border: 2px solid #f3f3f3;
            border-top: 2px solid #4a90e2;
            border-radius: 50%;
            width: 16px;
            height: 16px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        /* Custom scrollbar for better aesthetics */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #111827; }
        ::-webkit-scrollbar-thumb { background: #4b5563; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #6b7280; }
    </style>
</head>
<body class="bg-gray-900 text-white h-screen flex flex-col p-8">
    
    <header class="flex justify-between items-center mb-6 flex-shrink-0">
        <h1 class="text-3xl font-bold">S2Se - Tạo phân đoạn chi tiết</h1>
        <a href="../" title="Quay lại Story Broad" class="bg-gray-700 hover:bg-gray-600 text-white font-bold p-3 rounded-full transition duration-300">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
              <path stroke-linecap="round" stroke-linejoin="round" d="M11 15l-3-3m0 0l3-3m-3 3h8M3 12a9 9 0 1118 0 9 9 0 01-18 0z" />
            </svg>
        </a>
    </header>

    <main class="flex-grow flex space-x-8 overflow-hidden">
        <!-- Input Column -->
        <div class="w-1/2 flex-shrink-0 bg-gray-800 p-6 rounded-lg flex flex-col">
            <h2 class="text-2xl font-bold mb-6">Nhập liệu</h2>
            <form id="segment-form" class="space-y-4 flex-grow flex flex-col">
                 <div class="flex-grow flex flex-col">
                    <label for="segment-input-script" class="block text-sm font-medium text-yellow-400">Đầu vào Dự án</label>
                    <textarea id="segment-input-script" rows="8" class="mt-1 block w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-yellow-500 flex-grow" placeholder="Nội dung kịch bản từ bước trước..."></textarea>
                </div>
                
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label for="segment-count" class="block text-sm font-medium text-gray-300">Số lượng Se (phân cảnh)</label>
                        <input type="number" id="segment-count" value="3" min="1" class="mt-1 block w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-yellow-500">
                    </div>
                     <div>
                        <label for="prompt-count" class="block text-sm font-medium text-gray-300">Số lượng Prompts / Se</label>
                        <input type="number" id="prompt-count" value="2" min="1" class="mt-1 block w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-yellow-500">
                    </div>
                </div>

                <div class="flex justify-end space-x-4 pt-4">
                    <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-md min-w-[80px] flex justify-center items-center">
                        <span class="btn-text">Tạo</span>
                        <span class="loader hidden ml-2"></span>
                    </button>
                </div>
            </form>
        </div>
        
        <!-- Result Column -->
        <div id="segment-result-container" class="w-1/2 flex-grow bg-gray-800 p-6 rounded-lg flex flex-col overflow-y-auto">
            <h2 class="text-2xl font-bold mb-4 flex-shrink-0">Kết quả Phân đoạn</h2>
            <div id="segment-result-list" class="space-y-4">
                <!-- Segment cards will be rendered here -->
            </div>
        </div>
    </main>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- UI Elements ---
            const segmentForm = document.getElementById('segment-form');
            const segmentInputScript = document.getElementById('segment-input-script');
            const segmentResultList = document.getElementById('segment-result-list');
            
            // --- Data Store ---
            let apiKey = localStorage.getItem('apiKey') || ''; // Fetch API key from parent's storage

            // --- Functions ---
            function downloadAsTxt(title, content) {
                const blob = new Blob([content], { type: 'text/plain;charset=utf-8' });
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                const fileName = title.toLowerCase().replace(/[^a-z0-9\s-]/g, '').replace(/\s+/g, '_').substring(0, 50) + '.txt';
                link.href = url;
                link.download = fileName;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url);
            }

            async function generateAiContent(prompt, submitButton) {
                 const btnText = submitButton.querySelector('.btn-text');
                 const loader = submitButton.querySelector('.loader');

                 btnText.textContent = 'Đang tạo...';
                 loader.classList.remove('hidden');
                 submitButton.disabled = true;

                try {
                     const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                    });
                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(errorData.error.message || `Lỗi HTTP: ${response.status}`);
                    }
                    const result = await response.json();
                    return result.candidates[0]?.content?.parts[0]?.text || "";
                } finally {
                    btnText.textContent = 'Tạo';
                    loader.classList.add('hidden');
                    submitButton.disabled = false;
                }
            }

            function renderResults(results) {
                segmentResultList.innerHTML = ''; // Clear previous results
                if (!Array.isArray(results)) {
                    segmentResultList.innerHTML = `<p class="text-red-400">Lỗi: AI không trả về định dạng mong muốn.</p>`;
                    return;
                }

                results.forEach(scene => {
                    const sceneCard = document.createElement('div');
                    sceneCard.className = 'bg-gray-900 p-4 rounded-lg space-y-3';
                    sceneCard.dataset.sceneId = scene.scene;

                    const promptsHtml = scene.prompts.map(p => `<li class="text-sm text-gray-300">${p}</li>`).join('');

                    sceneCard.innerHTML = `
                        <h3 class="text-lg font-bold text-yellow-400">Phân cảnh ${scene.scene}</h3>
                        <div>
                            <h4 class="font-semibold text-gray-300 mb-1">Mô tả chi tiết:</h4>
                            <p class="text-gray-400 text-sm whitespace-pre-wrap">${scene.description}</p>
                        </div>
                        <div>
                            <h4 class="font-semibold text-gray-300 mb-2">Prompts đề xuất (cho video 8 giây):</h4>
                            <ul class="list-disc list-inside space-y-2 pl-2">
                                ${promptsHtml}
                            </ul>
                        </div>
                        <div class="flex justify-end space-x-2 pt-2">
                             <button data-content-type="scene" class="copy-btn bg-green-600 hover:bg-green-700 text-white font-bold py-1 px-3 text-sm rounded-md">Copy</button>
                             <button data-content-type="scene" class="export-btn bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-1 px-3 text-sm rounded-md">Xuất</button>
                        </div>
                    `;
                    segmentResultList.appendChild(sceneCard);
                });
            }
            
            // --- Initial Load ---
            const scriptToProcess = localStorage.getItem('scriptToProcess');
            if (scriptToProcess) {
                segmentInputScript.value = scriptToProcess;
                localStorage.removeItem('scriptToProcess'); // Clear after use
            }

            // --- Event Listeners ---
            document.body.addEventListener('click', e => {
                 const button = e.target.closest('button');
                if (!button) return;

                if (button.classList.contains('copy-btn')) {
                    const card = button.closest('.bg-gray-900');
                    const title = card.querySelector('h3').textContent;
                    const description = card.querySelector('p').textContent;
                    const prompts = Array.from(card.querySelectorAll('li')).map(li => `- ${li.textContent}`).join('\n');
                    const contentToCopy = `${title}\n\nMô tả:\n${description}\n\nPrompts:\n${prompts}`;
                    navigator.clipboard.writeText(contentToCopy).then(() => alert('Đã sao chép nội dung phân cảnh!')).catch(err => alert('Sao chép thất bại!'));
                }
                
                if (button.classList.contains('export-btn')) {
                    const card = button.closest('.bg-gray-900');
                    const title = card.querySelector('h3').textContent;
                    const description = card.querySelector('p').textContent;
                    const prompts = Array.from(card.querySelectorAll('li')).map(li => `- ${li.textContent}`).join('\n');
                    const contentToExport = `${title}\n\nMô tả:\n${description}\n\nPrompts:\n${prompts}`;
                    downloadAsTxt(title, contentToExport);
                }
            });

            segmentForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                
                const submitButton = e.target.querySelector('button[type="submit"]');
                const inputScript = segmentInputScript.value;
                const sceneCount = document.getElementById('segment-count').value;
                const promptCount = document.getElementById('prompt-count').value;
        
                if (!inputScript.trim()) {
                    alert('Vui lòng nhập thông tin kịch bản đầu vào.');
                    return;
                }
                
                let finalPrompt = `Bạn là một biên kịch và chuyên gia prompt video. Dựa trên kịch bản gốc dưới đây, hãy thực hiện các yêu cầu sau:

                **Kịch bản gốc:**
                ---
                ${inputScript}
                ---

                **Yêu cầu:**
                1. Chia kịch bản gốc thành **${sceneCount}** phân cảnh (Se) riêng biệt.
                2. Với mỗi phân cảnh, hãy viết một mô tả chi tiết về hình ảnh và hành động.
                3. Với mỗi phân cảnh, hãy tạo ra **${promptCount}** prompts chi tiết, độc đáo, theo phong cách điện ảnh, dành cho mô hình AI text-to-video như Google Veo để tạo ra một video clip dài 8 giây. Mỗi prompt phải tập trung vào một khía cạnh khác nhau của phân cảnh (ví dụ: một prompt tập trung vào nhân vật, một prompt vào bối cảnh, một vào hành động cụ thể).

                **Định dạng đầu ra:**
                Vui lòng trả lời bằng một chuỗi JSON hợp lệ. Chuỗi JSON phải là một mảng (array) các đối tượng (object). Mỗi đối tượng đại diện cho một phân cảnh và phải có cấu trúc sau:
                {
                  "scene": "số thứ tự phân cảnh (ví dụ: 1)",
                  "description": "Mô tả chi tiết phân cảnh ở đây.",
                  "prompts": [
                    "prompt chi tiết thứ nhất.",
                    "prompt chi tiết thứ hai.",
                    "..."
                  ]
                }

                Không thêm bất kỳ văn bản nào khác ngoài chuỗi JSON.`;

                try {
                    segmentResultList.innerHTML = '<div class="loader mx-auto"></div>';
                    const resultJsonString = await generateAiContent(finalPrompt, submitButton);
                    
                    if (!resultJsonString) throw new Error("AI không trả về kết quả.");

                    const results = JSON.parse(resultJsonString);
                    renderResults(results);

                } catch (error) {
                    segmentResultList.innerHTML = `<p class="text-red-400">Lỗi: ${error.message}. Vui lòng thử lại.</p>`;
                    console.error('Lỗi khi tạo phân đoạn:', error);
                }
            });
        });
    </script>
</body>
</html>

