<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AN PRODUCTION - S2Se (Script to Section)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-main: #111827; --bg-panel: #1f2937; --bg-input: #374151;
            --border-color: #4b5563; --text-main: #d1d5db; --text-heading: #ffffff;
            --primary-color: #8b5cf6; --secondary-color: #14b8a6; --accent-color: #f59e0b;
            --info-color: #3b82f6; --danger-color: #ef4444;
        }
        body { font-family: 'Inter', sans-serif; background-color: var(--bg-main); color: var(--text-main); }
        .hidden { display: none !important; }
        .script-item { display: flex; justify-content: space-between; align-items: center; }
        .script-item.active { background-color: var(--info-color); color: white; }
        .script-item:hover { background-color: #374151; }
        .delete-btn { visibility: hidden; opacity: 0; transition: opacity 0.2s; }
        .script-item:hover .delete-btn { visibility: visible; opacity: 1; }
        .loader {
            border: 2px solid #f3f3f3; border-top: 2px solid var(--info-color);
            border-radius: 50%; width: 16px; height: 16px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        #collapsible-sidebar:hover::-webkit-scrollbar {
            display: block;
            width: 8px;
        }
        ::-webkit-scrollbar-track { background: #1f2937; }
        ::-webkit-scrollbar-thumb { background: #4b5563; border-radius: 4px; }
        textarea, select { resize: none; background-color: var(--bg-input); border-color: var(--border-color); }
        .memory-count {
            position: absolute;
            top: 8px;
            right: 8px;
            background-color: white;
            color: #1f2937;
            border-radius: 9999px;
            font-size: 10px;
            font-weight: bold;
            line-height: 1;
            padding: 2px 5px;
            min-width: 18px;
            text-align: center;
            border: 2px solid #374151;
        }
        #collapsible-sidebar .sidebar-text {
            white-space: nowrap;
        }
         #collapsible-sidebar::-webkit-scrollbar {
            display: none;
        }
    </style>
</head>
<body class="flex h-screen bg-gray-900 text-white">
    <!-- Collapsible Sidebar -->
    <aside id="collapsible-sidebar" class="bg-gray-800 flex flex-col p-2 transition-all duration-300 z-40 h-full">
        <div class="flex-grow flex flex-col space-y-4 overflow-y-auto">
            <h3 class="sidebar-text text-xs uppercase text-gray-400 px-3 pt-4">Đầu vào</h3>
            <ul class="space-y-2">
                <li><button data-type="script" title="Đầu vào Dự án" class="memory-btn w-full flex items-center p-3 space-x-4 rounded-full hover:bg-gray-700"><span class="text-lg font-bold w-6 text-center flex-shrink-0">S</span><span class="sidebar-text">Dự án</span></button></li>
                <li><button data-type="prompt" title="Đầu vào Se" class="memory-btn w-full flex items-center p-3 space-x-4 rounded-full hover:bg-gray-700"><span class="text-lg font-bold w-6 text-center flex-shrink-0">Se</span><span class="sidebar-text">Section</span></button></li>
                <li><button data-type="voiceOver" title="Đầu vào VO" class="memory-btn w-full flex items-center p-3 space-x-4 rounded-full hover:bg-gray-700"><span class="text-lg font-bold w-6 text-center flex-shrink-0">VO</span><span class="sidebar-text">Voice Over</span></button></li>
            </ul>
             <div class="border-t border-gray-700 my-2"></div>

            <h3 class="sidebar-text text-xs uppercase text-gray-400 px-3">Bộ nhớ</h3>
            <ul class="space-y-2">
                <li><button data-type="mainScripts" title="Bộ nhớ Scripts" class="memory-btn relative w-full flex items-center p-3 space-x-4 rounded-full hover:bg-gray-700"><span class="text-lg font-bold w-6 text-center flex-shrink-0">S</span><span class="sidebar-text">Scripts</span><span class="memory-count hidden ml-auto"></span></button></li>
                <li><button data-type="sections" title="Bộ nhớ Sections" class="memory-btn relative w-full flex items-center p-3 space-x-4 rounded-full hover:bg-gray-700"><span class="text-sm font-bold w-6 text-center flex-shrink-0">Se</span><span class="sidebar-text">Sections</span><span class="memory-count hidden ml-auto"></span></button></li>
                <li><button data-type="scenes" title="Bộ nhớ Bối cảnh" class="memory-btn relative w-full flex items-center p-3 space-x-4 rounded-full hover:bg-gray-700"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 21V10m0 0a8.001 8.001 0 00-8-8h0a8.001 8.001 0 008 8zm0 0a8.001 8.001 0 018-8h0a8.001 8.001 0 01-8 8z" /></svg><span class="sidebar-text">Bối cảnh</span><span class="memory-count hidden ml-auto"></span></button></li>
                <li><button data-type="characters" title="Bộ nhớ Nhân vật" class="memory-btn relative w-full flex items-center p-3 space-x-4 rounded-full hover:bg-gray-700"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" /></svg><span class="sidebar-text">Nhân vật</span><span class="memory-count hidden ml-auto"></span></button></li>
                <li><button data-type="mainPrompts" title="Bộ nhớ Prompts" class="memory-btn relative w-full flex items-center p-3 space-x-4 rounded-full hover:bg-gray-700"><span class="text-lg font-bold w-6 text-center flex-shrink-0">P</span><span class="sidebar-text">Prompts</span><span class="memory-count hidden ml-auto"></span></button></li>
                <li><button data-type="mainVoiceOvers" title="Bộ nhớ Voice Off" class="memory-btn relative w-full flex items-center p-3 space-x-4 rounded-full hover:bg-gray-700"><span class="text-sm font-bold w-6 text-center flex-shrink-0">VO</span><span class="sidebar-text">Voice Off</span><span class="memory-count hidden ml-auto"></span></button></li>
            </ul>
        </div>
        <!-- Bottom section -->
        <div class="mt-auto">
             <div class="border-t border-gray-700 my-2"></div>
             <ul class="space-y-2">
                  <li><button data-type="trash" title="Bộ nhớ Rác" class="memory-btn relative w-full flex items-center p-3 space-x-4 rounded-full hover:bg-gray-700"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg><span class="sidebar-text">Thùng rác</span><span class="memory-count hidden ml-auto"></span></button></li>
                  <li><button id="api-key-btn" title="Cài đặt" class="w-full flex items-center p-3 space-x-4 rounded-full hover:bg-gray-700"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 flex-shrink-0" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M11.49 3.17c-.38-1.56-2.6-1.56-2.98 0a1.532 1.532 0 01-2.286.948c-1.372-.836-2.942.734-1.57 1.996A1.532 1.532 0 013.17 8.51c-1.56.38-1.56 2.6 0 2.98a1.532 1.532 0 01.948 2.286c-.836 1.372.734 2.942 1.996 1.57A1.532 1.532 0 018.51 16.83c.38 1.56 2.6 1.56 2.98 0a1.532 1.532 0 012.286-.948c1.372.836 2.942-.734-1.57-1.996A1.532 1.532 0 0116.83 11.49c1.56-.38-1.56-2.6 0-2.98a1.532 1.532 0 01-.948-2.286c.836-1.372-.734-2.942-1.996-1.57A1.532 1.532 0 0111.49 3.17zM10 13a3 3 0 100-6 3 3 0 000 6z" clip-rule="evenodd" /></svg><span class="sidebar-text">Cài đặt</span></button></li>
             </ul>
        </div>
    </aside>

    <div class="flex-grow flex flex-col overflow-hidden">
        <header class="text-center py-4 flex-shrink-0">
            <h1 class="text-3xl font-bold tracking-wider uppercase text-white">SCRIPT TO SECTION (S2SE)</h1>
        </header>
        
        <nav class="bg-gray-800 border-y border-gray-700 py-2 flex-shrink-0">
            <div class="flex justify-center items-center space-x-4">
                <a href="https://anproduction2025.github.io/ancontents" class="p-3 rounded-full hover:bg-gray-700 transition-colors" title="P2S (Project to Script)">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" /></svg>
                </a>
                <a href="https://anproduction2025.github.io/ancontents/S2Se" class="p-3 rounded-full bg-gray-700 transition-colors" title="S2Se (Script to Section)">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10" /></svg>
                </a>
                <a href="https://anproduction2025.github.io/ancontents/Prompts-Studio/" class="p-3 rounded-full hover:bg-gray-700 transition-colors" title="Prompt Studio">
                     <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z" /></svg>
                </a>
                <a href="/ancontents/text-to-voice/" class="p-3 rounded-full hover:bg-gray-700 transition-colors" title="Tạo Voice (TTS)">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M15.536 8.464a5 5 0 010 7.072m2.828-9.9a9 9 0 010 12.728M5.586 15H4a1 1 0 01-1-1v-4a1 1 0 011-1h1.586l4.707-4.707C10.923 3.663 12 4.109 12 5v14c0 .891-1.077 1.337-1.707.707L5.586 15z" /></svg>
                </a>
                <a href="/ancontents/thu-vien/" class="p-3 rounded-full hover:bg-gray-700 transition-colors" title="Thư viện Prompts">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" viewBox="0 0 20 20" fill="currentColor"><path d="M9 4.804A7.968 7.968 0 005.5 4c-1.255 0-2.443.29-3.5.804v10A7.969 7.969 0 005.5 16c1.255 0 2.443-.29 3.5-.804V4.804zM14.5 4c-1.255 0-2.443.29-3.5.804v10A7.969 7.969 0 0014.5 16c1.255 0 2.443-.29 3.5.804v-10A7.968 7.968 0 0014.5 4z" /></svg>
                </a>
            </div>
        </nav>
        
        <div id="taskbar" class="h-12 bg-gray-800 border-b border-gray-700 flex items-center justify-center px-4 z-30 flex-shrink-0">
            <div id="taskbar-apps" class="flex items-center space-x-2">
                 <!-- Minimized windows will appear here -->
            </div>
        </div>
        
        <main class="flex-grow p-8 flex space-x-8 overflow-x-auto relative">
            <div class="w-1/3 flex-shrink-0 bg-gray-800 p-6 rounded-lg flex flex-col space-y-6">
                <div class="flex-grow flex flex-col min-h-0">
                    <div class="flex-shrink-0 mb-4">
                        <h2 class="text-xl font-bold mb-2">Kịch bản gốc</h2>
                        <label for="s2se-input-script" class="block text-sm font-medium text-blue-400">Hoặc chọn từ Bộ nhớ Scripts (S)</label>
                        <select id="s2se-input-script" class="mt-1 block w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-purple-500"></select>
                    </div>
                    <textarea id="source-script-content" class="block w-full h-full bg-gray-900 border border-gray-700 rounded-md p-3" placeholder="Dán kịch bản gốc vào đây..."></textarea>
                </div>
                <div class="flex-shrink-0">
                    <h2 class="text-xl font-bold mb-6">Tùy chọn</h2>
                    <form id="s2se-form" class="space-y-4">
                        <div>
                            <label for="section-count" class="block text-sm font-medium text-gray-300">Số lượng Section mong muốn</label>
                            <input type="number" id="section-count" placeholder="Ví dụ: 8" class="mt-1 block w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-purple-500">
                        </div>
                        <div>
                            <label for="s2se-input-se" class="block text-sm font-medium text-yellow-400">Đầu vào Se (Tùy chọn)</label>
                            <select id="s2se-input-se" class="mt-1 block w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-purple-500"></select>
                        </div>
                        <div class="flex items-center justify-between pt-2">
                            <label for="detail-toggle" class="text-sm font-medium text-gray-300">Làm chi tiết Sections</label>
                            <label class="relative inline-flex items-center cursor-pointer">
                                <input type="checkbox" id="detail-toggle" class="sr-only peer">
                                <div class="w-11 h-6 bg-gray-600 rounded-full peer peer-focus:ring-2 peer-focus:ring-green-400 peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-0.5 after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-green-500"></div>
                            </label>
                        </div>

                        <!-- Consistent Descriptions -->
                        <div class="border-t border-gray-700 pt-4 space-y-4">
                             <div>
                                <label class="block text-sm font-medium text-gray-300 mb-2">Mô tả đồng nhất</label>
                                <div class="flex items-center space-x-2">
                                    <select id="s2se-character-select" class="block w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-purple-500"></select>
                                    <label class="relative inline-flex items-center cursor-pointer">
                                        <input type="checkbox" id="character-toggle" class="sr-only peer">
                                        <div class="w-11 h-6 bg-gray-600 rounded-full peer peer-focus:ring-2 peer-focus:ring-green-400 peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-0.5 after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-green-500"></div>
                                    </label>
                                </div>
                             </div>
                             <div>
                                <div class="flex items-center space-x-2">
                                    <select id="s2se-scene-select" class="block w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-purple-500"></select>
                                    <label class="relative inline-flex items-center cursor-pointer">
                                        <input type="checkbox" id="scene-toggle" class="sr-only peer">
                                        <div class="w-11 h-6 bg-gray-600 rounded-full peer peer-focus:ring-2 peer-focus:ring-green-400 peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-0.5 after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-green-500"></div>
                                    </label>
                                </div>
                             </div>
                             <div>
                                 <label for="s2se-camera-description" class="block text-sm font-medium text-gray-300">Mô tả góc máy (Tùy chọn)</label>
                                 <textarea id="s2se-camera-description" rows="2" class="mt-1 block w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-purple-500"></textarea>
                             </div>
                        </div>

                        <div class="flex justify-end space-x-4 pt-4">
                            <button type="submit" id="generate-sections-btn" class="bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-4 rounded-md min-w-[100px] flex justify-center items-center">
                                <span class="btn-text">Tạo Sections</span><span class="loader hidden ml-2"></span>
                            </button>
                        </div>
                    </form>
                </div>
            </div>
            <div id="sections-result-container" class="flex-1 bg-gray-800 rounded-lg flex flex-col min-h-0 hidden p-6">
                <div class="flex justify-between items-center mb-4 flex-shrink-0">
                    <div class="flex items-center space-x-4">
                        <h2 class="text-xl font-bold">Các Section được tạo</h2>
                        <button id="save-all-sections-btn" title="Lưu tất cả vào bộ nhớ Se" class="bg-green-600 hover:bg-green-700 text-white font-bold py-1 px-3 rounded-md text-sm hidden">Lưu tất cả</button>
                    </div>
                    <button id="close-results-btn" title="Đóng" class="text-gray-400 hover:text-white">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" /></svg>
                    </button>
                </div>
                <div id="sections-list" class="flex-grow flex flex-col space-y-4 overflow-y-auto pr-2"></div>
            </div>
        </main>
    </div>
    
    <!-- Modals -->
    <div id="memory-modal-container" class="modal-overlay hidden fixed inset-0 bg-black bg-opacity-70 backdrop-blur-sm flex items-center justify-center z-50 p-4"><div class="bg-gray-800 p-6 rounded-lg relative w-full max-w-[95vw] h-[95vh] flex flex-col shadow-2xl"><button class="close-modal-btn absolute top-4 right-4 text-gray-400 hover:text-white"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" /></svg></button><h2 id="memory-modal-title" class="text-2xl font-bold mb-6 flex-shrink-0">Bộ nhớ</h2><div class="flex space-x-6 flex-grow overflow-hidden"><div id="memory-list-column" class="w-1/4 border-r border-gray-700 pr-6 flex flex-col"><div class="flex-shrink-0 flex justify-between items-center mb-4"><h3 class="font-bold text-lg">Danh sách</h3><div class="flex items-center space-x-2"><button type="button" id="delete-all-memory-btn" title="Xóa tất cả" class="hidden bg-red-600 hover:bg-red-700 text-white font-bold p-2 rounded-full transition duration-300"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg></button><button type="button" id="delete-all-trash-btn" title="Xóa tất cả trong rác" class="hidden bg-red-600 hover:bg-red-700 text-white font-bold p-2 rounded-full transition duration-300"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg></button><button id="memory-new-item-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold p-2 rounded-full transition duration-300"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9 13h6m-3-3v6m5 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" /></svg></button></div></div><div id="memory-modal-list" class="space-y-2 overflow-y-auto flex-grow"></div></div><div id="memory-editor-panel" class="w-3/4 hidden flex flex-col"><form id="memory-modal-form" class="space-y-4 flex flex-col flex-grow"><input type="hidden" id="memory-modal-id"><div class="flex-shrink-0"><label for="memory-modal-title-input" class="block text-sm font-medium text-gray-300">Tiêu đề</label><input type="text" id="memory-modal-title-input" placeholder="Nhập tiêu đề..." required class="mt-1 block w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500"></div><div class="flex-grow flex flex-col min-h-0"><div class="flex justify-between items-center flex-shrink-0"><label for="memory-modal-content-input" class="block text-sm font-medium text-gray-300">Nội dung</label><span id="memory-word-count" class="text-xs text-gray-400">0 từ</span></div><textarea id="memory-modal-content-input" placeholder="Dán hoặc nhập nội dung..." required class="mt-1 block w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 flex-grow"></textarea></div><div class="flex justify-end space-x-3 pt-2 flex-shrink-0"><button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-md">Lưu</button></div></form></div></div></div></div>
    <div id="api-key-container" class="modal-overlay hidden fixed inset-0 bg-black bg-opacity-70 backdrop-blur-sm flex items-center justify-center z-50 p-4"><div class="bg-gray-800 p-6 rounded-lg max-w-lg w-full relative shadow-2xl"><button class="close-modal-btn absolute top-4 right-4 text-gray-400 hover:text-white"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" /></svg></button><h2 class="text-2xl font-bold mb-6">Cài đặt</h2><form id="api-key-form" class="space-y-4"><div><label for="api-key-input" class="block text-sm font-medium text-gray-300">API Key của bạn <a href="https://aistudio.google.com/api-keys" target="_blank" class="text-blue-400 hover:underline text-xs ml-2">(Lấy API Key tại đây)</a></label><div class="relative mt-1"><input type="password" id="api-key-input" placeholder="Dán API Key của bạn vào đây..." class="block w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-yellow-500 pr-10"><button type="button" id="toggle-api-key-visibility" class="absolute inset-y-0 right-0 px-3 flex items-center text-gray-400 hover:text-white"></button></div></div><div><label for="ai-model-select" class="block text-sm font-medium text-gray-300">Model AI mặc định</label><select id="ai-model-select" class="mt-1 block w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-yellow-500"><option value="gemini-2.5-flash-preview-05-20">Gemini 2.5 Flash</option><option value="gemini-1.5-flash-latest">Gemini 1.5 Flash (Mới nhất)</option><option value="gemini-1.5-pro-latest">Gemini 1.5 Pro (Mới nhất)</option><option value="gemini-1.0-pro">Gemini 1.0 Pro</option></select></div><div class="flex justify-end space-x-4 pt-4"><button type="submit" class="bg-yellow-600 hover:bg-yellow-700 text-gray-900 font-bold py-2 px-4 rounded-md">Lưu Cài đặt</button></div></form></div></div>
    <div id="delete-confirm-modal" class="modal-overlay hidden fixed inset-0 bg-black bg-opacity-70 backdrop-blur-sm flex items-center justify-center z-[60] p-4"><div class="bg-gray-700 rounded-lg shadow-xl p-8 w-full max-w-md"><h2 class="text-xl font-bold mb-4">Xác nhận xóa</h2><p id="delete-confirm-message" class="text-gray-300 mb-6">Bạn có chắc chắn muốn xóa mục này không?</p><div class="flex justify-end space-x-4"><button type="button" id="cancel-delete-btn" class="bg-gray-600 hover:bg-gray-500 text-white font-bold py-2 px-4 rounded-md">Hủy</button><button type="button" id="confirm-delete-btn" class="bg-red-600 hover:bg-red-500 text-white font-bold py-2 px-4 rounded-md">Xóa</button></div></div></div>
    <div id="toast-container" class="fixed top-5 left-5 z-[100] space-y-2"></div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const memoryConfig = {
                script: { title: 'Đầu vào Dự án', storageKey: 'input_scripts' },
                prompt: { title: 'Đầu vào Se', storageKey: 'input_prompts' },
                voiceOver: { title: 'Đầu vào VO', storageKey: 'input_voiceOvers' },
                mainScripts: { title: 'Bộ nhớ Scripts', storageKey: 'memory_mainScripts' },
                sections: { title: 'Bộ nhớ Sections', storageKey: 'memory_sections' },
                scenes: { title: 'Bộ nhớ Bối cảnh', storageKey: 'memory_scenes' },
                characters: { title: 'Bộ nhớ Nhân vật', storageKey: 'memory_characters' },
                mainPrompts: { title: 'Bộ nhớ Prompts', storageKey: 'memory_mainPrompts' },
                mainVoiceOvers: { title: 'Bộ nhớ Voice Off', storageKey: 'memory_mainVoiceOvers' },
                trash: { title: 'Bộ nhớ Rác', storageKey: 'memory_trash' }
            };

            const state = {
                script: JSON.parse(localStorage.getItem(memoryConfig.script.storageKey)) || [],
                prompt: JSON.parse(localStorage.getItem(memoryConfig.prompt.storageKey)) || [],
                voiceOver: JSON.parse(localStorage.getItem(memoryConfig.voiceOver.storageKey)) || [],
                mainScripts: JSON.parse(localStorage.getItem(memoryConfig.mainScripts.storageKey)) || [],
                sections: JSON.parse(localStorage.getItem(memoryConfig.sections.storageKey)) || [],
                scenes: JSON.parse(localStorage.getItem(memoryConfig.scenes.storageKey)) || [],
                characters: JSON.parse(localStorage.getItem(memoryConfig.characters.storageKey)) || [],
                mainPrompts: JSON.parse(localStorage.getItem(memoryConfig.mainPrompts.storageKey)) || [],
                mainVoiceOvers: JSON.parse(localStorage.getItem(memoryConfig.mainVoiceOvers.storageKey)) || [],
                trash: JSON.parse(localStorage.getItem(memoryConfig.trash.storageKey)) || [],
                settings: {
                    apiKey: localStorage.getItem('apiKey') || '',
                    aiModel: localStorage.getItem('aiModel') || 'gemini-2.5-flash-preview-05-20'
                },
                itemToDelete: null,
                currentMemoryType: null,
            };
            window.ANP_STATE = state;

            // --- UI Elements ---
            const sourceScriptContent = document.getElementById('source-script-content');
            const sectionsResultContainer = document.getElementById('sections-result-container');
            const sectionsList = document.getElementById('sections-list');
            const s2seForm = document.getElementById('s2se-form');
            const closeResultsBtn = document.getElementById('close-results-btn');
            const saveAllSectionsBtn = document.getElementById('save-all-sections-btn');
            const detailToggle = document.getElementById('detail-toggle');
            const s2seInputScript = document.getElementById('s2se-input-script');
            const s2seInputSe = document.getElementById('s2se-input-se');
            const characterSelect = document.getElementById('s2se-character-select');
            const sceneSelect = document.getElementById('s2se-scene-select');
            const cameraDescription = document.getElementById('s2se-camera-description');

            // --- Modal Elements ---
            const memoryModalContainer = document.getElementById('memory-modal-container');
            const memoryModalTitle = document.getElementById('memory-modal-title');
            const memoryModalList = document.getElementById('memory-modal-list');
            const memoryEditorPanel = document.getElementById('memory-editor-panel');
            const memoryModalForm = document.getElementById('memory-modal-form');
            const memoryModalIdInput = document.getElementById('memory-modal-id');
            const memoryModalTitleInput = document.getElementById('memory-modal-title-input');
            const memoryModalContentInput = document.getElementById('memory-modal-content-input');
            const memoryNewItemBtn = document.getElementById('memory-new-item-btn');
            const apiKeyContainer = document.getElementById('api-key-container');
            const apiKeyForm = document.getElementById('api-key-form');
            const apiKeyInput = document.getElementById('api-key-input');
            const toggleApiKeyVisibilityBtn = document.getElementById('toggle-api-key-visibility');
            const aiModelSelect = document.getElementById('ai-model-select');
            const deleteConfirmModal = document.getElementById('delete-confirm-modal');
            const deleteConfirmMessage = document.getElementById('delete-confirm-message');
            const confirmDeleteBtn = document.getElementById('confirm-delete-btn');
            const deleteAllMemoryBtn = document.getElementById('delete-all-memory-btn');
            const deleteAllTrashBtn = document.getElementById('delete-all-trash-btn');
            
            // --- Web Worker Setup for Background Processing ---
            const workerScript = `
                self.onmessage = async (e) => {
                    const { prompt, apiKey, aiModel } = e.data;
                    try {
                        const response = await fetch('https://generativelanguage.googleapis.com/v1beta/models/' + aiModel + ':generateContent?key=' + apiKey, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                contents: [{ parts: [{ text: prompt }] }],
                                generationConfig: { responseMimeType: "application/json" }
                            })
                        });

                        if (!response.ok) {
                            const errorData = await response.json();
                            throw new Error(errorData.error?.message || 'Lỗi HTTP: ' + response.status);
                        }

                        const result = await response.json();
                        const text = result.candidates?.[0]?.content?.parts?.[0]?.text;
                        if (!text) {
                            throw new Error("Không nhận được phản hồi hợp lệ từ AI.");
                        }

                        const jsonMatch = text.match(/{[\\s\\S]*}/);
                        if (!jsonMatch) {
                            throw new Error("Phản hồi từ AI không chứa đối tượng JSON hợp lệ.");
                        }

                        self.postMessage({ success: true, data: jsonMatch[0] });

                    } catch (error) {
                        self.postMessage({ success: false, error: error.message });
                    }
                };
            `;
            const blob = new Blob([workerScript], { type: 'application/javascript' });
            const workerUrl = URL.createObjectURL(blob);
            
            // --- Helper Functions ---
            function showToast(message, type = 'info') {
                const colors = { success: 'bg-green-600', error: 'bg-red-600', info: 'bg-blue-600' };
                const toast = document.createElement('div');
                toast.className = 'text-white py-2 px-4 rounded-lg shadow-lg transform transition-all duration-300 -translate-x-full ' + colors[type];
                toast.textContent = message;
                document.getElementById('toast-container').appendChild(toast);
                setTimeout(() => toast.classList.remove('-translate-x-full'), 10);
                setTimeout(() => {
                    toast.classList.add('-translate-x-full');
                    toast.addEventListener('transitionend', () => toast.remove());
                }, 3000);
            }

            function setButtonLoading(button, isLoading) {
                if (!button) return;
                const btnText = button.querySelector('.btn-text');
                const loader = button.querySelector('.loader');
                button.disabled = isLoading;
                if(btnText) btnText.style.display = isLoading ? 'none' : 'inline-block';
                if(loader) loader.classList.toggle('hidden', !isLoading);
            }
            
            function formatScriptContent(content) {
                if (typeof content === 'string') {
                    return content;
                }
                if (Array.isArray(content)) {
                    return content.map(item => {
                        if (typeof item !== 'object' || item === null) {
                            return String(item);
                        }
                        return Object.entries(item).map(([key, value]) => {
                            const formattedKey = key.charAt(0).toUpperCase() + key.slice(1).replace(/_/g, ' ');
                            if (typeof value === 'object' && value !== null && !Array.isArray(value)) {
                                const nestedLines = Object.entries(value)
                                    .map(([nestedKey, nestedValue]) => \`    - \${nestedKey}: \${nestedValue}\`)
                                    .join('\n');
                                return \`\${formattedKey}:\n\${nestedLines}\`;
                            }
                            return \`\${formattedKey}: \${String(value)}\`;
                        }).join('\n');
                    }).join('\n\n---\n\n');
                }
                if (typeof content === 'object' && content !== null) {
                    return Object.entries(content).map(([key, value]) => {
                         const formattedKey = key.charAt(0).toUpperCase() + key.slice(1).replace(/_/g, ' ');
                         return \`\${formattedKey}: \${String(value)}\`;
                    }).join('\n');
                }
                return String(content);
            }

            function generateAiContent(prompt, submitButton) {
                setButtonLoading(submitButton, true);
                if (!state.settings.apiKey) {
                    setButtonLoading(submitButton, false);
                    return Promise.reject(new Error('Vui lòng nhập API Key trong Cài đặt.'));
                }

                return new Promise((resolve, reject) => {
                    const worker = new Worker(workerUrl);

                    worker.onmessage = (e) => {
                        if (e.data.success) {
                            resolve(e.data.data);
                        } else {
                            reject(new Error(e.data.error));
                        }
                        setButtonLoading(submitButton, false);
                        worker.terminate();
                    };

                    worker.onerror = (e) => {
                        reject(new Error(\`Lỗi Web Worker: \${e.message}\`));
                        setButtonLoading(submitButton, false);
                        worker.terminate();
                    };

                    worker.postMessage({
                        prompt: prompt,
                        apiKey: state.settings.apiKey,
                        aiModel: state.settings.aiModel
                    });
                });
            }

            // --- Memory Management ---
            function saveDataToStorage(type) {
                const key = memoryConfig[type]?.storageKey;
                if (key) localStorage.setItem(key, JSON.stringify(state[type]));
                updateMemoryCounters();
            }

            function updateMemoryCounters() {
                Object.keys(memoryConfig).forEach(type => {
                    const button = document.querySelector(\`.memory-btn[data-type="\${type}"]\`);
                    if (button) {
                        const countEl = button.querySelector('.memory-count');
                        if (countEl) {
                            const count = state[type]?.length || 0;
                            if (count > 0) {
                                countEl.textContent = count;
                                countEl.classList.remove('hidden');
                            } else {
                                countEl.classList.add('hidden');
                            }
                        }
                    }
                });
            }

            function renderMemoryList() {
                const type = state.currentMemoryType;
                const data = state[type] || [];
                memoryModalList.innerHTML = '';
                [...data].sort((a, b) => b.id - a.id).forEach(item => {
                    const div = document.createElement('div');
                    div.className = \`w-full text-left p-3 rounded-md transition-colors script-item cursor-pointer hover:bg-gray-700\`;
                    div.dataset.id = item.id;
                    div.innerHTML = \`<div class="flex-grow overflow-hidden pr-2"><span class="truncate pointer-events-none">\${item.title}</span></div><button class="delete-btn text-gray-400 hover:text-red-500 p-1 rounded-full flex-shrink-0" data-id="\${item.id}"><svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 pointer-events-none" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm4 0a1 1 0 012 0v6a1 1 0 11-2 0V8z" clip-rule="evenodd" /></svg></button>\`;
                    memoryModalList.appendChild(div);
                });
            }

            function openMemoryModal(type) {
                state.currentMemoryType = type;
                const config = memoryConfig[type];
                if (!config) return;
                memoryModalTitle.textContent = config.title;
                memoryModalContainer.classList.remove('hidden');
                memoryEditorPanel.classList.add('hidden');
                const isTrash = type === 'trash';
                memoryNewItemBtn.classList.toggle('hidden', isTrash);
                deleteAllTrashBtn.classList.toggle('hidden', !isTrash);
                deleteAllMemoryBtn.classList.toggle('hidden', isTrash);
                memoryModalForm.reset();
                renderMemoryList();
            }

            function loadItemIntoMemoryForm(id) {
                const type = state.currentMemoryType;
                const item = state[type]?.find(i => i.id == id);
                if (item) {
                    memoryModalIdInput.value = item.id;
                    memoryModalTitleInput.value = item.title;
                    memoryModalContentInput.value = item.content;
                    memoryEditorPanel.classList.remove('hidden');
                }
            }
            
            function populateAllInputDropdowns() {
                const populate = (select, data, placeholder) => {
                    if (!select) return;
                    select.innerHTML = \`<option value="">\${placeholder}</option>\`;
                    [...data].sort((a, b) => b.id - a.id).forEach(item => {
                        select.innerHTML += \`<option value="\${item.id}">\${item.title}</option>\`;
                    });
                };
                populate(s2seInputScript, state.mainScripts, 'Chọn từ Bộ nhớ Scripts...');
                populate(s2seInputSe, state.prompt, 'Chọn từ Đầu vào Se...');
                populate(characterSelect, state.characters, 'Chọn Nhân vật...');
                populate(sceneSelect, state.scenes, 'Chọn Bối cảnh...');
            }

            // --- S2SE Functions ---
            function renderSections(sectionsArray) {
                sectionsList.innerHTML = '';
                if (!Array.isArray(sectionsArray) || sectionsArray.length === 0) {
                    sectionsList.innerHTML = \`<p class="text-gray-400">Không có section nào được tạo.</p>\`;
                    saveAllSectionsBtn.classList.add('hidden');
                    return;
                }
                saveAllSectionsBtn.classList.remove('hidden');
                sectionsArray.forEach((sectionObj, index) => {
                    const sectionEl = document.createElement('div');
                    sectionEl.className = 'bg-gray-900 rounded-lg p-4 border border-gray-700';

                    const sectionTextVi = formatScriptContent(sectionObj.vi || 'N/A');
                    const sectionTextEn = formatScriptContent(sectionObj.en || 'N/A');
                    const encodedSectionTextVi = sectionTextVi.replace(/"/g, '&quot;');

                    sectionEl.innerHTML = \`
                        <div class="flex justify-between items-center mb-2">
                            <h3 class="font-bold text-teal-400">SECTION \${index + 1}</h3>
                            <div class="flex space-x-2">
                                <a href="https://anproduction2025.github.io/ancontents/Prompts-Studio/" data-section-content="\${encodedSectionTextVi}" class="to-prompt-studio-btn bg-teal-600 hover:bg-teal-500 text-white font-bold py-1 px-2 rounded-md text-xs">Sang Prompt Studio</a>
                            </div>
                        </div>
                        <div class="space-y-3">
                            <div>
                                <div class="flex justify-between items-center mb-1">
                                    <label class="text-xs font-semibold text-gray-400">TIẾNG VIỆT</label>
                                    <button data-content="\${encodedSectionTextVi}" class="copy-section-btn bg-gray-600 hover:bg-gray-500 text-white font-bold p-1 rounded-md text-xs">Copy</button>
                                </div>
                                <textarea readonly class="w-full h-28 bg-gray-800 border border-gray-600 rounded-md p-2 text-sm">\${sectionTextVi}</textarea>
                            </div>
                            <div>
                                <div class="flex justify-between items-center mb-1">
                                    <label class="text-xs font-semibold text-gray-400">TIẾNG ANH</label>
                                    <button data-content="\${sectionTextEn.replace(/"/g, '&quot;')}" class="copy-section-btn bg-gray-600 hover:bg-gray-500 text-white font-bold p-1 rounded-md text-xs">Copy</button>
                                </div>
                                <textarea readonly class="w-full h-28 bg-gray-800 border border-gray-600 rounded-md p-2 text-sm">\${sectionTextEn}</textarea>
                            </div>
                        </div>\`;
                    sectionsList.appendChild(sectionEl);
                });
            }
            

            // --- Event Listeners ---
            document.body.addEventListener('click', e => {
                const memoryBtn = e.target.closest('.memory-btn');
                if (memoryBtn) openMemoryModal(memoryBtn.dataset.type);
                if (e.target.closest('.close-modal-btn')) e.target.closest('.modal-overlay').classList.add('hidden');
            });

            document.getElementById('api-key-btn').addEventListener('click', () => {
                const eyeIconSVG = \`<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M10 12a2 2 0 100-4 2 2 0 000 4z" /><path fill-rule="evenodd" d="M.458 10C3.732 4.943 7.523 3 10 3s6.268 1.943 9.542 7c-3.274 5.057-7.523 7-9.542 7S3.732 15.057.458 10zM14 10a4 4 0 11-8 0 4 4 0 018 0z" clip-rule="evenodd" /></svg>\`;
                apiKeyInput.value = state.settings.apiKey;
                aiModelSelect.value = state.settings.aiModel;
                apiKeyInput.type = 'password';
                toggleApiKeyVisibilityBtn.innerHTML = eyeIconSVG;
                apiKeyContainer.classList.remove('hidden');
            });

            apiKeyForm.addEventListener('submit', (e) => {
                e.preventDefault();
                state.settings.apiKey = apiKeyInput.value.trim();
                state.settings.aiModel = aiModelSelect.value;
                localStorage.setItem('apiKey', state.settings.apiKey);
                localStorage.setItem('aiModel', state.settings.aiModel);
                showToast('Đã lưu Cài đặt!', 'success');
                apiKeyContainer.classList.add('hidden');
            });
            
            toggleApiKeyVisibilityBtn.addEventListener('click', () => {
                const isPassword = apiKeyInput.type === 'password';
                apiKeyInput.type = isPassword ? 'text' : 'password';
                toggleApiKeyVisibilityBtn.innerHTML = isPassword ? \`<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M3.707 2.293a1 1 0 00-1.414 1.414l14 14a1 1 0 001.414-1.414l-1.473-1.473A10.014 10.014 0 0019.542 10C18.268 8.517 16.635 7.412 14.722 6.708l-1.414-1.414A10.009 10.009 0 0010 3C7.523 3 5.268 4.943 2.458 10a11.97 11.97 0 003.876 3.655l-2.227-2.228a1 1 0 00-1.414-1.414L.293 8.293a1 1 0 000 1.414l2 2a1 1 0 001.414 0l1.293-1.293A8.003 8.003 0 0110 7a8 8 0 012.828.532l1.432-1.432A9.98 9.98 0 0010 5c-2.477 0-4.732 1.943-7.542 7 .57 1.1 1.254 2.063 2.07 2.912l-1.42-1.42a1 1 0 00-1.414-1.414L.293 15.707a1 1 0 001.414 1.414l14-14a1 1 0 00-1.414-1.414L3.707 2.293z" clip-rule="evenodd" /><path d="M10.707 10.293a1 1 0 10-1.414-1.414 1 1 0 001.414 1.414z" /></svg>\` : \`<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M10 12a2 2 0 100-4 2 2 0 000 4z" /><path fill-rule="evenodd" d="M.458 10C3.732 4.943 7.523 3 10 3s6.268 1.943 9.542 7c-3.274 5.057-7.523 7-9.542 7S3.732 15.057.458 10zM14 10a4 4 0 11-8 0 4 4 0 018 0z" clip-rule="evenodd" /></svg>\`;
            });

            memoryModalList.addEventListener('click', (e) => {
                const deleteBtn = e.target.closest('.delete-btn');
                const itemDiv = e.target.closest('.script-item');
                if (deleteBtn) {
                    state.itemToDelete = { id: deleteBtn.dataset.id, type: state.currentMemoryType, isPurge: state.currentMemoryType === 'trash' };
                    deleteConfirmMessage.textContent = state.itemToDelete.isPurge ? 'Xóa vĩnh viễn mục này? Không thể hoàn tác.' : 'Chuyển mục này vào Thùng rác?';
                    deleteConfirmModal.classList.remove('hidden');
                } else if (itemDiv) {
                    loadItemIntoMemoryForm(itemDiv.dataset.id);
                }
            });
            
            memoryNewItemBtn.addEventListener('click', () => {
                memoryEditorPanel.classList.remove('hidden');
                memoryModalForm.reset();
                memoryModalIdInput.value = '';
            });
            
            memoryModalForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const type = state.currentMemoryType;
                const id = memoryModalIdInput.value;
                const title = memoryModalTitleInput.value.trim();
                const content = memoryModalContentInput.value.trim();
                if (!title || !content) return showToast('Tiêu đề và nội dung không được trống.', 'error');
                if (id) {
                    const index = state[type].findIndex(i => i.id == id);
                    if (index > -1) state[type][index] = { ...state[type][index], title, content };
                } else {
                    const newItem = { id: Date.now(), title, content };
                    state[type].push(newItem);
                }
                saveDataToStorage(type);
                renderMemoryList();
                memoryEditorPanel.classList.add('hidden');
                showToast('Đã lưu!', 'success');
            });


            confirmDeleteBtn.addEventListener('click', () => {
                if (!state.itemToDelete) return;
                const { id, type, isPurge, isDeleteAll } = state.itemToDelete;
                if (isDeleteAll) {
                    state[type] = [];
                } else if (isPurge) {
                    state[type] = state[type].filter(item => item.id != id);
                } else {
                    const itemToMove = state[type].find(item => item.id == id);
                    if (itemToMove) state.trash.push({ ...itemToMove, deletedAt: new Date().toLocaleString('vi-VN') });
                    state[type] = state[type].filter(item => item.id != id);
                    saveDataToStorage('trash');
                }
                saveDataToStorage(type);
                renderMemoryList();
                memoryEditorPanel.classList.add('hidden');
                deleteConfirmModal.classList.add('hidden');
                showToast('Đã xóa thành công.', 'success');
            });
            
            document.getElementById('cancel-delete-btn').addEventListener('click', () => deleteConfirmModal.classList.add('hidden'));

            deleteAllMemoryBtn.addEventListener('click', () => {
                 state.itemToDelete = { type: state.currentMemoryType, isDeleteAll: true };
                 deleteConfirmMessage.textContent = \`Xóa vĩnh viễn TẤT CẢ mục trong "\${memoryConfig[state.currentMemoryType].title}"?\`;
                 deleteConfirmModal.classList.remove('hidden');
            });
             deleteAllTrashBtn.addEventListener('click', () => {
                 state.itemToDelete = { type: 'trash', isDeleteAll: true, isPurge: true };
                 deleteConfirmMessage.textContent = \`Xóa vĩnh viễn TẤT CẢ mục trong thùng rác?\`;
                 deleteConfirmModal.classList.remove('hidden');
            });

            s2seForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const submitButton = document.getElementById('generate-sections-btn');
                const sourceScript = sourceScriptContent.value.trim();
                if (!sourceScript) return showToast('Không có kịch bản gốc.', 'error');
                if (!state.settings.apiKey) {
                    document.getElementById('api-key-btn').click();
                    return showToast('Vui lòng nhập API Key.', 'error');
                }
                const sectionCount = document.getElementById('section-count').value;
                const referenceSe = state.prompt.find(p => p.id == s2seInputSe.value);
                const detailInstruction = detailToggle.checked ? \`Quan trọng: Với mỗi section, hãy thêm vào các chi tiết mô tả sống động về bối cảnh, hành động, cảm xúc của nhân vật và gợi ý góc máy để làm cho phân cảnh trở nên phong phú hơn, sẵn sàng cho việc tạo prompt.\` : '';

                const selectedCharacterId = characterSelect.value;
                const characterToggle = document.getElementById('character-toggle').checked;
                const selectedSceneId = sceneSelect.value;
                const sceneToggle = document.getElementById('scene-toggle').checked;
                const cameraDesc = cameraDescription.value.trim();

                let characterInstruction = '';
                if (characterToggle && selectedCharacterId) {
                    const character = state.characters.find(c => c.id == selectedCharacterId);
                    if (character) {
                        characterInstruction = \`QUAN TRỌNG VỀ NHÂN VẬT: Khi mô tả nhân vật "\${character.title}", bạn PHẢI sử dụng chính xác 100% mô tả sau: "\${character.content}".\\n\`;
                    }
                }

                let sceneInstruction = '';
                if (sceneToggle && selectedSceneId) {
                    const scene = state.scenes.find(s => s.id == selectedSceneId);
                    if (scene) {
                        sceneInstruction = \`QUAN TRỌNG VỀ BỐI CẢNH: Khi mô tả bối cảnh "\${scene.title}", bạn PHẢI sử dụng chính xác 100% mô tả sau: "\${scene.content}".\\n\`;
                    }
                }

                let cameraInstruction = '';
                if (cameraDesc) {
                    cameraInstruction = \`HƯỚNG DẪN GÓC MÁY: \${cameraDesc}\\n\`;
                }
                
                const prompt = \`Bạn là biên tập viên kịch bản song ngữ. Chia nhỏ kịch bản sau thành các phân cảnh (sections). Với mỗi section, cung cấp cả bản tiếng Việt và tiếng Anh. Định dạng đầu ra: một đối tượng JSON có khóa "sections", giá trị là một mảng các đối tượng, mỗi đối tượng có khóa "vi" và "en".\\n\\nKịch bản: ---\\n\${sourceScript}\\n---\\n\${sectionCount ? \`Số lượng section mong muốn: \${sectionCount}\`: ''}\\n\${referenceSe ? \`Hướng dẫn thêm: \${referenceSe.content}\`: ''}\\n\${detailInstruction}\\n\${characterInstruction}\\n\${sceneInstruction}\\n\${cameraInstruction}\`;

                localStorage.setItem('s2se_task_running', 'true');
                localStorage.setItem('s2se_task_prompt', prompt);

                sectionsResultContainer.classList.remove('hidden');
                sectionsList.innerHTML = \`<div class="flex justify-center items-center h-full"><div class="loader"></div></div>\`;
                
                generateAiContent(prompt, submitButton)
                    .then(generatedContent => {
                        const result = JSON.parse(generatedContent);
                        renderSections(result.sections || []);
                        localStorage.setItem('s2se_last_result', JSON.stringify(result.sections || []));
                    })
                    .catch(error => {
                        showToast(\`Lỗi: \${error.message}\`, 'error');
                        sectionsList.innerHTML = \`<p class="text-red-400">Lỗi: \${error.message}</p>\`;
                    })
                    .finally(() => {
                        localStorage.removeItem('s2se_task_running');
                        localStorage.removeItem('s2se_task_prompt');
                    });
            });

            s2seInputScript.addEventListener('change', (e) => {
                 const selectedId = e.target.value;
                 if(selectedId) {
                     const selectedScript = state.mainScripts.find(s => s.id == selectedId);
                     if(selectedScript) sourceScriptContent.value = formatScriptContent(selectedScript.content);
                 }
            });

            closeResultsBtn.addEventListener('click', () => sectionsResultContainer.classList.add('hidden'));

            saveAllSectionsBtn.addEventListener('click', () => {
                const lastResult = JSON.parse(localStorage.getItem('s2se_last_result')) || [];
                if (lastResult.length === 0) return showToast('Không có gì để lưu.', 'info');
                lastResult.forEach((section, index) => {
                    const newItem = {
                        id: Date.now() + index,
                        title: \`Section \${index + 1} - Từ kịch bản\`,
                        content: formatScriptContent(section.vi || '')
                    };
                    state.sections.push(newItem);
                });
                saveDataToStorage('sections');
                showToast(\`Đã lưu \${lastResult.length} sections vào bộ nhớ Se!\`, 'success');
            });
            
            sectionsList.addEventListener('click', e => {
                const copyBtn = e.target.closest('.copy-section-btn');
                const promptBtn = e.target.closest('.to-prompt-studio-btn');
                if (copyBtn) {
                    navigator.clipboard.writeText(copyBtn.dataset.content).then(() => showToast('Đã sao chép!', 'success'));
                }
                if (promptBtn) {
                    e.preventDefault();
                    localStorage.setItem('promptStudioInput', promptBtn.dataset.sectionContent);
                    window.location.href = promptBtn.href;
                }
            });

            function initialLoad() {
                updateMemoryCounters();
                populateAllInputDropdowns();
                const scriptToProcess = localStorage.getItem('scriptToProcess');
                if (scriptToProcess) {
                    sourceScriptContent.value = scriptToProcess;
                    localStorage.removeItem('scriptToProcess');
                }

                if (localStorage.getItem('s2se_task_running') === 'true') {
                    const savedPrompt = localStorage.getItem('s2se_task_prompt');
                    if (savedPrompt) {
                        showToast('Phát hiện tác vụ dang dở, đang tiếp tục...', 'info');
                        const submitButton = document.getElementById('generate-sections-btn');
                        sectionsResultContainer.classList.remove('hidden');
                        sectionsList.innerHTML = \`<div class="flex justify-center items-center h-full"><div class="loader"></div></div>\`;
                        
                        setTimeout(() => {
                            generateAiContent(savedPrompt, submitButton)
                                .then(generatedContent => {
                                    const result = JSON.parse(generatedContent);
                                    renderSections(result.sections || []);
                                    localStorage.setItem('s2se_last_result', JSON.stringify(result.sections || []));
                                })
                                .catch(error => {
                                    showToast(\`Lỗi khi tiếp tục tác vụ: \${error.message}\`, 'error');
                                    sectionsList.innerHTML = \`<p class="text-red-400">Lỗi: \${error.message}</p>\`;
                                })
                                .finally(() => {
                                    localStorage.removeItem('s2se_task_running');
                                    localStorage.removeItem('s2se_task_prompt');
                                });
                        }, 100);
                    } else {
                         localStorage.removeItem('s2se_task_running');
                    }
                }
            }
            initialLoad();
        });
    </script>
</body>
</html>

