<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>S2Se - Tạo phân đoạn chi tiết</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { 
            font-family: 'Inter', sans-serif; 
        }
        .hidden {
            display: none;
        }
        /* Loading spinner */
        .loader {
            border: 2px solid #f3f3f3;
            border-top: 2px solid #4a90e2;
            border-radius: 50%;
            width: 16px;
            height: 16px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        /* Custom scrollbar for better aesthetics */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #111827; }
        ::-webkit-scrollbar-thumb { background: #4b5563; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #6b7280; }
    </style>
</head>
<body class="bg-gray-900 text-white h-screen flex flex-col p-8">
    
    <header class="flex justify-between items-center mb-6 flex-shrink-0">
        <h1 class="text-3xl font-bold">S2Se - Tạo phân đoạn chi tiết</h1>
        <a href="../" title="Quay lại Story Broad" class="bg-gray-700 hover:bg-gray-600 text-white font-bold p-3 rounded-full transition duration-300">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
              <path stroke-linecap="round" stroke-linejoin="round" d="M11 15l-3-3m0 0l3-3m-3 3h8M3 12a9 9 0 1118 0 9 9 0 01-18 0z" />
            </svg>
        </a>
    </header>

    <main class="flex-grow flex space-x-8 overflow-hidden">
        <!-- Input Column -->
        <div class="w-1/2 flex-shrink-0 bg-gray-800 p-6 rounded-lg flex flex-col">
            <h2 class="text-2xl font-bold mb-6">Nhập liệu</h2>
            <form id="segment-form" class="space-y-4 flex-grow flex flex-col">
                 <div class="flex-grow flex flex-col">
                    <label for="segment-input-script" class="block text-sm font-medium text-yellow-400">Đầu vào Dự án</label>
                    <textarea id="segment-input-script" rows="8" class="mt-1 block w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-yellow-500 flex-grow" placeholder="Nội dung kịch bản từ bước trước..."></textarea>
                </div>
                
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label for="segment-input-se" class="block text-sm font-medium text-yellow-400">Đầu vào Se</label>
                        <select id="segment-input-se" class="mt-1 block w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-yellow-500">
                            <!-- Options will be dynamically populated -->
                        </select>
                    </div>
                     <div>
                        <label for="segment-input-vo" class="block text-sm font-medium text-yellow-400">Đầu vào VO</label>
                        <select id="segment-input-vo" class="mt-1 block w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-yellow-500">
                            <!-- Options will be dynamically populated -->
                        </select>
                    </div>
                    <div>
                        <label for="segment-output-type" class="block text-sm font-medium text-gray-300">Loại đầu ra</label>
                        <select id="segment-output-type" class="mt-1 block w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-yellow-500">
                            <option value="all">Mô tả & Prompts chi tiết</option>
                            <option value="description">Chỉ mô tả chi tiết</option>
                            <option value="prompts">Chỉ Prompts cho AI Image</option>
                        </select>
                    </div>
                    <div>
                        <label for="segment-style" class="block text-sm font-medium text-gray-300">Phong cách</label>
                        <select id="segment-style" class="mt-1 block w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-yellow-500">
                            <option value="">AI tự sáng tạo</option>
                            <option>Tả thực (Photorealistic)</option>
                            <option>Điện ảnh (Cinematic)</option>
                            <option>Tranh sơn dầu (Oil Painting)</option>
                            <option>Hoạt hình 3D (3D Animation)</option>
                            <option>Anime</option>
                        </select>
                    </div>
                    <div>
                        <label for="segment-camera-angle" class="block text-sm font-medium text-gray-300">Góc máy</label>
                         <select id="segment-camera-angle" class="mt-1 block w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-yellow-500">
                            <option value="">AI tự chọn</option>
                            <option>Toàn cảnh (Wide shot)</option>
                            <option>Trung cảnh (Medium shot)</option>
                            <option>Cận cảnh (Close-up shot)</option>
                            <option>Góc máy từ trên xuống (High-angle shot)</option>
                            <option>Góc máy từ dưới lên (Low-angle shot)</option>
                        </select>
                    </div>
                     <div>
                        <label for="segment-setting" class="block text-sm font-medium text-gray-300">Bối cảnh</label>
                        <select id="segment-setting" class="mt-1 block w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-yellow-500">
                            <option value="">Không xác định</option>
                            <option>Trong nhà (Interior)</option>
                            <option>Ngoài trời - Thành phố (Exterior - City)</option>
                            <option>Ngoài trời - Thiên nhiên (Exterior - Nature)</option>
                            <option>Không gian vũ trụ (Outer Space)</option>
                            <option>Kỳ ảo (Fantasy)</option>
                        </select>
                    </div>
                </div>

                <div class="flex justify-end space-x-4 pt-4">
                    <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-md min-w-[80px] flex justify-center items-center">
                        <span class="btn-text">Tạo</span>
                        <span class="loader hidden ml-2"></span>
                    </button>
                </div>
            </form>
        </div>
        
        <!-- Result Column -->
        <div id="segment-result-container" class="w-1/2 flex-grow bg-gray-800 p-6 rounded-lg flex flex-col">
            <h2 class="text-2xl font-bold mb-4">Kết quả Phân đoạn</h2>
            <div class="space-y-4 flex-grow flex flex-col">
                <div class="flex-grow flex flex-col">
                    <div class="flex justify-between items-center">
                        <label for="segment-result-content" class="block text-sm font-medium text-gray-300">Nội dung chi tiết</label>
                        <span id="segment-word-count" class="text-xs text-gray-400">0 từ</span>
                    </div>
                    <textarea id="segment-result-content" readonly class="mt-1 block w-full px-3 py-2 bg-gray-900 border border-gray-700 rounded-md flex-grow"></textarea>
                    <div class="flex justify-end space-x-2 pt-2">
                         <button type="button" data-target="segment-result-content" class="copy-btn bg-green-600 hover:bg-green-700 text-white font-bold py-1 px-3 text-sm rounded-md">Copy</button>
                         <button type="button" data-target="segment-result-content" data-title="segment_detail" class="export-btn bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-1 px-3 text-sm rounded-md">Xuất</button>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- UI Elements ---
            const segmentForm = document.getElementById('segment-form');
            const segmentInputScript = document.getElementById('segment-input-script');
            const segmentInputSe = document.getElementById('segment-input-se');
            const segmentInputVo = document.getElementById('segment-input-vo');
            const segmentResultContent = document.getElementById('segment-result-content');
            const segmentWordCount = document.getElementById('segment-word-count');

            // --- Data Store ---
            let inputPrompts = JSON.parse(localStorage.getItem('inputPrompts')) || [];
            let inputVoiceOvers = JSON.parse(localStorage.getItem('inputVoiceOvers')) || [];
            let apiKey = localStorage.getItem('apiKey') || 'YOUR_API_KEY'; // Replace with a way to get the key

            // --- Functions ---
            function populateDropdown(selectElement, data, placeholderText) {
                if (!selectElement) return;
                selectElement.innerHTML = '';
                const placeholderOption = document.createElement('option');
                placeholderOption.textContent = placeholderText;
                placeholderOption.value = '';
                selectElement.appendChild(placeholderOption);

                data.forEach(item => {
                    const option = document.createElement('option');
                    option.value = item.id;
                    option.textContent = item.title;
                    selectElement.appendChild(option.cloneNode(true));
                });
            }

            function updateWordCount(textArea, countElement) {
                if (!textArea || !countElement) return;
                const text = textArea.value.trim();
                const wordCount = text === '' ? 0 : text.split(/\s+/).filter(Boolean).length;
                countElement.textContent = `${wordCount} từ`;
            }

            async function generateAiContent(prompt, submitButton) {
                 const btnText = submitButton.querySelector('.btn-text');
                 const loader = submitButton.querySelector('.loader');

                 btnText.textContent = 'Đang tạo...';
                 loader.classList.remove('hidden');
                 submitButton.disabled = true;

                try {
                    // This is a placeholder for your actual API call
                    // You would replace this with a fetch call to the Gemini API
                    console.log("Sending to AI:", prompt);
                    // Mock response for testing
                    await new Promise(resolve => setTimeout(resolve, 1500)); 
                    return `Đây là kết quả chi tiết được tạo bởi AI dựa trên yêu cầu của bạn. \n\nPrompt chi tiết:\n\n1. (Chi tiết prompt 1)\n2. (Chi tiết prompt 2)`;
                } finally {
                    btnText.textContent = 'Tạo';
                    loader.classList.add('hidden');
                    submitButton.disabled = false;
                }
            }
            
            // --- Initial Load ---
            const scriptToProcess = localStorage.getItem('scriptToProcess');
            if (scriptToProcess) {
                segmentInputScript.value = scriptToProcess;
                localStorage.removeItem('scriptToProcess'); // Clear after use
            }
            populateDropdown(segmentInputSe, inputPrompts, 'Chọn từ Đầu vào Se...');
            populateDropdown(segmentInputVo, inputVoiceOvers, 'Chọn từ Đầu vào VO...');

            // --- Event Listeners ---
            segmentResultContent.addEventListener('input', () => updateWordCount(segmentResultContent, segmentWordCount));
            document.body.addEventListener('click', e => {
                 const button = e.target.closest('button');
                if (!button) return;

                if (button.classList.contains('copy-btn')) {
                    const targetId = button.dataset.target;
                    const contentToCopy = document.getElementById(targetId).value;
                    if(!contentToCopy) { alert('Không có nội dung để sao chép.'); return; }
                    navigator.clipboard.writeText(contentToCopy).then(() => alert('Đã sao chép vào clipboard!')).catch(err => alert('Sao chép thất bại!'));
                }
                
                if (button.classList.contains('export-btn')) {
                    const targetId = button.dataset.target;
                    const title = button.dataset.title || 'untitled';
                    const content = document.getElementById(targetId).value;
                    if (!content) { alert('Không có nội dung để xuất file.'); return; }
                    downloadAsTxt(title, content);
                }
            });

            segmentForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                
                const submitButton = e.target.querySelector('button[type="submit"]');
                const inputScript = segmentInputScript.value;
                const selectedSeId = segmentInputSe.value;
                const selectedVoId = segmentInputVo.value;
                const outputType = document.getElementById('segment-output-type').value;
                const style = document.getElementById('segment-style').value;
                const cameraAngle = document.getElementById('segment-camera-angle').value;
                const setting = document.getElementById('segment-setting').value;
        
                if (!inputScript.trim()) {
                    alert('Vui lòng nhập thông tin kịch bản đầu vào.');
                    return;
                }
                
                const referenceSe = inputPrompts.find(p => p.id == selectedSeId);
                const referenceSeContent = referenceSe ? referenceSe.content : "Không có";
                
                const referenceVo = inputVoiceOvers.find(v => v.id == selectedVoId);
                const referenceVoContent = referenceVo ? referenceVo.content : "Không có";

                let finalPrompt = `Bạn là một đạo diễn hình ảnh và chuyên gia viết prompt. Dựa trên kịch bản và các yêu cầu dưới đây, hãy tạo ra nội dung chi tiết.
                
                **Kịch bản gốc:**
                ---
                ${inputScript}
                ---

                **Đầu vào bổ sung:**
                 - Đầu vào Se (tham khảo hình ảnh): ${referenceSeContent}
                 - Đầu vào VO (tham khảo lời thoại): ${referenceVoContent}

                **Yêu cầu:**
                - **Loại đầu ra:** ${outputType}
                - **Phong cách:** ${style || 'Tự do sáng tạo'}
                - **Góc máy:** ${cameraAngle || 'Tự do sáng tạo'}
                - **Bối cảnh:** ${setting || 'Tự do sáng tạo'}
                
                Hãy viết một cách chi tiết và gợi hình. Nếu yêu cầu tạo prompt, hãy tạo các prompt phức tạp, giàu chi tiết phù hợp cho các mô hình AI tạo ảnh như Midjourney, Stable Diffusion.`;

                try {
                    segmentResultContent.value = "Đang xử lý...";
                    const result = await generateAiContent(finalPrompt, submitButton);
                    segmentResultContent.value = result;
                    updateWordCount(segmentResultContent, segmentWordCount);
                } catch (error) {
                    segmentResultContent.value = `Lỗi: ${error.message}`;
                    console.error('Lỗi khi tạo phân đoạn:', error);
                }
            });
        });
    </script>
</body>
</html>
