<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AN PRODUCTION AI FILMS - STORY BROAD</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { 
            font-family: 'Inter', sans-serif; 
        }
        .hidden {
            display: none;
        }
        .script-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .script-item.active {
            background-color: #3b82f6;
        }
        .delete-btn { /* More generic delete button class */
            visibility: hidden;
            opacity: 0;
            transition: opacity 0.2s;
        }
        .script-item:hover .delete-btn {
            visibility: visible;
            opacity: 1;
        }
        /* Loading spinner */
        .loader {
            border: 2px solid #f3f3f3;
            border-top: 2px solid #4a90e2;
            border-radius: 50%;
            width: 16px;
            height: 16px;
            animation: spin 1s linear infinite;
        }
        .sub-loader {
             border: 2px solid #f3f3f3;
            border-top: 2px solid #fca5a5;
            border-radius: 50%;
            width: 16px;
            height: 16px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        /* Custom scrollbar for better aesthetics */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #111827; }
        ::-webkit-scrollbar-thumb { background: #4b5563; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #6b7280; }
    </style>
</head>
<body class="bg-gray-900 text-white h-screen flex flex-col">
    <!-- Nút điều khiển ở góc trên bên phải -->
    <div class="fixed top-8 right-8 z-20 flex flex-col space-y-2">
        <button id="api-key-btn" title="Cài đặt" class="bg-gray-700 hover:bg-gray-600 text-white font-bold p-2 rounded-full transition duration-300 flex items-center">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" viewBox="0 0 20 20" fill="currentColor">
              <path fill-rule="evenodd" d="M11.49 3.17c-.38-1.56-2.6-1.56-2.98 0a1.532 1.532 0 01-2.286.948c-1.372-.836-2.942.734-1.57 1.996A1.532 1.532 0 013.17 8.51c-1.56.38-1.56 2.6 0 2.98a1.532 1.532 0 01.948 2.286c-.836 1.372.734 2.942 1.996 1.57A1.532 1.532 0 018.51 16.83c.38 1.56 2.6 1.56 2.98 0a1.532 1.532 0 012.286-.948c1.372.836 2.942-.734 1.57-1.996A1.532 1.532 0 0116.83 11.49c1.56-.38 1.56-2.6 0-2.98a1.532 1.532 0 01-.948-2.286c.836-1.372-.734-2.942-1.996-1.57A1.532 1.532 0 0111.49 3.17zM10 13a3 3 0 100-6 3 3 0 000 6z" clip-rule="evenodd" />
            </svg>
        </button>
        <a href="./thu-vien/" title="Thư viện PROMPTS" class="bg-gray-700 hover:bg-gray-600 text-white font-bold p-2 rounded-full transition duration-300 flex items-center">
             <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" viewBox="0 0 20 20" fill="currentColor">
               <path d="M9 4.804A7.968 7.968 0 005.5 4c-1.255 0-2.443.29-3.5.804v10A7.969 7.969 0 005.5 16c1.255 0 2.443-.29 3.5-.804V4.804zM14.5 4c-1.255 0-2.443.29-3.5.804v10A7.969 7.969 0 0014.5 16c1.255 0 2.443-.29 3.5.804v-10A7.968 7.968 0 0014.5 4z" />
            </svg>
        </a>
    </div>

    <header class="text-center py-6 flex-shrink-0">
        <h1 class="text-4xl font-bold tracking-wider uppercase text-white">AN PRODUCTION AI FILMS - STORY BROAD</h1>
    </header>
    
    <div class="flex space-x-8 flex-grow p-8 overflow-hidden">
        <!-- Left Sidebar with Buttons -->
        <aside id="sidebar" class="w-64 flex-shrink-0">
            <div class="flex flex-col space-y-4">
                <div class="flex flex-col space-y-2 items-start">
                    <div class="flex space-x-2">
                        <button id="script-memory-btn" title="Đầu vào kịch bản" class="bg-yellow-600 hover:bg-yellow-700 text-gray-900 font-bold p-3 rounded-full transition duration-300">
                             <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                              <path stroke-linecap="round" stroke-linejoin="round" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z" />
                            </svg>
                        </button>
                        <button id="prompt-memory-btn" title="Yêu cầu đầu vào Prompt" class="bg-yellow-600 hover:bg-yellow-700 text-gray-900 font-bold p-3 rounded-full transition duration-300 flex items-center justify-center w-12 h-12">
                            <span class="text-lg font-bold">P</span>
                        </button>
                        <button id="voice-over-memory-btn" title="Yêu cầu đầu vào Voice Off" class="bg-yellow-600 hover:bg-yellow-700 text-gray-900 font-bold p-3 rounded-full transition duration-300 flex items-center justify-center w-12 h-12">
                            <span class="text-sm font-bold">VO</span>
                        </button>
                        <a href="./text-to-voice/" title="Tạo Voice (TTS)" class="bg-gray-700 hover:bg-gray-600 text-white font-bold p-3 rounded-full transition duration-300">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                              <path stroke-linecap="round" stroke-linejoin="round" d="M15.536 8.464a5 5 0 010 7.072m2.828-9.9a9 9 0 010 12.728M5.586 15H4a1 1 0 01-1-1v-4a1 1 0 011-1h1.586l4.707-4.707C10.923 3.663 12 4.109 12 5v14c0 .891-1.077 1.337-1.707.707L5.586 15z" />
                            </svg>
                        </a>
                        <a href="./image-generator/" title="Tạo Ảnh AI" class="bg-gray-700 hover:bg-gray-600 text-white font-bold p-3 rounded-full transition duration-300">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                              <path stroke-linecap="round" stroke-linejoin="round" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z" />
                              <path stroke-linecap="round" stroke-linejoin="round" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z" />
                            </svg>
                        </a>
                    </div>
                    <button id="segment-memory-btn" title="Bộ nhớ phân đoạn" class="bg-gray-700 hover:bg-gray-600 text-white font-bold p-3 rounded-full transition duration-300">
                         <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                          <path stroke-linecap="round" stroke-linejoin="round" d="M4 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2V6zM14 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V6zM4 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2v-2zM14 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z" />
                        </svg>
                    </button>
                </div>
                <div class="border-t border-gray-600"></div>
                <button id="create-script-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-8 rounded-lg transition duration-300 text-lg w-full text-left">
                    Tạo kịch bản
                </button>
                <button id="create-segment-btn" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-3 px-8 rounded-lg transition duration-300 text-lg w-full text-left">
                    Tạo phân đoạn
                </button>
                <button id="create-prompts-btn" class="bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-8 rounded-lg transition duration-300 text-lg w-full text-left">
                    Tạo PROMPTS
                </button>
            </div>
        </aside>

        <!-- Main Content Area -->
        <main id="main-workspace" class="flex-grow flex space-x-8 overflow-x-auto">
            <!-- Script Creation Column -->
            <div id="script-form-container" class="hidden w-[450px] flex-shrink-0 bg-gray-800 p-6 rounded-lg">
                <h2 class="text-2xl font-bold mb-6">Tạo kịch bản mới</h2>
                <form id="script-form" class="space-y-4">
                    <div>
                        <label for="script-idea" class="block text-sm font-medium text-gray-300">Ý tưởng kịch bản / Tóm tắt (Tùy chọn)</label>
                        <textarea id="script-idea" rows="5" class="mt-1 block w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-blue-500"></textarea>
                    </div>
                    
                    <div class="space-y-4">
                        <div>
                            <label for="script-input-prompt" class="block text-sm font-medium text-gray-300">Yêu cầu Prompt</label>
                            <select id="script-input-prompt" class="mt-1 block w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-blue-500">
                                <!-- Options will be dynamically populated -->
                            </select>
                        </div>
                        <div>
                            <label for="script-input-voice" class="block text-sm font-medium text-gray-300">Yêu cầu Voice</label>
                            <select id="script-input-voice" class="mt-1 block w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-blue-500">
                                <!-- Options will be dynamically populated -->
                            </select>
                        </div>
                        <div>
                            <label for="script-input-script" class="block text-sm font-medium text-gray-300">Yêu cầu đầu vào kịch bản</label>
                            <select id="script-input-script" class="mt-1 block w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-blue-500">
                                <!-- Options will be dynamically populated -->
                            </select>
                        </div>
                        <div>
                            <label for="script-style" class="block text-sm font-medium text-gray-300">Phong cách</label>
                            <select id="script-style" required class="mt-1 block w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-blue-500">
                                <option value="" disabled selected>Chọn phong cách</option>
                                <option>Mặc định</option>
                                <option>Storytelling</option>
                                <option>Hài hước</option>
                                <option>Chính kịch</option>
                                <option>Hành động</option>
                                <option>Kinh dị</option>
                            </select>
                        </div>
                        <div>
                            <label for="script-duration" class="block text-sm font-medium text-gray-300">Thời lượng</label>
                             <select id="script-duration" required class="mt-1 block w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-blue-500">
                                <option value="1">1 phút</option>
                                <option value="10">10 phút</option>
                                <option value="60">60 phút</option>
                                <option value="custom">Tùy chỉnh...</option>
                            </select>
                            <input type="number" id="script-duration-custom" placeholder="Nhập số phút" class="hidden mt-2 block w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-md">
                        </div>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-300">Tùy chọn bổ sung</label>
                        <div class="mt-2 space-y-2">
                            <div class="flex items-center">
                                <input id="option-prompt-video" name="additional-options" type="checkbox" class="h-4 w-4 rounded border-gray-500 bg-gray-600 text-blue-600 focus:ring-blue-500">
                                <label for="option-prompt-video" class="ml-3 block text-sm text-gray-300">TỔNG HỢP PROMPT VIDEO</label>
                            </div>
                            <div class="flex items-center">
                                <input id="option-voice-script" name="additional-options" type="checkbox" class="h-4 w-4 rounded border-gray-500 bg-gray-600 text-blue-600 focus:ring-blue-500">
                                <label for="option-voice-script" class="ml-3 block text-sm text-gray-300">TỔNG HỢP THOẠI (VOICE SCRIPT)</label>
                            </div>
                            <div class="flex items-center">
                                <input id="option-description" name="additional-options" type="checkbox" class="h-4 w-4 rounded border-gray-500 bg-gray-600 text-blue-600 focus:ring-blue-500">
                                <label for="option-description" class="ml-3 block text-sm text-gray-300">Tạo mô tả Youtube, Tiktok</label>
                            </div>
                        </div>
                    </div>

                    <div class="flex justify-end space-x-4 pt-4">
                        <button type="button" class="cancel-btn bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-md">Đóng</button>
                        <button type="submit" id="generate-script-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-md min-w-[80px] flex justify-center items-center">
                            <span class="btn-text">Tạo</span>
                            <span class="loader hidden ml-2"></span>
                        </button>
                    </div>
                </form>
            </div>
            
             <!-- Script Result Column -->
            <div id="script-result-container" class="hidden flex-grow bg-gray-800 p-6 rounded-lg max-w-2xl flex-shrink-0 flex flex-col">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-2xl font-bold">Kịch bản được tạo bởi AI</h2>
                    <button type="button" id="save-result-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-md">Lưu vào bộ nhớ</button>
                </div>
                <div class="space-y-4 flex-grow flex flex-col">
                     <div>
                        <label for="script-result-title" class="block text-sm font-medium text-gray-300">Tiêu đề</label>
                        <input type="text" id="script-result-title" required class="mt-1 block w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-md">
                    </div>
                    <div class="flex-grow flex flex-col">
                        <label for="script-result-prompt-content" class="block text-sm font-medium text-gray-300">Phần Prompt / Mô tả hình ảnh</label>
                        <textarea id="script-result-prompt-content" class="mt-1 block w-full px-3 py-2 bg-gray-900 border border-gray-700 rounded-md flex-grow"></textarea>
                        <div class="flex justify-end space-x-2 pt-2">
                             <button type="button" data-target="script-result-prompt-content" class="copy-btn bg-green-600 hover:bg-green-700 text-white font-bold py-1 px-3 text-sm rounded-md">Copy</button>
                             <button type="button" data-target="script-result-prompt-content" data-title="prompt_part" class="export-btn bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-1 px-3 text-sm rounded-md">Xuất</button>
                        </div>
                    </div>
                     <div class="flex-grow flex flex-col">
                        <label for="script-result-voice-content" class="block text-sm font-medium text-gray-300">Phần Thoại / Voice Off</label>
                        <textarea id="script-result-voice-content" class="mt-1 block w-full px-3 py-2 bg-gray-900 border border-gray-700 rounded-md flex-grow"></textarea>
                         <div class="flex justify-end space-x-2 pt-2">
                             <button type="button" data-target="script-result-voice-content" class="copy-btn bg-green-600 hover:bg-green-700 text-white font-bold py-1 px-3 text-sm rounded-md">Copy</button>
                             <button type="button" data-target="script-result-voice-content" data-title="voice_part" class="export-btn bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-1 px-3 text-sm rounded-md">Xuất</button>
                        </div>
                    </div>
                </div>
            </div>

             <!-- Additional Results Column -->
            <div id="additional-results-container" class="hidden flex-grow bg-gray-800 p-6 rounded-lg flex flex-col space-y-6 overflow-y-auto">
                <h2 class="text-2xl font-bold mb-0 text-yellow-400">Kết quả bổ sung</h2>
                
                <!-- Prompt Video Result -->
                <div id="prompt-video-result-wrapper" class="hidden">
                    <div class="flex items-center mb-2">
                        <h3 class="text-lg font-semibold">PROMPTS Video</h3>
                        <div class="sub-loader ml-3 hidden"></div>
                    </div>
                    <textarea id="prompt-video-result-content" rows="6" class="mt-1 block w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-md"></textarea>
                    <div class="flex justify-end space-x-3 pt-2">
                        <button type="button" data-target="prompt-video-result-content" class="copy-btn bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-3 text-sm rounded-md">Copy</button>
                        <button type="button" data-target="prompt-video-result-content" data-title="prompts_video" class="export-btn bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-3 text-sm rounded-md">Xuất TXT</button>
                    </div>
                </div>

                <!-- Voice Script Result -->
                <div id="voice-script-result-wrapper" class="hidden">
                    <div class="flex items-center mb-2">
                        <h3 class="text-lg font-semibold">Kịch bản thoại (Voice Script)</h3>
                        <div class="sub-loader ml-3 hidden"></div>
                    </div>
                    <textarea id="voice-script-result-content" rows="6" class="mt-1 block w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-md"></textarea>
                    <div class="flex justify-end space-x-3 pt-2">
                        <button type="button" data-target="voice-script-result-content" class="copy-btn bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-3 text-sm rounded-md">Copy</button>
                        <button type="button" data-target="voice-script-result-content" data-title="voice_script" class="export-btn bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-3 text-sm rounded-md">Xuất TXT</button>
                    </div>
                </div>

                <!-- Description Result -->
                <div id="description-result-wrapper" class="hidden">
                    <div class="flex items-center mb-2">
                        <h3 class="text-lg font-semibold">Mô tả Youtube, Tiktok</h3>
                        <div class="sub-loader ml-3 hidden"></div>
                    </div>
                    <textarea id="description-result-content" rows="6" class="mt-1 block w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-md"></textarea>
                    <div class="flex justify-end space-x-3 pt-2">
                        <button type="button" data-target="description-result-content" class="copy-btn bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-3 text-sm rounded-md">Copy</button>
                        <button type="button" data-target="description-result-content" data-title="description" class="export-btn bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-3 text-sm rounded-md">Xuất TXT</button>
                    </div>
                </div>
            </div>
        </main>
    </div>
    
    <!-- Script Memory Modal -->
    <div id="script-memory-container" class="hidden fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50 p-4">
        <div class="bg-gray-800 p-6 rounded-lg relative w-full max-w-6xl h-[90vh] flex flex-col">
            <button class="close-modal-btn absolute top-4 right-4 text-gray-400 hover:text-white">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
                </svg>
            </button>
            <h2 class="text-2xl font-bold mb-6 flex-shrink-0">Đầu vào kịch bản</h2>
            <div class="flex space-x-6 flex-grow overflow-hidden">
                <!-- List -->
                <div class="w-1/3 border-r border-gray-700 pr-6 flex flex-col">
                    <div class="flex-shrink-0 flex justify-between items-center mb-4">
                        <h3 class="font-bold text-lg">Danh sách</h3>
                        <button data-type="script" class="new-item-btn bg-blue-600 hover:bg-blue-700 text-white font-bold p-2 rounded-full transition duration-300">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M9 13h6m-3-3v6m5 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                                </svg>
                        </button>
                    </div>
                    <div id="script-list" class="space-y-2 overflow-y-auto flex-grow"></div>
                </div>
                <!-- Editor -->
                <div id="script-editor-panel" class="w-2/3 hidden flex-col">
                    <form id="script-memory-form" class="space-y-4 flex flex-col flex-grow">
                        <input type="hidden" id="script-memory-id">
                        <div>
                            <label for="script-memory-title" class="block text-sm font-medium text-gray-300">Tiêu đề</label>
                            <input type="text" id="script-memory-title" placeholder="Nhập tiêu đề..." required class="mt-1 block w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500">
                        </div>
                        <div class="flex-grow flex flex-col">
                            <label for="script-memory-input" class="block text-sm font-medium text-gray-300">Nội dung</label>
                            <textarea id="script-memory-input" placeholder="Dán hoặc nhập nội dung..." required class="mt-1 block w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 flex-grow"></textarea>
                        </div>
                        <div class="flex justify-end space-x-3 pt-2">
                            <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-md">Lưu</button>
                            <button type="button" id="copy-script-memory-btn" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-md">Copy</button>
                            <button type="button" id="export-script-memory-btn" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-md">Xuất TXT</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Prompt Memory Modal -->
    <div id="prompt-memory-container" class="hidden fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50 p-4">
        <div class="bg-gray-800 p-6 rounded-lg relative w-full max-w-6xl h-[90vh] flex flex-col">
            <button class="close-modal-btn absolute top-4 right-4 text-gray-400 hover:text-white">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" /></svg>
            </button>
            <h2 class="text-2xl font-bold mb-6 flex-shrink-0">Yêu cầu đầu vào Prompt</h2>
            <div class="flex space-x-6 flex-grow overflow-hidden">
                <!-- List -->
                <div class="w-1/3 border-r border-gray-700 pr-6 flex flex-col">
                    <div class="flex-shrink-0 flex justify-between items-center mb-4">
                        <h3 class="font-bold text-lg">Danh sách</h3>
                        <button data-type="prompt" class="new-item-btn bg-blue-600 hover:bg-blue-700 text-white font-bold p-2 rounded-full transition duration-300">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9 13h6m-3-3v6m5 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" /></svg>
                        </button>
                    </div>
                    <div id="prompt-list" class="space-y-2 overflow-y-auto flex-grow"></div>
                </div>
                <!-- Editor -->
                <div id="prompt-editor-panel" class="w-2/3 hidden flex-col">
                    <form id="prompt-memory-form" class="space-y-4 flex flex-col flex-grow">
                        <input type="hidden" id="prompt-memory-id">
                        <div>
                            <label for="prompt-memory-title" class="block text-sm font-medium text-gray-300">Tiêu đề</label>
                            <input type="text" id="prompt-memory-title" placeholder="Nhập tiêu đề..." required class="mt-1 block w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-md">
                        </div>
                        <div class="flex-grow flex flex-col">
                            <label for="prompt-memory-input" class="block text-sm font-medium text-gray-300">Nội dung</label>
                            <textarea id="prompt-memory-input" placeholder="Dán hoặc nhập nội dung..." required class="mt-1 block w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-md flex-grow"></textarea>
                        </div>
                        <div class="flex justify-end space-x-3 pt-2">
                            <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-md">Lưu</button>
                            <button type="button" id="copy-prompt-memory-btn" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-md">Copy</button>
                            <button type="button" id="export-prompt-memory-btn" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-md">Xuất TXT</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Voice Over Memory Modal -->
    <div id="voice-over-memory-container" class="hidden fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50 p-4">
        <div class="bg-gray-800 p-6 rounded-lg relative w-full max-w-6xl h-[90vh] flex flex-col">
            <button class="close-modal-btn absolute top-4 right-4 text-gray-400 hover:text-white">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" /></svg>
            </button>
            <h2 class="text-2xl font-bold mb-6 flex-shrink-0">Yêu cầu đầu vào Voice Off</h2>
            <div class="flex space-x-6 flex-grow overflow-hidden">
                <!-- List -->
                <div class="w-1/3 border-r border-gray-700 pr-6 flex flex-col">
                    <div class="flex-shrink-0 flex justify-between items-center mb-4">
                        <h3 class="font-bold text-lg">Danh sách</h3>
                        <button data-type="voiceOver" class="new-item-btn bg-blue-600 hover:bg-blue-700 text-white font-bold p-2 rounded-full transition duration-300">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9 13h6m-3-3v6m5 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" /></svg>
                        </button>
                    </div>
                    <div id="voice-over-list" class="space-y-2 overflow-y-auto flex-grow"></div>
                </div>
                <!-- Editor -->
                <div id="voice-over-editor-panel" class="w-2/3 hidden flex-col">
                    <form id="voice-over-memory-form" class="space-y-4 flex flex-col flex-grow">
                        <input type="hidden" id="voice-over-memory-id">
                        <div>
                            <label for="voice-over-memory-title" class="block text-sm font-medium text-gray-300">Tiêu đề</label>
                            <input type="text" id="voice-over-memory-title" placeholder="Nhập tiêu đề..." required class="mt-1 block w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-md">
                        </div>
                        <div class="flex-grow flex flex-col">
                            <label for="voice-over-memory-input" class="block text-sm font-medium text-gray-300">Nội dung</label>
                            <textarea id="voice-over-memory-input" placeholder="Dán hoặc nhập nội dung..." required class="mt-1 block w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-md flex-grow"></textarea>
                        </div>
                        <div class="flex justify-end space-x-3 pt-2">
                            <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-md">Lưu</button>
                            <button type="button" id="copy-voice-over-memory-btn" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-md">Copy</button>
                            <button type="button" id="export-voice-over-memory-btn" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-md">Xuất TXT</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>


    <!-- API Key Modal -->
    <div id="api-key-container" class="hidden fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50 p-4">
         <div class="bg-gray-800 p-6 rounded-lg max-w-lg w-full relative">
             <button class="close-modal-btn absolute top-4 right-4 text-gray-400 hover:text-white">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
                </svg>
            </button>
            <h2 class="text-2xl font-bold mb-6">Cài đặt</h2>
            <form id="api-key-form" class="space-y-4">
                <div>
                    <label for="api-key-input" class="block text-sm font-medium text-gray-300">
                        API Key của bạn
                         <a href="https://aistudio.google.com/api-keys" target="_blank" class="text-blue-400 hover:underline text-xs ml-2">(Lấy API Key tại đây)</a>
                    </label>
                    <div class="relative mt-1">
                        <input type="password" id="api-key-input" placeholder="Dán API Key của bạn vào đây..." class="block w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-yellow-500 pr-10">
                        <button type="button" id="toggle-api-key-visibility" class="absolute inset-y-0 right-0 px-3 flex items-center text-gray-400 hover:text-white">
                            <!-- Eye Icon SVG will be injected here -->
                        </button>
                    </div>
                </div>
                <div>
                    <label for="ai-model-select" class="block text-sm font-medium text-gray-300">Model AI mặc định</label>
                    <select id="ai-model-select" class="mt-1 block w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-yellow-500">
                        <option value="gemini-2.5-flash-image-preview">gemini-2.5-flash-image-preview</option>
                        <option value="gpt-4">GPT-4</option>
                        <option value="claude-3">Claude 3</option>
                    </select>
                </div>
                 <div class="flex justify-end space-x-4 pt-4">
                    <button type="submit" class="bg-yellow-600 hover:bg-yellow-700 text-gray-900 font-bold py-2 px-4 rounded-md">Lưu Cài đặt</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Delete Confirmation Modal -->
    <div id="delete-confirm-modal" class="hidden fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50 p-4">
         <div class="bg-gray-700 rounded-lg shadow-xl p-8 w-full max-w-md">
            <h2 class="text-xl font-bold mb-4">Xác nhận xóa</h2>
            <p class="text-gray-300 mb-6">Bạn có chắc chắn muốn xóa mục này không?</p>
            <div class="flex justify-end space-x-4">
                <button type="button" id="cancel-delete-btn" class="bg-gray-600 hover:bg-gray-500 text-white font-bold py-2 px-4 rounded-md">Hủy</button>
                <button type="button" id="confirm-delete-btn" class="bg-red-600 hover:bg-red-500 text-white font-bold py-2 px-4 rounded-md">Xóa</button>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- UI Elements ---
            const createScriptBtn = document.getElementById('create-script-btn');
            const scriptFormContainer = document.getElementById('script-form-container');
            const apiKeyBtn = document.getElementById('api-key-btn');
            const apiKeyContainer = document.getElementById('api-key-container');
            
            // Memory Buttons
            const scriptMemoryBtn = document.getElementById('script-memory-btn');
            const promptMemoryBtn = document.getElementById('prompt-memory-btn');
            const voiceOverMemoryBtn = document.getElementById('voice-over-memory-btn');
            
            // Memory Modals
            const scriptMemoryContainer = document.getElementById('script-memory-container');
            const promptMemoryContainer = document.getElementById('prompt-memory-container');
            const voiceOverMemoryContainer = document.getElementById('voice-over-memory-container');
            
            // Result Containers
            const scriptResultContainer = document.getElementById('script-result-container');
            const additionalResultsContainer = document.getElementById('additional-results-container');
            const promptVideoResultWrapper = document.getElementById('prompt-video-result-wrapper');
            const voiceScriptResultWrapper = document.getElementById('voice-script-result-wrapper');
            const descriptionResultWrapper = document.getElementById('description-result-wrapper');
            
            const scriptForm = document.getElementById('script-form');
            const scriptInputPrompt = document.getElementById('script-input-prompt');
            const scriptInputVoice = document.getElementById('script-input-voice');
            const scriptInputScript = document.getElementById('script-input-script');
            const scriptIdea = document.getElementById('script-idea');
            const scriptDuration = document.getElementById('script-duration');
            const scriptDurationCustom = document.getElementById('script-duration-custom');
            
            // Script Result Elements
            const saveResultBtn = document.getElementById('save-result-btn');
            const scriptResultTitle = document.getElementById('script-result-title');
            const scriptResultPromptContent = document.getElementById('script-result-prompt-content');
            const scriptResultVoiceContent = document.getElementById('script-result-voice-content');


            // API Key Elements
            const apiKeyForm = document.getElementById('api-key-form');
            const apiKeyInput = document.getElementById('api-key-input');
            const toggleApiKeyVisibilityBtn = document.getElementById('toggle-api-key-visibility');
            const aiModelSelect = document.getElementById('ai-model-select');
            const eyeIconSVG = `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M10 12a2 2 0 100-4 2 2 0 000 4z" /><path fill-rule="evenodd" d="M.458 10C3.732 4.943 7.523 3 10 3s6.268 1.943 9.542 7c-3.274 5.057-7.523 7-9.542 7S3.732 15.057.458 10zM14 10a4 4 0 11-8 0 4 4 0 018 0z" clip-rule="evenodd" /></svg>`;
            const eyeOffIconSVG = `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M3.707 2.293a1 1 0 00-1.414 1.414l14 14a1 1 0 001.414-1.414l-1.473-1.473A10.014 10.014 0 0019.542 10C18.268 8.517 16.635 7.412 14.722 6.708l-1.414-1.414A10.009 10.009 0 0010 3C7.523 3 5.268 4.943 2.458 10a11.97 11.97 0 003.876 3.655l-2.227-2.228a1 1 0 00-1.414-1.414L.293 8.293a1 1 0 000 1.414l2 2a1 1 0 001.414 0l1.293-1.293A8.003 8.003 0 0110 7a8 8 0 012.828.532l1.432-1.432A9.98 9.98 0 0010 5c-2.477 0-4.732 1.943-7.542 7 .57 1.1 1.254 2.063 2.07 2.912l-1.42-1.42a1 1 0 00-1.414-1.414L.293 15.707a1 1 0 001.414 1.414l14-14a1 1 0 00-1.414-1.414L3.707 2.293z" clip-rule="evenodd" /><path d="M10.707 10.293a1 1 0 10-1.414-1.414 1 1 0 001.414 1.414z" /></svg>`;

            // Delete Modal
            const deleteConfirmModal = document.getElementById('delete-confirm-modal');
            const cancelDeleteBtn = document.getElementById('cancel-delete-btn');
            const confirmDeleteBtn = document.getElementById('confirm-delete-btn');
            
            // --- Data Store ---
            let scripts = JSON.parse(localStorage.getItem('scripts')) || [];
            let prompts = JSON.parse(localStorage.getItem('prompts')) || [];
            let voiceOvers = JSON.parse(localStorage.getItem('voiceOvers')) || [];
            let apiKey = localStorage.getItem('apiKey') || '';
            let aiModel = localStorage.getItem('aiModel') || 'gemini-2.5-flash-image-preview';
            let itemToDelete = null; // {id: '123', type: 'script'}

            // --- Generic Memory Modal Elements ---
            const memoryElements = {
                script: {
                    container: scriptMemoryContainer,
                    list: document.getElementById('script-list'),
                    editorPanel: document.getElementById('script-editor-panel'),
                    form: document.getElementById('script-memory-form'),
                    idInput: document.getElementById('script-memory-id'),
                    titleInput: document.getElementById('script-memory-title'),
                    contentInput: document.getElementById('script-memory-input'),
                    copyBtn: document.getElementById('copy-script-memory-btn'),
                    exportBtn: document.getElementById('export-script-memory-btn'),
                },
                prompt: {
                    container: promptMemoryContainer,
                    list: document.getElementById('prompt-list'),
                    editorPanel: document.getElementById('prompt-editor-panel'),
                    form: document.getElementById('prompt-memory-form'),
                    idInput: document.getElementById('prompt-memory-id'),
                    titleInput: document.getElementById('prompt-memory-title'),
                    contentInput: document.getElementById('prompt-memory-input'),
                    copyBtn: document.getElementById('copy-prompt-memory-btn'),
                    exportBtn: document.getElementById('export-prompt-memory-btn'),
                },
                voiceOver: {
                    container: voiceOverMemoryContainer,
                    list: document.getElementById('voice-over-list'),
                    editorPanel: document.getElementById('voice-over-editor-panel'),
                    form: document.getElementById('voice-over-memory-form'),
                    idInput: document.getElementById('voice-over-memory-id'),
                    titleInput: document.getElementById('voice-over-memory-title'),
                    contentInput: document.getElementById('voice-over-memory-input'),
                    copyBtn: document.getElementById('copy-voice-over-memory-btn'),
                    exportBtn: document.getElementById('export-voice-over-memory-btn'),
                }
            };

            // --- General Functions ---
            function hideAllContainers() {
                scriptFormContainer.classList.add('hidden');
                scriptResultContainer.classList.add('hidden');
                additionalResultsContainer.classList.add('hidden');
            }

            function hideAllModals() {
                Object.values(memoryElements).forEach(elements => elements.container.classList.add('hidden'));
                apiKeyContainer.classList.add('hidden');
            }

            // --- Generic Memory Management Functions ---
            function getDataForType(type) {
                if (type === 'script') return scripts;
                if (type === 'prompt') return prompts;
                if (type === 'voiceOver') return voiceOvers;
                return [];
            }

            function saveDataToStorage(type) {
                if (type === 'script') localStorage.setItem('scripts', JSON.stringify(scripts));
                if (type === 'prompt') localStorage.setItem('prompts', JSON.stringify(prompts));
                if (type === 'voiceOver') localStorage.setItem('voiceOvers', JSON.stringify(voiceOvers));
            }

            function renderListForType(type) {
                const elements = memoryElements[type];
                const data = getDataForType(type);
                elements.list.innerHTML = '';
                const currentId = elements.idInput.value;

                data.forEach(item => {
                    const div = document.createElement('div');
                    div.className = `w-full text-left p-3 rounded-md transition-colors script-item cursor-pointer ${item.id == currentId ? 'active' : 'hover:bg-gray-700'}`;
                    div.dataset.id = item.id;
                    div.dataset.type = type;
                    div.innerHTML = `
                        <span class="truncate pointer-events-none">${item.title}</span>
                        <button class="delete-btn text-gray-400 hover:text-red-500 p-1 rounded-full" data-id="${item.id}" data-type="${type}">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 pointer-events-none" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm4 0a1 1 0 012 0v6a1 1 0 11-2 0V8z" clip-rule="evenodd" />
                            </svg>
                        </button>
                    `;
                    elements.list.appendChild(div);
                });
            }

            function clearFormForType(type) {
                const elements = memoryElements[type];
                elements.form.reset();
                elements.idInput.value = '';
                renderListForType(type);
            }

            function loadItemIntoForm(id, type) {
                const elements = memoryElements[type];
                const data = getDataForType(type);
                const item = data.find(i => i.id == id);
                if (item) {
                    elements.idInput.value = item.id;
                    elements.titleInput.value = item.title;
                    elements.contentInput.value = item.content;
                }
                renderListForType(type);
            }

            function openDeleteModal(id, type) {
                itemToDelete = { id, type };
                deleteConfirmModal.classList.remove('hidden');
            }

            function performDelete() {
                if (!itemToDelete) return;
                const { id, type } = itemToDelete;
                
                let data = getDataForType(type);
                if(type === 'script') scripts = data.filter(item => item.id != id);
                if(type === 'prompt') prompts = data.filter(item => item.id != id);
                if(type === 'voiceOver') voiceOvers = data.filter(item => item.id != id);

                saveDataToStorage(type);

                const elements = memoryElements[type];
                if (elements.idInput.value == id) {
                    clearFormForType(type);
                } else {
                    renderListForType(type);
                }
                
                itemToDelete = null;
                deleteConfirmModal.classList.add('hidden');
            }

            function saveSettings() {
                localStorage.setItem('apiKey', apiKey);
                localStorage.setItem('aiModel', aiModel);
            }

            function renderSettingsDisplay() {
                apiKeyInput.value = apiKey;
                apiKeyInput.type = 'password';
                toggleApiKeyVisibilityBtn.innerHTML = eyeIconSVG;
                aiModelSelect.value = aiModel;
            }
            
            function downloadAsTxt(title, content) {
                const blob = new Blob([content], { type: 'text/plain;charset=utf-8' });
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                const fileName = title.toLowerCase().replace(/[^a-z0-9\s-]/g, '').replace(/\s+/g, '_').substring(0, 50) + '.txt';
                link.href = url;
                link.download = fileName;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url);
            }

            function populateDropdown(selectElement, data, placeholderText) {
                if (!selectElement) return;
                selectElement.innerHTML = '';
                const placeholderOption = document.createElement('option');
                placeholderOption.textContent = placeholderText;
                placeholderOption.value = '';
                selectElement.appendChild(placeholderOption);

                data.forEach(item => {
                    const option = document.createElement('option');
                    option.value = item.id;
                    option.textContent = item.title;
                    selectElement.appendChild(option.cloneNode(true));
                });
            }

            function populateAllInputDropdowns() {
                populateDropdown(scriptInputPrompt, prompts, 'Chọn từ Yêu cầu Prompt...');
                populateDropdown(scriptInputVoice, voiceOvers, 'Chọn từ Yêu cầu Voice...');
                populateDropdown(scriptInputScript, scripts, 'Chọn từ Đầu vào kịch bản...');
            }


            // --- Initial Setup ---
            toggleApiKeyVisibilityBtn.innerHTML = eyeIconSVG;

            // --- Event Listeners ---
            createScriptBtn.addEventListener('click', () => {
                hideAllContainers();
                hideAllModals();
                scriptForm.reset();
                populateAllInputDropdowns();
                scriptDurationCustom.classList.add('hidden');
                scriptFormContainer.classList.remove('hidden');
            });

            scriptDuration.addEventListener('change', (e) => {
                scriptDurationCustom.classList.toggle('hidden', e.target.value !== 'custom');
            });

            // Memory Buttons
            function openMemoryModal(type) {
                hideAllContainers();
                hideAllModals();
                const elements = memoryElements[type];
                elements.container.classList.remove('hidden');
                renderListForType(type);
                clearFormForType(type);
                elements.editorPanel.classList.add('hidden');
            }

            scriptMemoryBtn.addEventListener('click', () => openMemoryModal('script'));
            promptMemoryBtn.addEventListener('click', () => openMemoryModal('prompt'));
            voiceOverMemoryBtn.addEventListener('click', () => openMemoryModal('voiceOver'));
            
            apiKeyBtn.addEventListener('click', () => {
                hideAllContainers();
                hideAllModals();
                renderSettingsDisplay();
                apiKeyContainer.classList.remove('hidden');
            });
            
            document.querySelectorAll('.close-modal-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.target.closest('.fixed').classList.add('hidden');
                });
            });

            // Generic listeners for all memory modals
            Object.keys(memoryElements).forEach(type => {
                const elements = memoryElements[type];
                
                elements.list.addEventListener('click', (e) => {
                    const deleteBtn = e.target.closest('.delete-btn');
                    const itemDiv = e.target.closest('.script-item');
                    if (deleteBtn) {
                        openDeleteModal(deleteBtn.dataset.id, deleteBtn.dataset.type);
                    } else if (itemDiv) {
                        elements.editorPanel.classList.remove('hidden');
                        loadItemIntoForm(itemDiv.dataset.id, itemDiv.dataset.type);
                    }
                });

                elements.form.addEventListener('submit', (e) => {
                    e.preventDefault();
                    const id = elements.idInput.value;
                    const title = elements.titleInput.value.trim();
                    const content = elements.contentInput.value.trim();
                    if (!title || !content) {
                        alert('Tiêu đề và nội dung không được để trống.');
                        return;
                    }
                    
                    let data = getDataForType(type);
                    if (id) {
                        const index = data.findIndex(i => i.id == id);
                        if (index > -1) data[index] = { ...data[index], title, content };
                    } else {
                        const newItem = { id: Date.now(), title, content };
                        data.push(newItem);
                        elements.idInput.value = newItem.id;
                    }
                    
                    saveDataToStorage(type);
                    renderListForType(type);
                    alert('Đã lưu thành công!');
                });

                elements.copyBtn.addEventListener('click', () => {
                    const contentToCopy = elements.contentInput.value;
                    if(!contentToCopy) { alert('Không có nội dung để sao chép.'); return; }
                    navigator.clipboard.writeText(contentToCopy).then(() => alert('Đã sao chép vào clipboard!')).catch(err => alert('Sao chép thất bại!'));
                });

                elements.exportBtn.addEventListener('click', () => {
                    const title = elements.titleInput.value;
                    const content = elements.contentInput.value;
                    if (!content) { alert('Không có nội dung để xuất file.'); return; }
                    downloadAsTxt(title || `${type}_khong_tieu_de`, content);
                });
            });

            document.querySelectorAll('.new-item-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const type = e.currentTarget.dataset.type;
                    clearFormForType(type);
                    memoryElements[type].editorPanel.classList.remove('hidden');
                });
            });

            apiKeyForm.addEventListener('submit', (e) => {
                e.preventDefault();
                apiKey = apiKeyInput.value.trim();
                aiModel = aiModelSelect.value;
                saveSettings();
                renderSettingsDisplay();
                alert('Đã lưu Cài đặt thành công!');
                apiKeyContainer.classList.add('hidden');
            });

            toggleApiKeyVisibilityBtn.addEventListener('click', () => {
                if (apiKeyInput.type === 'password') {
                    apiKeyInput.type = 'text';
                    toggleApiKeyVisibilityBtn.innerHTML = eyeOffIconSVG;
                } else {
                    apiKeyInput.type = 'password';
                    toggleApiKeyVisibilityBtn.innerHTML = eyeIconSVG;
                }
            });

            // Result Container Listeners
            saveResultBtn.addEventListener('click', () => {
                const title = scriptResultTitle.value.trim();
                const promptContent = scriptResultPromptContent.value.trim();
                const voiceContent = scriptResultVoiceContent.value.trim();

                if (!title || (!promptContent && !voiceContent)) {
                    alert('Vui lòng nhập tiêu đề và có ít nhất một phần nội dung.');
                    return;
                }
                const fullContent = `### PHẦN PROMPT / MÔ TẢ HÌNH ẢNH\n\n${promptContent}\n\n### PHẦN THOẠI / VOICE OFF\n\n${voiceContent}`;
                
                const newScript = { id: Date.now(), title, content: fullContent };
                scripts.push(newScript);
                saveDataToStorage('script');
                alert('Đã lưu kịch bản vào bộ nhớ!');
                scriptResultContainer.classList.add('hidden');
                additionalResultsContainer.classList.add('hidden');
            });

            document.querySelectorAll('.copy-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const targetId = e.target.dataset.target;
                    const contentToCopy = document.getElementById(targetId).value;
                    if(!contentToCopy) { alert('Không có nội dung để sao chép.'); return; }
                    navigator.clipboard.writeText(contentToCopy).then(() => alert('Đã sao chép vào clipboard!')).catch(err => alert('Sao chép thất bại!'));
                });
            });

            document.querySelectorAll('.export-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const targetId = e.target.dataset.target;
                    const title = e.target.dataset.title || 'untitled';
                    const content = document.getElementById(targetId).value;
                    if (!content) { alert('Không có nội dung để xuất file.'); return; }
                    downloadAsTxt(title, content);
                });
            });

            cancelDeleteBtn.addEventListener('click', () => deleteConfirmModal.classList.add('hidden'));
            confirmDeleteBtn.addEventListener('click', performDelete);

            document.querySelectorAll('.cancel-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.target.closest('.bg-gray-800').classList.add('hidden');
                });
            });
            
            async function generateAiContent(prompt, submitButton) {
                 const btnText = submitButton.querySelector('.btn-text');
                 const loader = submitButton.querySelector('.loader');

                 btnText.textContent = 'Đang tạo...';
                 loader.classList.remove('hidden');
                 submitButton.disabled = true;

                try {
                    const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                    });
                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(errorData.error.message || `Lỗi HTTP: ${response.status}`);
                    }
                    const result = await response.json();
                    return result.candidates[0]?.content?.parts[0]?.text || "";
                } finally {
                    btnText.textContent = 'Tạo';
                    loader.classList.add('hidden');
                    submitButton.disabled = false;
                }
            }

            // --- Main Script Form Submission ---
            scriptForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                
                const submitButton = e.target.querySelector('button[type="submit"]');
                const selectedPromptId = scriptInputPrompt.value;
                const selectedVoiceId = scriptInputVoice.value;
                const selectedScriptId = scriptInputScript.value;
                const ideaValue = scriptIdea.value.trim();
                const styleValue = document.getElementById('script-style').value;

                if (!selectedPromptId && !selectedVoiceId && !selectedScriptId && !ideaValue) {
                    alert('Vui lòng cung cấp ít nhất một yêu cầu đầu vào (Prompt, Voice, Kịch bản) hoặc nhập ý tưởng mới.');
                    return;
                }
                if (!styleValue) {
                    alert('Vui lòng chọn một phong cách.');
                    return;
                }
                apiKey = localStorage.getItem('apiKey') || '';
                if (!apiKey) {
                    alert('Vui lòng nhập API Key trong phần Cài đặt.');
                    apiKeyBtn.click();
                    return;
                }
                
                hideAllContainers();
                
                try {
                    let durationValue = scriptDuration.value;
                    if (durationValue === 'custom') durationValue = scriptDurationCustom.value;
                    
                    const referencePrompt = prompts.find(p => p.id == selectedPromptId);
                    const referencePromptContent = referencePrompt ? referencePrompt.content : "Không có";
                    
                    const referenceVoice = voiceOvers.find(v => v.id == selectedVoiceId);
                    const referenceVoiceContent = referenceVoice ? referenceVoice.content : "Không có";

                    const referenceScript = scripts.find(s => s.id == selectedScriptId);
                    const referenceScriptContent = referenceScript ? referenceScript.content : "Không có";

                    const optionPromptVideo = document.getElementById('option-prompt-video').checked;
                    const optionVoiceScript = document.getElementById('option-voice-script').checked;
                    const optionDescription = document.getElementById('option-description').checked;

                    const mainScriptPrompt = `Bạn là một biên kịch chuyên nghiệp. Nhiệm vụ của bạn là viết một kịch bản phim mới. Hãy cấu trúc câu trả lời của bạn thành hai phần rõ ràng, phân tách bởi '---VOICE_PART---'.
                        Phần đầu tiên, bắt đầu bằng '---PROMPT_PART---', sẽ chứa tất cả mô tả hình ảnh, cảnh quay, hành động.
                        Phần thứ hai, bắt đầu bằng '---VOICE_PART---', sẽ chứa tất cả lời thoại.
                        Sử dụng các thông tin sau để tạo kịch bản:
                        - Yêu cầu Prompt đầu vào (tham khảo hình ảnh):
                        ---
                        ${referencePromptContent}
                        ---
                        - Yêu cầu Voice Off đầu vào (tham khảo lời thoại):
                        ---
                        ${referenceVoiceContent}
                        ---
                        - Kịch bản tham khảo (cốt truyện chính):
                        ---
                        ${referenceScriptContent}
                        ---
                        - Ý tưởng/Yêu cầu bổ sung: ${ideaValue ? ideaValue : "Kết hợp các yếu tố trên để tạo ra một kịch bản hoàn chỉnh."}
                        - Phong cách: ${styleValue}
                        - Thời lượng dự kiến: ${durationValue} phút
                        Hãy đảm bảo bạn tuân thủ đúng định dạng đầu ra đã yêu cầu.`;
                    
                    const generatedScript = await generateAiContent(mainScriptPrompt, submitButton);
                    
                    if (!generatedScript) throw new Error('Không nhận được nội dung kịch bản chính từ AI.');

                    // Split the result
                    const voiceSeparator = '---VOICE_PART---';
                    const promptSeparator = '---PROMPT_PART---';
                    let promptPart = '';
                    let voicePart = '';

                    if (generatedScript.includes(voiceSeparator)) {
                        const parts = generatedScript.split(voiceSeparator);
                        promptPart = parts[0].replace(promptSeparator, '').trim();
                        voicePart = parts[1].trim();
                    } else {
                        // Fallback if AI fails to follow format
                        promptPart = generatedScript.replace(promptSeparator, '').trim();
                        voicePart = "AI không tách được phần thoại. Vui lòng thử lại.";
                    }

                    const newTitle = ideaValue 
                        ? `Kịch bản cho: ${ideaValue.substring(0, 30)}...` 
                        : `Kịch bản từ: ${referenceScript?.title.substring(0, 20) || 'dữ liệu vào'}...`;
                    scriptResultTitle.value = newTitle;
                    scriptResultPromptContent.value = promptPart;
                    scriptResultVoiceContent.value = voicePart;
                    scriptResultContainer.classList.remove('hidden');

                    const hasAdditionalTasks = optionPromptVideo || optionVoiceScript || optionDescription;
                    if (hasAdditionalTasks) {
                        additionalResultsContainer.classList.remove('hidden');
                    }

                    const taskRunner = async (option, wrapper, contentEl, promptFn) => {
                        if (!option) return;
                        wrapper.classList.remove('hidden');
                        const loader = wrapper.querySelector('.sub-loader');
                        loader.classList.remove('hidden');
                        try {
                            const fullScriptForTask = `Phần hình ảnh:\n${promptPart}\n\nPhần thoại:\n${voicePart}`;
                            const prompt = promptFn(fullScriptForTask);
                            const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`, {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                            });
                             if (!response.ok) {
                                const errorData = await response.json();
                                throw new Error(errorData.error.message || `Lỗi HTTP: ${response.status}`);
                            }
                            const result = await response.json();
                            contentEl.value = result.candidates[0]?.content?.parts[0]?.text || "";
                        } catch (taskError) {
                            contentEl.value = `Lỗi: ${taskError.message}`;
                        } finally {
                            loader.classList.add('hidden');
                        }
                    };

                    await Promise.all([
                        taskRunner(optionPromptVideo, promptVideoResultWrapper, document.getElementById('prompt-video-result-content'), (script) => `Dựa vào kịch bản sau:\n\n---\n${script}\n---\n\nHãy tạo ra các câu lệnh (prompt) chi tiết cho AI tạo ảnh để hình dung hóa từng cảnh quay.`),
                        taskRunner(optionVoiceScript, voiceScriptResultWrapper, document.getElementById('voice-script-result-content'), (script) => `Từ kịch bản sau:\n\n---\n${script}\n---\n\nHãy trích xuất toàn bộ lời thoại thành một kịch bản lồng tiếng (Voice Script), ghi rõ tên nhân vật trước mỗi câu thoại.`),
                        taskRunner(optionDescription, descriptionResultWrapper, document.getElementById('description-result-content'), (script) => `Dựa vào nội dung kịch bản sau:\n\n---\n${script}\n---\n\nHãy viết một đoạn mô tả ngắn gọn, hấp dẫn cho video Youtube/Tiktok (khoảng 150-200 từ), kèm theo 5-10 hashtags phù hợp.`)
                    ]);

                } catch (error) {
                    console.error('Lỗi trong quá trình tạo:', error);
                    alert(`Đã xảy ra lỗi nghiêm trọng: ${error.message}`);
                }
            });
        });
    </script>
</body>
</html>

