<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AN PRODUCTION AI FILMS - STORY BROAD</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { 
            font-family: 'Inter', sans-serif; 
        }
        .hidden {
            display: none;
        }
        .script-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .script-item.active {
            background-color: #3b82f6;
        }
        .delete-btn { /* More generic delete button class */
            visibility: hidden;
            opacity: 0;
            transition: opacity 0.2s;
        }
        .script-item:hover .delete-btn {
            visibility: visible;
            opacity: 1;
        }
        /* Loading spinner */
        .loader {
            border: 2px solid #f3f3f3;
            border-top: 2px solid #4a90e2;
            border-radius: 50%;
            width: 16px;
            height: 16px;
            animation: spin 1s linear infinite;
        }
        .sub-loader {
             border: 2px solid #f3f3f3;
            border-top: 2px solid #fca5a5;
            border-radius: 50%;
            width: 16px;
            height: 16px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        /* Custom scrollbar for better aesthetics */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #111827; }
        ::-webkit-scrollbar-thumb { background: #4b5563; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #6b7280; }

        /* Toast Notification */
        #toast-notification {
            transition: opacity 0.5s, transform 0.5s;
        }
    </style>
</head>
<body class="bg-gray-900 text-white h-screen flex flex-col">
    <!-- Nút điều khiển ở góc trên bên phải -->
    <div class="fixed top-8 right-8 z-20 flex flex-col space-y-2">
        <button id="api-key-btn" title="Cài đặt" class="bg-gray-700 hover:bg-gray-600 text-white font-bold p-2 rounded-full transition duration-300 flex items-center">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" viewBox="0 0 20 20" fill="currentColor">
              <path fill-rule="evenodd" d="M11.49 3.17c-.38-1.56-2.6-1.56-2.98 0a1.532 1.532 0 01-2.286.948c-1.372-.836-2.942.734-1.57 1.996A1.532 1.532 0 013.17 8.51c-1.56.38-1.56 2.6 0 2.98a1.532 1.532 0 01.948 2.286c-.836 1.372.734 2.942 1.996 1.57A1.532 1.532 0 018.51 16.83c.38 1.56 2.6 1.56 2.98 0a1.532 1.532 0 012.286-.948c1.372.836 2.942-.734 1.57-1.996A1.532 1.532 0 0116.83 11.49c1.56-.38 1.56-2.6 0-2.98a1.532 1.532 0 01-.948-2.286c.836-1.372-.734-2.942-1.996-1.57A1.532 1.532 0 0111.49 3.17zM10 13a3 3 0 100-6 3 3 0 000 6z" clip-rule="evenodd" />
            </svg>
        </button>
        <a href="./thu-vien/" title="Thư viện PROMPTS" class="bg-gray-700 hover:bg-gray-600 text-white font-bold p-2 rounded-full transition duration-300 flex items-center">
             <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" viewBox="0 0 20 20" fill="currentColor">
               <path d="M9 4.804A7.968 7.968 0 005.5 4c-1.255 0-2.443.29-3.5.804v10A7.969 7.969 0 005.5 16c1.255 0 2.443-.29 3.5-.804V4.804zM14.5 4c-1.255 0-2.443.29-3.5.804v10A7.969 7.969 0 0014.5 16c1.255 0 2.443-.29 3.5.804v-10A7.968 7.968 0 0014.5 4z" />
            </svg>
        </a>
        <a href="./text-to-voice/" title="Tạo Voice (TTS)" class="bg-gray-700 hover:bg-gray-600 text-white font-bold p-2 rounded-full transition duration-300">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
              <path stroke-linecap="round" stroke-linejoin="round" d="M15.536 8.464a5 5 0 010 7.072m2.828-9.9a9 9 0 010 12.728M5.586 15H4a1 1 0 01-1-1v-4a1 1 0 011-1h1.586l4.707-4.707C10.923 3.663 12 4.109 12 5v14c0 .891-1.077 1.337-1.707.707L5.586 15z" />
            </svg>
        </a>
        <a href="./image-generator/" title="Tạo Ảnh AI" class="bg-gray-700 hover:bg-gray-600 text-white font-bold p-2 rounded-full transition duration-300">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
              <path stroke-linecap="round" stroke-linejoin="round" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z" />
              <path stroke-linecap="round" stroke-linejoin="round" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z" />
            </svg>
        </a>
    </div>

    <header class="text-center py-6 flex-shrink-0">
        <h1 class="text-4xl font-bold tracking-wider uppercase text-white">AN PRODUCTION AI FILMS - STORY BROAD</h1>
    </header>
    
    <div class="flex space-x-8 flex-grow p-8 overflow-hidden">
        <!-- Left Sidebar with Buttons -->
        <aside id="sidebar" class="w-64 flex-shrink-0">
            <div class="flex flex-col space-y-4">
                <div class="flex flex-col space-y-2 items-start">
                    <!-- Yellow Input Buttons -->
                    <div class="flex flex-wrap gap-2">
                        <button id="script-memory-btn" title="Dự án" class="bg-yellow-600 hover:bg-yellow-700 text-gray-900 font-bold p-3 rounded-full transition duration-300">
                             <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                              <path stroke-linecap="round" stroke-linejoin="round" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z" />
                            </svg>
                        </button>
                        <button id="prompt-memory-btn" title="Đầu vào Se" class="bg-yellow-600 hover:bg-yellow-700 text-gray-900 font-bold p-3 rounded-full transition duration-300 flex items-center justify-center w-12 h-12">
                            <span class="text-lg font-bold">Se</span>
                        </button>
                        <button id="voice-over-memory-btn" title="Đầu vào VO" class="bg-yellow-600 hover:bg-yellow-700 text-gray-900 font-bold p-3 rounded-full transition duration-300 flex items-center justify-center w-12 h-12">
                            <span class="text-sm font-bold">VO</span>
                        </button>
                    </div>
                    <!-- Blue Memory Links -->
                     <div class="flex flex-wrap gap-2">
                         <a href="./bo-nho-scripts/" title="Bộ nhớ Scripts" class="bg-blue-600 hover:bg-blue-700 text-white font-bold p-3 rounded-full transition duration-300 flex items-center justify-center w-12 h-12">
                           <span class="text-lg font-bold">S</span>
                        </a>
                        <a href="./bo-nho-sections/" title="Bộ nhớ Sections" class="bg-blue-600 hover:bg-blue-700 text-white font-bold p-3 rounded-full transition duration-300 flex items-center justify-center w-12 h-12">
                           <span class="text-sm font-bold">Se</span>
                        </a>
                        <a href="./bo-nho-prompts/" title="Bộ nhớ Prompts" class="bg-blue-600 hover:bg-blue-700 text-white font-bold p-3 rounded-full transition duration-300 flex items-center justify-center w-12 h-12">
                           <span class="text-lg font-bold">P</span>
                        </a>
                        <a href="./bo-nho-voice/" title="Bộ nhớ Voice Off" class="bg-blue-600 hover:bg-blue-700 text-white font-bold p-3 rounded-full transition duration-300 flex items-center justify-center w-12 h-12">
                           <span class="text-sm font-bold">VO</span>
                        </a>
                         <a href="./bo-nho-rac/" title="Bộ nhớ Rác" class="bg-red-600 hover:bg-red-700 text-white font-bold p-3 rounded-full transition duration-300 flex items-center justify-center w-12 h-12">
                           <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                              <path stroke-linecap="round" stroke-linejoin="round" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                            </svg>
                        </a>
                    </div>
                </div>
                <div class="border-t border-gray-600"></div>
                <button id="create-script-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-8 rounded-lg transition duration-300 text-lg w-full text-left">
                    P2S
                </button>
                <a href="./S2Se/" id="create-segment-btn" class="bg-purple-600 hover:bg-purple-700 text-white font-bold py-3 px-8 rounded-lg transition duration-300 text-lg w-full text-left">
                    S2Se
                </a>
                <button id="create-prompts-btn" class="bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-8 rounded-lg transition duration-300 text-lg w-full text-left">
                    Tạo PROMPTS
                </button>
            </div>
        </aside>

        <!-- Main Content Area -->
        <main id="main-workspace" class="flex-grow flex space-x-8 overflow-x-auto">
            <!-- Initial Input Column -->
            <div id="script-form-container" class="hidden w-[400px] flex-shrink-0 bg-gray-800 p-6 rounded-lg">
                <h2 class="text-2xl font-bold mb-6">Nhập đầu vào</h2>
                <form id="script-form" class="space-y-4">
                    <div>
                        <label for="script-idea" class="block text-sm font-medium text-gray-300">Ý tưởng kịch bản / Tóm tắt (Tùy chọn)</label>
                        <textarea id="script-idea" rows="4" class="mt-1 block w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-yellow-500"></textarea>
                    </div>
                    
                    <div class="space-y-4">
                        <div>
                            <label for="script-input-script" class="block text-sm font-medium text-yellow-400">Đầu vào Dự án</label>
                            <select id="script-input-script" class="mt-1 block w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-yellow-500">
                                <!-- Options will be dynamically populated -->
                            </select>
                        </div>
                        <div>
                            <label for="script-style" class="block text-sm font-medium text-gray-300">Phong cách</label>
                            <select id="script-style" required class="mt-1 block w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-yellow-500">
                                <option value="" disabled selected>Chọn phong cách</option>
                                <option>Mặc định</option>
                                <option>Storytelling</option>
                                <option>Hài hước</option>
                                <option>Chính kịch</option>
                                <option>Hành động</option>
                                <option>Kinh dị</option>
                                <option>Kịch câm</option>
                            </select>
                        </div>
                        <div>
                            <label for="script-duration" class="block text-sm font-medium text-gray-300">Thời lượng</label>
                             <select id="script-duration" required class="mt-1 block w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-yellow-500">
                                <option value="1">1 phút</option>
                                <option value="10">10 phút</option>
                                <option value="60">60 phút</option>
                                <option value="custom">Tùy chỉnh...</option>
                            </select>
                            <input type="number" id="script-duration-custom" placeholder="Nhập số phút" class="hidden mt-2 block w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-md">
                        </div>
                         <div>
                            <label for="word-limit" class="block text-sm font-medium text-gray-300">Giới hạn số từ (Tùy chọn)</label>
                            <input type="number" id="word-limit" placeholder="Ví dụ: 500" class="mt-1 block w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-yellow-500">
                        </div>
                    </div>

                    <div class="flex justify-end space-x-4 pt-4">
                        <button type="button" class="cancel-btn bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-md">Đóng</button>
                        <button type="submit" id="generate-script-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-md min-w-[80px] flex justify-center items-center">
                            <span class="btn-text">Tạo</span>
                            <span class="loader hidden ml-2"></span>
                        </button>
                    </div>
                </form>
            </div>
            
            <!-- VO Input Column -->
            <div id="vo-form-container" class="hidden w-[400px] flex-shrink-0 bg-gray-800 p-6 rounded-lg">
                <h2 class="text-2xl font-bold mb-6">Đầu vào VO</h2>
                <form id="vo-form" class="space-y-4">
                    <div>
                        <label for="vo-input-script" class="block text-sm font-medium text-yellow-400">Chọn kịch bản từ bộ nhớ S</label>
                        <select id="vo-input-script" class="mt-1 block w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-yellow-500">
                            <!-- Options will be dynamically populated -->
                        </select>
                    </div>
                    <div class="flex justify-end space-x-4 pt-4">
                        <button type="button" class="cancel-btn bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-md">Đóng</button>
                        <button type="submit" class="bg-amber-600 hover:bg-amber-700 text-white font-bold py-2 px-4 rounded-md min-w-[80px] flex justify-center items-center">
                            <span class="btn-text">Tạo VO</span>
                            <span class="loader hidden ml-2"></span>
                        </button>
                    </div>
                </form>
            </div>


             <!-- Result Column -->
            <div id="script-result-container" class="hidden flex-grow bg-gray-800 p-6 rounded-lg flex flex-col">
                <h2 class="text-2xl font-bold mb-4">Kịch bản được tạo từ đầu vào</h2>
               
                <div class="space-y-4 flex-grow flex flex-col">
                     <div class="flex justify-between items-center">
                        <label for="script-result-title" class="block text-sm font-medium text-gray-300">Tiêu đề</label>
                        <div class="flex space-x-2">
                             <button type="button" id="save-to-s-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-1 px-3 text-sm rounded-md">Lưu vào S</button>
                            <button type="button" id="go-to-segment-btn" class="bg-purple-600 hover:bg-purple-700 text-white font-bold py-1 px-3 text-sm rounded-md">S2Se</button>
                        </div>
                    </div>
                    <input type="text" id="script-result-title" required class="block w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-md">
                    
                    <div class="flex-grow flex flex-col">
                        <div class="flex justify-between items-center">
                            <label for="script-result-content" class="block text-sm font-medium text-gray-300">Nội dung kịch bản</label>
                            <span id="script-word-count" class="text-xs text-gray-400">0 từ</span>
                        </div>
                        <textarea id="script-result-content" class="mt-1 block w-full px-3 py-2 bg-gray-900 border border-gray-700 rounded-md flex-grow"></textarea>
                        <div class="flex justify-end space-x-2 pt-2">
                             <button type="button" data-target="script-result-content" class="copy-btn bg-green-600 hover:bg-green-700 text-white font-bold py-1 px-3 text-sm rounded-md">Copy</button>
                             <button type="button" data-target="script-result-content" data-title="script" class="export-btn bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-1 px-3 text-sm rounded-md">Xuất</button>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- VO Result Column -->
            <div id="vo-result-container" class="hidden flex-grow bg-gray-800 p-6 rounded-lg flex flex-col">
                <h2 class="text-2xl font-bold mb-4">VO được tạo ra từ đầu vào</h2>
                 <div class="space-y-4 flex-grow flex flex-col">
                     <div class="flex justify-between items-center">
                        <label for="vo-result-title" class="block text-sm font-medium text-gray-300">Tiêu đề</label>
                         <button type="button" id="save-vo-to-vo-blue-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-1 px-3 text-sm rounded-md">Lưu vào VO xanh</button>
                    </div>
                    <input type="text" id="vo-result-title" required class="block w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-md">
                    
                    <div class="flex-grow flex flex-col">
                        <div class="flex justify-between items-center">
                            <label for="vo-result-content" class="block text-sm font-medium text-gray-300">Nội dung Voice Off</label>
                            <span id="vo-word-count" class="text-xs text-gray-400">0 từ</span>
                        </div>
                        <textarea id="vo-result-content" class="mt-1 block w-full px-3 py-2 bg-gray-900 border border-gray-700 rounded-md flex-grow"></textarea>
                        <div class="flex justify-end space-x-2 pt-2">
                             <button type="button" data-target="vo-result-content" class="copy-btn bg-green-600 hover:bg-green-700 text-white font-bold py-1 px-3 text-sm rounded-md">Copy</button>
                             <button type="button" data-target="vo-result-content" data-title="voice_over" class="export-btn bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-1 px-3 text-sm rounded-md">Xuất</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Segment Creation Column -->
            <div id="segment-form-container" class="hidden w-[450px] flex-shrink-0 bg-gray-800 p-6 rounded-lg">
                <h2 class="text-2xl font-bold mb-6">Tạo phân đoạn chi tiết</h2>
                <form id="segment-form" class="space-y-4">
                     <div>
                        <label for="segment-input-script" class="block text-sm font-medium text-yellow-400">Đầu vào Dự án</label>
                        <textarea id="segment-input-script" rows="5" class="mt-1 block w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-yellow-500" placeholder="Nội dung kịch bản từ bước trước..."></textarea>
                    </div>
                    
                    <div class="space-y-4">
                        <div>
                            <label for="segment-input-se" class="block text-sm font-medium text-yellow-400">Đầu vào Se</label>
                            <select id="segment-input-se" class="mt-1 block w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-yellow-500">
                                <!-- Options will be dynamically populated -->
                            </select>
                        </div>
                         <div>
                            <label for="segment-input-vo" class="block text-sm font-medium text-yellow-400">Đầu vào VO</label>
                            <select id="segment-input-vo" class="mt-1 block w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-yellow-500">
                                <!-- Options will be dynamically populated -->
                            </select>
                        </div>
                        <div>
                            <label for="segment-output-type" class="block text-sm font-medium text-gray-300">Loại đầu ra</label>
                            <select id="segment-output-type" class="mt-1 block w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-yellow-500">
                                <option value="all">Mô tả & Prompts chi tiết</option>
                                <option value="description">Chỉ mô tả chi tiết</option>
                                <option value="prompts">Chỉ Prompts cho AI Image</option>
                            </select>
                        </div>
                        <div>
                            <label for="segment-style" class="block text-sm font-medium text-gray-300">Phong cách</label>
                            <select id="segment-style" class="mt-1 block w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-yellow-500">
                                <option value="">AI tự sáng tạo</option>
                                <option>Tả thực (Photorealistic)</option>
                                <option>Điện ảnh (Cinematic)</option>
                                <option>Tranh sơn dầu (Oil Painting)</option>
                                <option>Hoạt hình 3D (3D Animation)</option>
                                <option>Anime</option>
                            </select>
                        </div>
                        <div>
                            <label for="segment-camera-angle" class="block text-sm font-medium text-gray-300">Góc máy</label>
                             <select id="segment-camera-angle" class="mt-1 block w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-yellow-500">
                                <option value="">AI tự chọn</option>
                                <option>Toàn cảnh (Wide shot)</option>
                                <option>Trung cảnh (Medium shot)</option>
                                <option>Cận cảnh (Close-up shot)</option>
                                <option>Góc máy từ trên xuống (High-angle shot)</option>
                                <option>Góc máy từ dưới lên (Low-angle shot)</option>
                            </select>
                        </div>
                         <div>
                            <label for="segment-setting" class="block text-sm font-medium text-gray-300">Bối cảnh</label>
                            <select id="segment-setting" class="mt-1 block w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-yellow-500">
                                <option value="">Không xác định</option>
                                <option>Trong nhà (Interior)</option>
                                <option>Ngoài trời - Thành phố (Exterior - City)</option>
                                <option>Ngoài trời - Thiên nhiên (Exterior - Nature)</option>
                                <option>Không gian vũ trụ (Outer Space)</option>
                                <option>Kỳ ảo (Fantasy)</option>
                            </select>
                        </div>
                    </div>

                    <div class="flex justify-end space-x-4 pt-4">
                        <button type="button" class="cancel-btn bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-md">Đóng</button>
                        <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-md min-w-[80px] flex justify-center items-center">
                            <span class="btn-text">Tạo</span>
                            <span class="loader hidden ml-2"></span>
                        </button>
                    </div>
                </form>
            </div>
            
            <!-- Segment Result Column -->
            <div id="segment-result-container" class="hidden flex-grow bg-gray-800 p-6 rounded-lg flex flex-col">
                <h2 class="text-2xl font-bold mb-4">Kết quả Phân đoạn</h2>
                <div class="space-y-4 flex-grow flex flex-col">
                    <div class="flex-grow flex flex-col">
                        <div class="flex justify-between items-center">
                            <label for="segment-result-content" class="block text-sm font-medium text-gray-300">Nội dung chi tiết</label>
                            <span id="segment-word-count" class="text-xs text-gray-400">0 từ</span>
                        </div>
                        <textarea id="segment-result-content" readonly class="mt-1 block w-full px-3 py-2 bg-gray-900 border border-gray-700 rounded-md flex-grow"></textarea>
                        <div class="flex justify-end space-x-2 pt-2">
                             <button type="button" data-target="segment-result-content" class="copy-btn bg-green-600 hover:bg-green-700 text-white font-bold py-1 px-3 text-sm rounded-md">Copy</button>
                             <button type="button" data-target="segment-result-content" data-title="segment_detail" class="export-btn bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-1 px-3 text-sm rounded-md">Xuất</button>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>
    
    <!-- Script Memory Modal -->
    <div id="script-memory-container" class="hidden fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50 p-4">
        <div class="bg-gray-800 p-6 rounded-lg relative w-full max-w-6xl h-[90vh] flex flex-col">
            <button class="close-modal-btn absolute top-4 right-4 text-gray-400 hover:text-white">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
                </svg>
            </button>
            <h2 class="text-2xl font-bold mb-6 flex-shrink-0">Bộ nhớ Dự án</h2>
            <div class="flex space-x-6 flex-grow overflow-hidden">
                <!-- List -->
                <div class="w-1/3 border-r border-gray-700 pr-6 flex flex-col">
                    <div class="flex-shrink-0 flex justify-between items-center mb-4">
                        <h3 class="font-bold text-lg">Danh sách</h3>
                        <button data-type="script" class="new-item-btn bg-blue-600 hover:bg-blue-700 text-white font-bold p-2 rounded-full transition duration-300">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M9 13h6m-3-3v6m5 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                                </svg>
                        </button>
                    </div>
                    <div id="script-list" class="space-y-2 overflow-y-auto flex-grow"></div>
                </div>
                <!-- Editor -->
                <div id="script-editor-panel" class="w-2/3 hidden flex-col">
                    <form id="script-memory-form" class="space-y-4 flex flex-col flex-grow">
                        <input type="hidden" id="script-memory-id">
                        <div>
                            <label for="script-memory-title" class="block text-sm font-medium text-gray-300">Tiêu đề</label>
                            <input type="text" id="script-memory-title" placeholder="Nhập tiêu đề..." required class="mt-1 block w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500">
                        </div>
                        <div class="flex-grow flex flex-col">
                            <label for="script-memory-input" class="block text-sm font-medium text-gray-300">Nội dung</label>
                            <textarea id="script-memory-input" placeholder="Dán hoặc nhập nội dung..." required class="mt-1 block w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 flex-grow"></textarea>
                        </div>
                        <div class="flex justify-end space-x-3 pt-2">
                            <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-md">Lưu</button>
                            <button type="button" id="copy-script-memory-btn" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-md">Copy</button>
                            <button type="button" id="export-script-memory-btn" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-md">Xuất TXT</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Prompt Memory Modal -->
    <div id="prompt-memory-container" class="hidden fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50 p-4">
        <div class="bg-gray-800 p-6 rounded-lg relative w-full max-w-6xl h-[90vh] flex flex-col">
            <button class="close-modal-btn absolute top-4 right-4 text-gray-400 hover:text-white">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" /></svg>
            </button>
            <h2 class="text-2xl font-bold mb-6 flex-shrink-0">Bộ nhớ Đầu vào Se</h2>
            <div class="flex space-x-6 flex-grow overflow-hidden">
                <!-- List -->
                <div class="w-1/3 border-r border-gray-700 pr-6 flex flex-col">
                    <div class="flex-shrink-0 flex justify-between items-center mb-4">
                        <h3 class="font-bold text-lg">Danh sách</h3>
                        <button data-type="prompt" class="new-item-btn bg-blue-600 hover:bg-blue-700 text-white font-bold p-2 rounded-full transition duration-300">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9 13h6m-3-3v6m5 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" /></svg>
                        </button>
                    </div>
                    <div id="prompt-list" class="space-y-2 overflow-y-auto flex-grow"></div>
                </div>
                <!-- Editor -->
                <div id="prompt-editor-panel" class="w-2/3 hidden flex-col">
                    <form id="prompt-memory-form" class="space-y-4 flex flex-col flex-grow">
                        <input type="hidden" id="prompt-memory-id">
                        <div>
                            <label for="prompt-memory-title" class="block text-sm font-medium text-gray-300">Tiêu đề</label>
                            <input type="text" id="prompt-memory-title" placeholder="Nhập tiêu đề..." required class="mt-1 block w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-md">
                        </div>
                        <div class="flex-grow flex flex-col">
                            <label for="prompt-memory-input" class="block text-sm font-medium text-gray-300">Nội dung</label>
                            <textarea id="prompt-memory-input" placeholder="Dán hoặc nhập nội dung..." required class="mt-1 block w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-md flex-grow"></textarea>
                        </div>
                        <div class="flex justify-end space-x-3 pt-2">
                            <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-md">Lưu</button>
                            <button type="button" id="copy-prompt-memory-btn" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-md">Copy</button>
                            <button type="button" id="export-prompt-memory-btn" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-md">Xuất TXT</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Voice Over Memory Modal -->
    <div id="voice-over-memory-container" class="hidden fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50 p-4">
        <div class="bg-gray-800 p-6 rounded-lg relative w-full max-w-6xl h-[90vh] flex flex-col">
            <button class="close-modal-btn absolute top-4 right-4 text-gray-400 hover:text-white">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" /></svg>
            </button>
            <h2 class="text-2xl font-bold mb-6 flex-shrink-0">Bộ nhớ Đầu vào VO</h2>
            <div class="flex space-x-6 flex-grow overflow-hidden">
                <!-- List -->
                <div class="w-1/3 border-r border-gray-700 pr-6 flex flex-col">
                    <div class="flex-shrink-0 flex justify-between items-center mb-4">
                        <h3 class="font-bold text-lg">Danh sách</h3>
                        <button data-type="voiceOver" class="new-item-btn bg-blue-600 hover:bg-blue-700 text-white font-bold p-2 rounded-full transition duration-300">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9 13h6m-3-3v6m5 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" /></svg>
                        </button>
                    </div>
                    <div id="voice-over-list" class="space-y-2 overflow-y-auto flex-grow"></div>
                </div>
                <!-- Editor -->
                <div id="voice-over-editor-panel" class="w-2/3 hidden flex-col">
                    <form id="voice-over-memory-form" class="space-y-4 flex flex-col flex-grow">
                        <input type="hidden" id="voice-over-memory-id">
                        <div>
                            <label for="voice-over-memory-title" class="block text-sm font-medium text-gray-300">Tiêu đề</label>
                            <input type="text" id="voice-over-memory-title" placeholder="Nhập tiêu đề..." required class="mt-1 block w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-md">
                        </div>
                        <div class="flex-grow flex flex-col">
                            <label for="voice-over-memory-input" class="block text-sm font-medium text-gray-300">Nội dung</label>
                            <textarea id="voice-over-memory-input" placeholder="Dán hoặc nhập nội dung..." required class="mt-1 block w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-md flex-grow"></textarea>
                        </div>
                        <div class="flex justify-end space-x-3 pt-2">
                            <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-md">Lưu</button>
                            <button type="button" id="copy-voice-over-memory-btn" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-md">Copy</button>
                            <button type="button" id="export-voice-over-memory-btn" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-md">Xuất TXT</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>


    <!-- API Key Modal -->
    <div id="api-key-container" class="hidden fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50 p-4">
         <div class="bg-gray-800 p-6 rounded-lg max-w-lg w-full relative">
             <button class="close-modal-btn absolute top-4 right-4 text-gray-400 hover:text-white">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
                </svg>
            </button>
            <h2 class="text-2xl font-bold mb-6">Cài đặt</h2>
            <form id="api-key-form" class="space-y-4">
                <div>
                    <label for="api-key-input" class="block text-sm font-medium text-gray-300">
                        API Key của bạn
                         <a href="https://aistudio.google.com/api-keys" target="_blank" class="text-blue-400 hover:underline text-xs ml-2">(Lấy API Key tại đây)</a>
                    </label>
                    <div class="relative mt-1">
                        <input type="password" id="api-key-input" placeholder="Dán API Key của bạn vào đây..." class="block w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-yellow-500 pr-10">
                        <button type="button" id="toggle-api-key-visibility" class="absolute inset-y-0 right-0 px-3 flex items-center text-gray-400 hover:text-white">
                            <!-- Eye Icon SVG will be injected here -->
                        </button>
                    </div>
                </div>
                <div>
                    <label for="ai-model-select" class="block text-sm font-medium text-gray-300">Model AI mặc định</label>
                    <select id="ai-model-select" class="mt-1 block w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-yellow-500">
                        <option value="gemini-2.5-flash-image-preview">gemini-2.5-flash-image-preview</option>
                        <option value="gpt-4">GPT-4</option>
                        <option value="claude-3">Claude 3</option>
                    </select>
                </div>
                 <div class="flex justify-end space-x-4 pt-4">
                    <button type="submit" class="bg-yellow-600 hover:bg-yellow-700 text-gray-900 font-bold py-2 px-4 rounded-md">Lưu Cài đặt</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Delete Confirmation Modal -->
    <div id="delete-confirm-modal" class="hidden fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50 p-4">
         <div class="bg-gray-700 rounded-lg shadow-xl p-8 w-full max-w-md">
            <h2 class="text-xl font-bold mb-4">Xác nhận xóa</h2>
            <p class="text-gray-300 mb-6">Bạn có chắc chắn muốn xóa mục này không?</p>
            <div class="flex justify-end space-x-4">
                <button type="button" id="cancel-delete-btn" class="bg-gray-600 hover:bg-gray-500 text-white font-bold py-2 px-4 rounded-md">Hủy</button>
                <button type="button" id="confirm-delete-btn" class="bg-red-600 hover:bg-red-500 text-white font-bold py-2 px-4 rounded-md">Xóa</button>
            </div>
        </div>
    </div>
    
    <!-- Toast Notification -->
    <div id="toast-notification" class="hidden fixed top-5 right-5 bg-blue-600 text-white py-2 px-4 rounded-lg shadow-lg opacity-0 transform translate-y-2 transition-all duration-300">
        <!-- Message will be inserted here -->
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- UI Elements ---
            const createScriptBtn = document.getElementById('create-script-btn');
            const createSegmentBtn = document.getElementById('create-segment-btn');
            const createVoBtn = document.getElementById('create-vo-btn');
            const scriptFormContainer = document.getElementById('script-form-container');
            const segmentFormContainer = document.getElementById('segment-form-container');
            const voFormContainer = document.getElementById('vo-form-container');
            const apiKeyBtn = document.getElementById('api-key-btn');
            const apiKeyContainer = document.getElementById('api-key-container');
            
            // Memory Buttons
            const scriptMemoryBtn = document.getElementById('script-memory-btn');
            const promptMemoryBtn = document.getElementById('prompt-memory-btn');
            const voiceOverMemoryBtn = document.getElementById('voice-over-memory-btn');
            
            // Memory Modals
            const scriptMemoryContainer = document.getElementById('script-memory-container');
            const promptMemoryContainer = document.getElementById('prompt-memory-container');
            const voiceOverMemoryContainer = document.getElementById('voice-over-memory-container');
            
            // Result Containers
            const scriptResultContainer = document.getElementById('script-result-container');
            const segmentResultContainer = document.getElementById('segment-result-container');
            const voResultContainer = document.getElementById('vo-result-container');

            
            const scriptForm = document.getElementById('script-form');
            const refineForm = document.getElementById('refine-form');
            const scriptInputScript = document.getElementById('script-input-script');
            const scriptIdea = document.getElementById('script-idea');
            const scriptDuration = document.getElementById('script-duration');
            const scriptDurationCustom = document.getElementById('script-duration-custom');
            
            // Script Result Elements
            const scriptResultTitle = document.getElementById('script-result-title');
            const scriptResultContent = document.getElementById('script-result-content');
            const scriptWordCount = document.getElementById('script-word-count');

            // VO Form & Result Elements
            const voForm = document.getElementById('vo-form');
            const voInputScript = document.getElementById('vo-input-script');
            const voResultTitle = document.getElementById('vo-result-title');
            const voResultContent = document.getElementById('vo-result-content');
            const voWordCount = document.getElementById('vo-word-count');


            // Segment Elements
            const segmentForm = document.getElementById('segment-form');
            const segmentResultContent = document.getElementById('segment-result-content');
            const segmentWordCount = document.getElementById('segment-word-count');
            const segmentInputScript = document.getElementById('segment-input-script');
            const segmentInputSe = document.getElementById('segment-input-se');
            const segmentInputVo = document.getElementById('segment-input-vo');

            // API Key Elements
            const apiKeyForm = document.getElementById('api-key-form');
            const apiKeyInput = document.getElementById('api-key-input');
            const toggleApiKeyVisibilityBtn = document.getElementById('toggle-api-key-visibility');
            const aiModelSelect = document.getElementById('ai-model-select');
            const eyeIconSVG = `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M10 12a2 2 0 100-4 2 2 0 000 4z" /><path fill-rule="evenodd" d="M.458 10C3.732 4.943 7.523 3 10 3s6.268 1.943 9.542 7c-3.274 5.057-7.523 7-9.542 7S3.732 15.057.458 10zM14 10a4 4 0 11-8 0 4 4 0 018 0z" clip-rule="evenodd" /></svg>`;
            const eyeOffIconSVG = `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M3.707 2.293a1 1 0 00-1.414 1.414l14 14a1 1 0 001.414-1.414l-1.473-1.473A10.014 10.014 0 0019.542 10C18.268 8.517 16.635 7.412 14.722 6.708l-1.414-1.414A10.009 10.009 0 0010 3C7.523 3 5.268 4.943 2.458 10a11.97 11.97 0 003.876 3.655l-2.227-2.228a1 1 0 00-1.414-1.414L.293 8.293a1 1 0 000 1.414l2 2a1 1 0 001.414 0l1.293-1.293A8.003 8.003 0 0110 7a8 8 0 012.828.532l1.432-1.432A9.98 9.98 0 0010 5c-2.477 0-4.732 1.943-7.542 7 .57 1.1 1.254 2.063 2.07 2.912l-1.42-1.42a1 1 0 00-1.414-1.414L.293 15.707a1 1 0 001.414 1.414l14-14a1 1 0 00-1.414-1.414L3.707 2.293z" clip-rule="evenodd" /><path d="M10.707 10.293a1 1 0 10-1.414-1.414 1 1 0 001.414 1.414z" /></svg>`;

            // Delete Modal
            const deleteConfirmModal = document.getElementById('delete-confirm-modal');
            const cancelDeleteBtn = document.getElementById('cancel-delete-btn');
            const confirmDeleteBtn = document.getElementById('confirm-delete-btn');
            
            // --- Data Store ---
            let inputScripts = JSON.parse(localStorage.getItem('inputScripts')) || [];
            let inputPrompts = JSON.parse(localStorage.getItem('inputPrompts')) || [];
            let inputVoiceOvers = JSON.parse(localStorage.getItem('inputVoiceOvers')) || [];
            let mainScripts = JSON.parse(localStorage.getItem('mainScripts')) || [];
            let apiKey = localStorage.getItem('apiKey') || '';
            let aiModel = localStorage.getItem('aiModel') || 'gemini-2.5-flash-image-preview';
            let itemToDelete = null; // {id: '123', type: 'script'}
            let isCurrentResultSaved = true;

            // --- Generic Memory Modal Elements ---
            const memoryElements = {
                script: {
                    container: scriptMemoryContainer,
                    list: document.getElementById('script-list'),
                    editorPanel: document.getElementById('script-editor-panel'),
                    form: document.getElementById('script-memory-form'),
                    idInput: document.getElementById('script-memory-id'),
                    titleInput: document.getElementById('script-memory-title'),
                    contentInput: document.getElementById('script-memory-input'),
                    copyBtn: document.getElementById('copy-script-memory-btn'),
                    exportBtn: document.getElementById('export-script-memory-btn'),
                },
                prompt: {
                    container: promptMemoryContainer,
                    list: document.getElementById('prompt-list'),
                    editorPanel: document.getElementById('prompt-editor-panel'),
                    form: document.getElementById('prompt-memory-form'),
                    idInput: document.getElementById('prompt-memory-id'),
                    titleInput: document.getElementById('prompt-memory-title'),
                    contentInput: document.getElementById('prompt-memory-input'),
                    copyBtn: document.getElementById('copy-prompt-memory-btn'),
                    exportBtn: document.getElementById('export-prompt-memory-btn'),
                },
                voiceOver: {
                    container: voiceOverMemoryContainer,
                    list: document.getElementById('voice-over-list'),
                    editorPanel: document.getElementById('voice-over-editor-panel'),
                    form: document.getElementById('voice-over-memory-form'),
                    idInput: document.getElementById('voice-over-memory-id'),
                    titleInput: document.getElementById('voice-over-memory-title'),
                    contentInput: document.getElementById('voice-over-memory-input'),
                    copyBtn: document.getElementById('copy-voice-over-memory-btn'),
                    exportBtn: document.getElementById('export-voice-over-memory-btn'),
                }
            };

            // --- General Functions ---
            function hideAllContainers() {
                scriptFormContainer.classList.add('hidden');
                scriptResultContainer.classList.add('hidden');
                segmentFormContainer.classList.add('hidden');
                segmentResultContainer.classList.add('hidden');
                voFormContainer.classList.add('hidden');
                voResultContainer.classList.add('hidden');
            }

            function hideAllModals() {
                Object.values(memoryElements).forEach(elements => elements.container.classList.add('hidden'));
                apiKeyContainer.classList.add('hidden');
            }
            
            function showToast(message) {
                const toast = document.getElementById('toast-notification');
                if (!toast) return;
                toast.textContent = message;
                toast.classList.remove('hidden', 'opacity-0', 'translate-y-2');
                toast.classList.add('opacity-100', 'translate-y-0');

                setTimeout(() => {
                    toast.classList.remove('opacity-100', 'translate-y-0');
                    toast.classList.add('opacity-0', 'translate-y-2');
                    setTimeout(() => {
                         toast.classList.add('hidden');
                    }, 500); // Wait for fade out transition
                }, 3000); // Toast visible for 3 seconds
            }


            function autoSaveToTrash() {
                 if (!isCurrentResultSaved && !scriptResultContainer.classList.contains('hidden')) {
                    const title = scriptResultTitle.value.trim();
                    const content = scriptResultContent.value.trim();
                    if (title || content) {
                        let trashItems = JSON.parse(localStorage.getItem('trashItems')) || [];
                        const now = new Date();
                        const newItem = {
                            id: now.getTime(),
                            title: `Tự động lưu: ${title || 'Chưa có tiêu đề'}`,
                            dateTime: now.toLocaleString('vi-VN'),
                            content: content
                        };
                        trashItems.push(newItem);
                        localStorage.setItem('trashItems', JSON.stringify(trashItems));
                        showToast('Nội dung chưa lưu đã được tự động chuyển vào Bộ nhớ Rác.');
                    }
                }
                isCurrentResultSaved = true; // Reset for the new task
            }

            // --- Generic Memory Management Functions ---
            function getDataForType(type) {
                if (type === 'script') return inputScripts;
                if (type === 'prompt') return inputPrompts;
                if (type === 'voiceOver') return inputVoiceOvers;
                return [];
            }

            function saveDataToStorage(type) {
                if (type === 'script') localStorage.setItem('inputScripts', JSON.stringify(inputScripts));
                if (type === 'prompt') localStorage.setItem('inputPrompts', JSON.stringify(inputPrompts));
                if (type === 'voiceOver') localStorage.setItem('inputVoiceOvers', JSON.stringify(inputVoiceOvers));
            }

            function renderListForType(type) {
                const elements = memoryElements[type];
                const data = getDataForType(type);
                elements.list.innerHTML = '';
                const currentId = elements.idInput.value;

                data.forEach(item => {
                    const div = document.createElement('div');
                    div.className = `w-full text-left p-3 rounded-md transition-colors script-item cursor-pointer ${item.id == currentId ? 'active' : 'hover:bg-gray-700'}`;
                    div.dataset.id = item.id;
                    div.dataset.type = type;
                    div.innerHTML = `
                        <span class="truncate pointer-events-none">${item.title}</span>
                        <button class="delete-btn text-gray-400 hover:text-red-500 p-1 rounded-full" data-id="${item.id}" data-type="${type}">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 pointer-events-none" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm4 0a1 1 0 012 0v6a1 1 0 11-2 0V8z" clip-rule="evenodd" />
                            </svg>
                        </button>
                    `;
                    elements.list.appendChild(div);
                });
            }

            function clearFormForType(type) {
                const elements = memoryElements[type];
                elements.form.reset();
                elements.idInput.value = '';
                renderListForType(type);
            }

            function loadItemIntoForm(id, type) {
                const elements = memoryElements[type];
                const data = getDataForType(type);
                const item = data.find(i => i.id == id);
                if (item) {
                    elements.idInput.value = item.id;
                    elements.titleInput.value = item.title;
                    elements.contentInput.value = item.content;
                }
                renderListForType(type);
            }

            function openDeleteModal(id, type) {
                itemToDelete = { id, type };
                deleteConfirmModal.classList.remove('hidden');
            }

            function performDelete() {
                if (!itemToDelete) return;
                const { id, type } = itemToDelete;
                
                let data = getDataForType(type);
                if(type === 'script') inputScripts = data.filter(item => item.id != id);
                if(type === 'prompt') inputPrompts = data.filter(item => item.id != id);
                if(type === 'voiceOver') inputVoiceOvers = data.filter(item => item.id != id);

                saveDataToStorage(type);

                const elements = memoryElements[type];
                if (elements.idInput.value == id) {
                    clearFormForType(type);
                } else {
                    renderListForType(type);
                }
                
                itemToDelete = null;
                deleteConfirmModal.classList.add('hidden');
            }

            function saveSettings() {
                localStorage.setItem('apiKey', apiKey);
                localStorage.setItem('aiModel', aiModel);
            }

            function renderSettingsDisplay() {
                apiKeyInput.value = apiKey;
                apiKeyInput.type = 'password';
                toggleApiKeyVisibilityBtn.innerHTML = eyeIconSVG;
                aiModelSelect.value = aiModel;
            }
            
            function downloadAsTxt(title, content) {
                const blob = new Blob([content], { type: 'text/plain;charset=utf-8' });
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                const fileName = title.toLowerCase().replace(/[^a-z0-9\s-]/g, '').replace(/\s+/g, '_').substring(0, 50) + '.txt';
                link.href = url;
                link.download = fileName;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url);
            }

            function populateDropdown(selectElement, data, placeholderText) {
                if (!selectElement) return;
                selectElement.innerHTML = '';
                const placeholderOption = document.createElement('option');
                placeholderOption.textContent = placeholderText;
                placeholderOption.value = '';
                selectElement.appendChild(placeholderOption);

                data.forEach(item => {
                    const option = document.createElement('option');
                    option.value = item.id;
                    option.textContent = item.title;
                    selectElement.appendChild(option.cloneNode(true));
                });
            }

            function populateAllInputDropdowns() {
                populateDropdown(scriptInputScript, inputScripts, 'Chọn từ Đầu vào Dự án...');
                populateDropdown(voInputScript, mainScripts, 'Chọn kịch bản từ bộ nhớ S...');
                populateDropdown(segmentInputSe, inputPrompts, 'Chọn từ Đầu vào Se...');
                populateDropdown(segmentInputVo, inputVoiceOvers, 'Chọn từ Đầu vào VO...');
            }


            // --- Initial Setup ---
            toggleApiKeyVisibilityBtn.innerHTML = eyeIconSVG;

            // --- Event Listeners ---
            createScriptBtn.addEventListener('click', () => {
                autoSaveToTrash();
                // hideAllContainers();
                scriptForm.reset();
                populateAllInputDropdowns();
                scriptDurationCustom.classList.add('hidden');
                scriptFormContainer.classList.remove('hidden');
            });
            
            createVoBtn.addEventListener('click', () => {
                autoSaveToTrash();
                voForm.reset();
                populateAllInputDropdowns();
                voFormContainer.classList.remove('hidden');
                voResultContainer.classList.add('hidden');
            });

            createSegmentBtn.addEventListener('click', (e) => {
                e.preventDefault(); // Prevent default link behavior
                autoSaveToTrash();
                window.location.href = e.currentTarget.href;
            });

            scriptDuration.addEventListener('change', (e) => {
                scriptDurationCustom.classList.toggle('hidden', e.target.value !== 'custom');
            });

            // Memory Buttons
            function openMemoryModal(type) {
                autoSaveToTrash();
                hideAllContainers();
                hideAllModals();
                const elements = memoryElements[type];
                elements.container.classList.remove('hidden');
                renderListForType(type);
                clearFormForType(type);
                elements.editorPanel.classList.add('hidden');
            }

            scriptMemoryBtn.addEventListener('click', () => openMemoryModal('script'));
            promptMemoryBtn.addEventListener('click', () => openMemoryModal('prompt'));
            voiceOverMemoryBtn.addEventListener('click', () => openMemoryModal('voiceOver'));
            
            apiKeyBtn.addEventListener('click', () => {
                autoSaveToTrash();
                hideAllContainers();
                hideAllModals();
                renderSettingsDisplay();
                apiKeyContainer.classList.remove('hidden');
            });
            
            document.querySelectorAll('.close-modal-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.target.closest('.fixed').classList.add('hidden');
                });
            });

            // Generic listeners for all memory modals
            Object.keys(memoryElements).forEach(type => {
                const elements = memoryElements[type];
                
                elements.list.addEventListener('click', (e) => {
                    const deleteBtn = e.target.closest('.delete-btn');
                    const itemDiv = e.target.closest('.script-item');
                    if (deleteBtn) {
                        openDeleteModal(deleteBtn.dataset.id, deleteBtn.dataset.type);
                    } else if (itemDiv) {
                        elements.editorPanel.classList.remove('hidden');
                        loadItemIntoForm(itemDiv.dataset.id, itemDiv.dataset.type);
                    }
                });

                elements.form.addEventListener('submit', (e) => {
                    e.preventDefault();
                    const id = elements.idInput.value;
                    const title = elements.titleInput.value.trim();
                    const content = elements.contentInput.value.trim();
                    if (!title || !content) {
                        alert('Tiêu đề và nội dung không được để trống.');
                        return;
                    }
                    
                    let data = getDataForType(type);
                    if (id) {
                        const index = data.findIndex(i => i.id == id);
                        if (index > -1) data[index] = { ...data[index], title, content };
                    } else {
                        const newItem = { id: Date.now(), title, content };
                        data.push(newItem);
                        elements.idInput.value = newItem.id;
                    }
                    
                    saveDataToStorage(type);
                    renderListForType(type);
                    alert('Đã lưu thành công!');
                });

                elements.copyBtn.addEventListener('click', () => {
                    const contentToCopy = elements.contentInput.value;
                    if(!contentToCopy) { alert('Không có nội dung để sao chép.'); return; }
                    navigator.clipboard.writeText(contentToCopy).then(() => alert('Đã sao chép vào clipboard!')).catch(err => alert('Sao chép thất bại!'));
                });

                elements.exportBtn.addEventListener('click', () => {
                    const title = elements.titleInput.value;
                    const content = elements.contentInput.value;
                    if (!content) { alert('Không có nội dung để xuất file.'); return; }
                    downloadAsTxt(title || `${type}_khong_tieu_de`, content);
                });
            });

            document.querySelectorAll('.new-item-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const type = e.currentTarget.dataset.type;
                    clearFormForType(type);
                    memoryElements[type].editorPanel.classList.remove('hidden');
                });
            });

            apiKeyForm.addEventListener('submit', (e) => {
                e.preventDefault();
                apiKey = apiKeyInput.value.trim();
                aiModel = aiModelSelect.value;
                saveSettings();
                renderSettingsDisplay();
                alert('Đã lưu Cài đặt thành công!');
                apiKeyContainer.classList.add('hidden');
            });

            toggleApiKeyVisibilityBtn.addEventListener('click', () => {
                if (apiKeyInput.type === 'password') {
                    apiKeyInput.type = 'text';
                    toggleApiKeyVisibilityBtn.innerHTML = eyeOffIconSVG;
                } else {
                    apiKeyInput.type = 'password';
                    toggleApiKeyVisibilityBtn.innerHTML = eyeIconSVG;
                }
            });
            
             // Delegated event listener for result container buttons
            document.getElementById('main-workspace').addEventListener('click', e => {
                const button = e.target.closest('button');
                if (!button) return;
                
                if (button.id === 'go-to-segment-btn') {
                    autoSaveToTrash();
                    const content = scriptResultContent.value;
                    localStorage.setItem('scriptToProcess', content);
                    window.location.href = './S2Se/';
                    return;
                }

                if (button.id === 'save-to-s-btn') {
                    const title = scriptResultTitle.value.trim();
                    const content = scriptResultContent.value.trim();
                    if (!title || !content) {
                        alert('Cần có tiêu đề và nội dung để lưu.');
                        return;
                    }
                    let mainScripts = JSON.parse(localStorage.getItem('scripts')) || []; // Corrected storage key
                    const newItem = { id: Date.now(), title: title, content: content };
                    mainScripts.push(newItem);
                    localStorage.setItem('scripts', JSON.stringify(mainScripts)); // Corrected storage key
                    isCurrentResultSaved = true;
                    showToast('Đã lưu vào Bộ nhớ Scripts (S xanh)!');
                }
                 if (button.id === 'save-vo-to-vo-blue-btn') {
                    const title = voResultTitle.value.trim();
                    const content = voResultContent.value.trim();
                    if (!title || !content) {
                        alert('Cần có tiêu đề và nội dung để lưu.');
                        return;
                    }
                    let voiceMemory = JSON.parse(localStorage.getItem('voiceOvers')) || [];
                    const newItem = { id: Date.now(), title: title, content: content };
                    voiceMemory.push(newItem);
                    localStorage.setItem('voiceOvers', JSON.stringify(voiceMemory));
                    showToast('Đã lưu vào Bộ nhớ Voice Off (VO xanh)!');
                }
                
                else if (button.classList.contains('copy-btn')) {
                    const targetId = button.dataset.target;
                    const contentToCopy = document.getElementById(targetId).value;
                    if(!contentToCopy) { alert('Không có nội dung để sao chép.'); return; }
                    navigator.clipboard.writeText(contentToCopy).then(() => alert('Đã sao chép vào clipboard!')).catch(err => alert('Sao chép thất bại!'));
                }
                
                else if (button.classList.contains('export-btn')) {
                    const targetId = button.dataset.target;
                    const title = button.dataset.title || 'untitled';
                    const content = document.getElementById(targetId).value;
                    if (!content) { alert('Không có nội dung để xuất file.'); return; }
                    downloadAsTxt(title, content);
                }
            });


            cancelDeleteBtn.addEventListener('click', () => deleteConfirmModal.classList.add('hidden'));
            confirmDeleteBtn.addEventListener('click', performDelete);

            document.querySelectorAll('.cancel-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                     autoSaveToTrash();
                    e.target.closest('.bg-gray-800').classList.add('hidden');
                });
            });
            
            async function generateAiContent(prompt, submitButton) {
                 const btnText = submitButton.querySelector('.btn-text');
                 const loader = submitButton.querySelector('.loader');

                 btnText.textContent = 'Đang tạo...';
                 loader.classList.remove('hidden');
                 submitButton.disabled = true;

                try {
                    const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                    });
                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(errorData.error.message || `Lỗi HTTP: ${response.status}`);
                    }
                    const result = await response.json();
                    return result.candidates[0]?.content?.parts[0]?.text || "";
                } finally {
                    btnText.textContent = 'Tạo';
                    loader.classList.add('hidden');
                    submitButton.disabled = false;
                }
            }
            
            function updateWordCount(textArea, countElement) {
                if (!textArea || !countElement) return;
                const text = textArea.value.trim();
                if (text === '') {
                    countElement.textContent = '0 từ';
                    return;
                }
                const wordCount = text.split(/\s+/).filter(Boolean).length;
                countElement.textContent = `${wordCount} từ`;
            }

            scriptResultContent.addEventListener('input', () => {
                updateWordCount(scriptResultContent, scriptWordCount);
                isCurrentResultSaved = false;
            });
            scriptResultTitle.addEventListener('input', () => {
                isCurrentResultSaved = false;
            });
            
            voResultContent.addEventListener('input', () => updateWordCount(voResultContent, voWordCount));
            segmentResultContent.addEventListener('input', () => updateWordCount(segmentResultContent, segmentWordCount));


            // --- Main Script Form Submission ---
            scriptForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                
                const submitButton = e.target.querySelector('button[type="submit"]');
                const selectedScriptId = scriptInputScript.value;
                const ideaValue = scriptIdea.value.trim();
                const styleValue = document.getElementById('script-style').value;

                if (!selectedScriptId && !ideaValue) {
                    alert('Vui lòng cung cấp "Đầu vào Dự án" hoặc nhập "Ý tưởng" mới.');
                    return;
                }
                if (!styleValue) {
                    alert('Vui lòng chọn một phong cách.');
                    return;
                }
                apiKey = localStorage.getItem('apiKey') || '';
                if (!apiKey) {
                    alert('Vui lòng nhập API Key trong phần Cài đặt.');
                    apiKeyBtn.click();
                    return;
                }
                
                scriptResultContainer.classList.add('hidden');
                
                try {
                    let durationValue = scriptDuration.value;
                    if (durationValue === 'custom') durationValue = scriptDurationCustom.value;
                    const wordLimit = document.getElementById('word-limit').value;

                    const referenceScript = inputScripts.find(s => s.id == selectedScriptId);
                    const referenceScriptContent = referenceScript ? referenceScript.content : "Không có";

                    const mainScriptPrompt = `Bạn là một biên kịch chuyên nghiệp. Nhiệm vụ của bạn là viết một kịch bản phim mới.
                        Sử dụng các thông tin sau để tạo kịch bản:
                        - Đầu vào Dự án (cốt truyện chính):
                        ---
                        ${referenceScriptContent}
                        ---
                        - Ý tưởng/Yêu cầu bổ sung từ người dùng: ${ideaValue ? ideaValue : "Hãy phát triển kịch bản từ Đầu vào Dự án."}
                        - Phong cách: ${styleValue}
                        - Thời lượng dự kiến: ${durationValue} phút
                        ${wordLimit ? `- Giới hạn tổng số từ khoảng: ${wordLimit} từ` : ''}
                        Chỉ trả về nội dung kịch bản hoàn chỉnh, bao gồm cả mô tả và lời thoại.`;
                    
                    const generatedScript = await generateAiContent(mainScriptPrompt, submitButton);
                    
                    if (!generatedScript) throw new Error('Không nhận được nội dung kịch bản chính từ AI.');
                    
                    const newTitle = ideaValue 
                        ? `Kịch bản cho: ${ideaValue.substring(0, 30)}...` 
                        : `Kịch bản từ: ${referenceScript?.title.substring(0, 20) || 'dữ liệu vào'}...`;
                    scriptResultTitle.value = newTitle;
                    scriptResultContent.value = generatedScript;
                    
                    updateWordCount(scriptResultContent, scriptWordCount);
                    
                    scriptResultContainer.classList.remove('hidden');
                    isCurrentResultSaved = false; // New content is not saved yet
                    populateAllInputDropdowns();

                } catch (error) {
                    console.error('Lỗi trong quá trình tạo:', error);
                    alert(`Đã xảy ra lỗi nghiêm trọng: ${error.message}`);
                }
            });
            
            // --- VO Form Submission ---
            voForm.addEventListener('submit', async (e) => {
                 e.preventDefault();
                const submitButton = e.target.querySelector('button[type="submit"]');
                const selectedScriptId = voInputScript.value;

                if (!selectedScriptId) {
                    alert('Vui lòng chọn một kịch bản từ bộ nhớ S.');
                    return;
                }

                 apiKey = localStorage.getItem('apiKey') || '';
                if (!apiKey) {
                    alert('Vui lòng nhập API Key trong phần Cài đặt.');
                    apiKeyBtn.click();
                    return;
                }
                
                voResultContainer.classList.add('hidden');

                try {
                    const sourceScript = mainScripts.find(s => s.id == selectedScriptId);
                    if (!sourceScript) throw new Error('Không tìm thấy kịch bản nguồn.');
                    
                    const voPrompt = `Bạn là một chuyên gia về kịch bản. Từ kịch bản đầy đủ sau đây, hãy trích xuất toàn bộ lời thoại (voice-over) và lời thoại của các nhân vật thành một kịch bản lồng tiếng (Voice Script). Giữ nguyên tên nhân vật trước mỗi câu thoại.\n\nKỊCH BẢN GỐC:\n---\n${sourceScript.content}\n---`;

                    const generatedVO = await generateAiContent(voPrompt, submitButton);
                    
                    if (!generatedVO) throw new Error('Không nhận được nội dung VO từ AI.');
                    
                    voResultTitle.value = `VO cho: ${sourceScript.title}`;
                    voResultContent.value = generatedVO;
                    
                    updateWordCount(voResultContent, voWordCount);
                    
                    voResultContainer.classList.remove('hidden');

                } catch (error) {
                     console.error('Lỗi trong quá trình tạo VO:', error);
                    alert(`Đã xảy ra lỗi: ${error.message}`);
                }
            });

            
            // --- Segment Form Submission ---
             segmentForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                
                const submitButton = e.target.querySelector('button[type="submit"]');
                const inputScript = segmentInputScript.value;
                const selectedSeId = segmentInputSe.value;
                const selectedVoId = segmentInputVo.value;
                const outputType = document.getElementById('segment-output-type').value;
                const style = document.getElementById('segment-style').value;
                const cameraAngle = document.getElementById('segment-camera-angle').value;
                const setting = document.getElementById('segment-setting').value;
        

                if (!inputScript.trim()) {
                    alert('Vui lòng nhập thông tin kịch bản đầu vào.');
                    return;
                }
                 apiKey = localStorage.getItem('apiKey') || '';
                if (!apiKey) {
                    alert('Vui lòng nhập API Key trong phần Cài đặt.');
                    apiKeyBtn.click();
                    return;
                }
                
                const referenceSe = inputPrompts.find(p => p.id == selectedSeId);
                const referenceSeContent = referenceSe ? referenceSe.content : "Không có";
                
                const referenceVo = inputVoiceOvers.find(v => v.id == selectedVoId);
                const referenceVoContent = referenceVo ? referenceVo.content : "Không có";

                // Construct the AI prompt
                let finalPrompt = `Bạn là một đạo diễn hình ảnh và chuyên gia viết prompt. Dựa trên kịch bản và các yêu cầu dưới đây, hãy tạo ra nội dung chi tiết.
                
                **Kịch bản gốc:**
                ---
                ${inputScript}
                ---

                **Đầu vào bổ sung:**
                 - Đầu vào Se (tham khảo hình ảnh): ${referenceSeContent}
                 - Đầu vào VO (tham khảo lời thoại): ${referenceVoContent}

                **Yêu cầu:**
                - **Loại đầu ra:** ${outputType}
                - **Phong cách:** ${style || 'Tự do sáng tạo'}
                - **Góc máy:** ${cameraAngle || 'Tự do sáng tạo'}
                - **Bối cảnh:** ${setting || 'Tự do sáng tạo'}
                
                Hãy viết một cách chi tiết và gợi hình. Nếu yêu cầu tạo prompt, hãy tạo các prompt phức tạp, giàu chi tiết phù hợp cho các mô hình AI tạo ảnh như Midjourney, Stable Diffusion.`;

                try {
                    segmentResultContent.value = "Đang xử lý...";
                    segmentResultContainer.classList.remove('hidden'); // Show the result container
                    const result = await generateAiContent(finalPrompt, submitButton);
                    segmentResultContent.value = result;
                    updateWordCount(segmentResultContent, segmentWordCount);
                } catch (error) {
                    segmentResultContent.value = `Lỗi: ${error.message}`;
                    console.error('Lỗi khi tạo phân đoạn:', error);
                }
            });
        });
    </script>
</body>
</html>

