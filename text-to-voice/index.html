<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Công cụ Sáng tạo AI</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .hidden {
            display: none;
        }
        /* Loading spinner */
        .loader {
            border: 2px solid #f3f3f3;
            border-top: 2px solid #3498db;
            border-radius: 50%;
            width: 16px;
            height: 16px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .voice-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .voice-item.active {
            background-color: #3b82f6;
        }
        .delete-voice-btn {
            visibility: hidden;
            opacity: 0;
            transition: opacity 0.2s;
        }
        .voice-item:hover .delete-voice-btn {
            visibility: visible;
            opacity: 1;
        }
    </style>
</head>
<body class="bg-gray-900 text-white">
    <!-- Nút Setting ở góc trên bên phải -->
    <div class="fixed top-8 right-8 z-20">
        <button id="setting-btn" title="Cài đặt" class="bg-gray-700 hover:bg-gray-600 text-white font-bold p-2 rounded-full transition duration-300 flex items-center">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" viewBox="0 0 20 20" fill="currentColor">
              <path fill-rule="evenodd" d="M11.49 3.17c-.38-1.56-2.6-1.56-2.98 0a1.532 1.532 0 01-2.286.948c-1.372-.836-2.942.734-1.57 1.996A1.532 1.532 0 013.17 8.51c-1.56.38-1.56 2.6 0 2.98a1.532 1.532 0 01.948 2.286c-.836 1.372.734 2.942 1.996 1.57A1.532 1.532 0 018.51 16.83c.38 1.56 2.6 1.56 2.98 0a1.532 1.532 0 012.286-.948c1.372.836 2.942-.734 1.57-1.996A1.532 1.532 0 0116.83 11.49c1.56-.38 1.56-2.6 0-2.98a1.532 1.532 0 01-.948-2.286c.836-1.372-.734-2.942-1.996-1.57A1.532 1.532 0 0111.49 3.17zM10 13a3 3 0 100-6 3 3 0 000 6z" clip-rule="evenodd" />
            </svg>
        </button>
    </div>

    <div class="flex h-screen">
        <!-- Sidebar -->
        <aside class="w-72 bg-gray-800 p-6 flex-shrink-0 flex flex-col">
             <h1 class="text-2xl font-bold mb-6">Công cụ AI</h1>
             <div class="space-y-4">
                 <button id="text-to-voice-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg transition duration-300 text-lg w-full text-left">
                    Tạo Voice (TTS)
                </button>
                <!-- Các công cụ khác sẽ được thêm vào đây -->
             </div>
             <div class="mt-auto">
                 <button id="voice-storage-btn" class="bg-gray-600 hover:bg-gray-500 text-white font-bold py-3 px-6 rounded-lg transition duration-300 text-lg w-full text-left">
                    Lưu trữ Giọng
                </button>
             </div>
        </aside>

        <!-- Main Content Area -->
        <main id="main-content" class="flex-1 p-8 overflow-y-auto">
            <!-- Welcome View -->
            <div id="welcome-view">
                <div class="text-center mt-20">
                     <h1 class="text-4xl font-bold text-gray-400">Công cụ Sáng tạo AI</h1>
                     <p class="text-gray-500 mt-4">Chọn một công cụ từ thanh bên trái để bắt đầu.</p>
                </div>
            </div>
            
            <!-- Text to Voice View (Hidden by default) -->
            <div id="text-to-voice-container" class="hidden">
                 <h2 class="text-3xl font-bold mb-6">Tạo Voice từ Kịch bản</h2>
                 <div class="bg-gray-800 p-6 rounded-lg">
                    <form id="text-to-voice-form" class="space-y-4">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label for="saved-style-select" class="block text-sm font-medium text-gray-300">Chọn mô tả đã lưu</label>
                                <select id="saved-style-select" class="mt-1 block w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-blue-500">
                                    <!-- Options will be populated by JS -->
                                </select>
                            </div>
                            <div>
                                <label for="style-instructions-input" class="block text-sm font-medium text-gray-300">Hoặc nhập mô tả mới</label>
                                <input type="text" id="style-instructions-input" placeholder="VD: giọng nam trầm ấm, truyền cảm..." class="mt-1 block w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-blue-500">
                            </div>
                        </div>
                        <div>
                            <label for="script-input" class="block text-sm font-medium text-gray-300">Kịch bản</label>
                            <textarea id="script-input" rows="8" required placeholder="Dán kịch bản của bạn vào đây..." class="mt-1 block w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-blue-500"></textarea>
                        </div>
                         <div>
                            <label for="voice-select" class="block text-sm font-medium text-gray-300">Giọng đọc (Google)</label>
                            <div class="flex items-center space-x-2 mt-1">
                                <select id="voice-select" class="block w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-blue-500">
                                    <!-- Voices will be populated by JS -->
                                </select>
                                <button type="button" id="listen-preview-btn" title="Nghe thử giọng đọc" class="p-2 bg-gray-600 hover:bg-gray-500 rounded-md">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                      <path d="M10 12a2 2 0 100-4 2 2 0 000 4z" />
                                      <path fill-rule="evenodd" d="M.458 10C3.732 4.943 7.523 3 10 3s6.268 1.943 9.542 7c-3.274 5.057-7.523 7-9.542 7S3.732 15.057.458 10zM14 10a4 4 0 11-8 0 4 4 0 018 0z" clip-rule="evenodd" />
                                    </svg>
                                </button>
                            </div>
                        </div>
                        <div class="flex justify-end space-x-4 pt-4">
                            <button type="submit" id="tts-submit-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-6 rounded-md flex items-center justify-center min-w-[120px]">
                                <span class="btn-text">Tạo Voice</span>
                                <span class="loader hidden ml-2"></span>
                            </button>
                        </div>
                    </form>
                 </div>

                 <!-- Audio Result Section -->
                 <div id="audio-result-container" class="mt-8 hidden">
                     <h3 class="text-2xl font-bold mb-4">Kết quả</h3>
                     <div class="bg-gray-800 p-6 rounded-lg">
                         <audio id="audio-player" controls class="w-full"></audio>
                     </div>
                 </div>
            </div>

             <!-- Voice Storage View (Hidden by default) -->
            <div id="voice-storage-container" class="hidden bg-gray-800 p-6 rounded-lg">
                <h2 class="text-2xl font-bold mb-6">Bộ nhớ Giọng nói</h2>
                <div class="flex space-x-6">
                    <!-- Voice List -->
                    <div class="w-1/3 border-r border-gray-700 pr-6">
                        <button id="new-voice-btn" class="w-full mb-4 bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-md">Giọng nói mới</button>
                        <div id="voice-list" class="space-y-2 overflow-y-auto max-h-[60vh]">
                            <!-- Saved voices will be listed here -->
                        </div>
                    </div>
                    <!-- Voice Editor -->
                    <div class="w-2/3">
                        <form id="voice-storage-form" class="space-y-4">
                            <input type="hidden" id="voice-storage-id">
                            <div>
                                <label for="voice-storage-title" class="block text-sm font-medium text-gray-300">Tiêu đề</label>
                                <input type="text" id="voice-storage-title" placeholder="Nhập tiêu đề..." required class="mt-1 block w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500">
                            </div>
                            <div>
                                <label for="voice-storage-content" class="block text-sm font-medium text-gray-300">Nội dung (Mô tả giọng đọc)</label>
                                <textarea id="voice-storage-content" rows="10" placeholder="Dán hoặc nhập mô tả..." required class="mt-1 block w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500"></textarea>
                            </div>
                            <div class="flex justify-end space-x-3 pt-2">
                                <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-md">Lưu</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>

        </main>
    </div>

    <!-- Setting Modal (remains a modal) -->
    <div id="setting-container" class="hidden fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50 p-4">
        <div class="bg-gray-800 p-6 rounded-lg max-w-lg w-full">
            <h2 class="text-2xl font-bold mb-6">Cài đặt</h2>
            <form id="setting-form" class="space-y-4">
                <div>
                    <label for="api-key-input" class="block text-sm font-medium text-gray-300">
                        API Key của bạn
                         <a href="https://aistudio.google.com/api-keys" target="_blank" class="text-blue-400 hover:underline text-xs ml-2">(Lấy API Key tại đây)</a>
                    </label>
                    <div class="relative mt-1">
                        <input type="password" id="api-key-input" placeholder="Dán API Key của bạn vào đây..." class="block w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-yellow-500 pr-10">
                        <button type="button" id="toggle-api-key-visibility" class="absolute inset-y-0 right-0 px-3 flex items-center text-gray-400 hover:text-white">
                            <!-- Eye Icon SVG will be injected here -->
                        </button>
                    </div>
                </div>
                <div>
                    <label for="ai-model-select" class="block text-sm font-medium text-gray-300">Model AI mặc định</label>
                    <select id="ai-model-select" class="mt-1 block w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-yellow-500">
                        <option value="gemini-2.5-flash">gemini Flash 2.5</option>
                        <option value="gpt-4">GPT-4</option>
                        <option value="claude-3">Claude 3</option>
                    </select>
                </div>
                 <div class="flex justify-end space-x-4 pt-4">
                    <button type="button" id="cancel-setting-btn" class="bg-gray-600 hover:bg-gray-500 text-white font-bold py-2 px-4 rounded-md">Hủy</button>
                    <button type="submit" class="bg-yellow-600 hover:bg-yellow-700 text-gray-900 font-bold py-2 px-4 rounded-md">Lưu Cài đặt</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Delete Confirmation Modal -->
    <div id="delete-confirm-modal" class="hidden fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50 p-4">
        <div class="bg-gray-700 rounded-lg shadow-xl p-8 w-full max-w-md">
            <h2 class="text-xl font-bold mb-4">Xác nhận xóa</h2>
            <p class="text-gray-300 mb-6">Bạn có chắc chắn muốn xóa mục này không?</p>
            <div class="flex justify-end space-x-4">
                <button type="button" id="cancel-delete-btn" class="bg-gray-600 hover:bg-gray-500 text-white font-bold py-2 px-4 rounded-md">Hủy</button>
                <button type="button" id="confirm-delete-btn" class="bg-red-600 hover:bg-red-500 text-white font-bold py-2 px-4 rounded-md">Xóa</button>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const settingBtn = document.getElementById('setting-btn');
            const settingContainer = document.getElementById('setting-container');
            const settingForm = document.getElementById('setting-form');
            const apiKeyInput = document.getElementById('api-key-input');
            const aiModelSelect = document.getElementById('ai-model-select');
            const toggleApiKeyVisibilityBtn = document.getElementById('toggle-api-key-visibility');
            const cancelSettingBtn = document.getElementById('cancel-setting-btn');

            const textToVoiceBtn = document.getElementById('text-to-voice-btn');
            const welcomeView = document.getElementById('welcome-view');
            const textToVoiceContainer = document.getElementById('text-to-voice-container');
            const textToVoiceForm = document.getElementById('text-to-voice-form');
            const voiceSelect = document.getElementById('voice-select');
            const ttsSubmitBtn = document.getElementById('tts-submit-btn');
            const audioResultContainer = document.getElementById('audio-result-container');
            const audioPlayer = document.getElementById('audio-player');
            const listenPreviewBtn = document.getElementById('listen-preview-btn');
            const savedStyleSelect = document.getElementById('saved-style-select');
            const styleInstructionsInput = document.getElementById('style-instructions-input');

            const voiceStorageBtn = document.getElementById('voice-storage-btn');
            const voiceStorageContainer = document.getElementById('voice-storage-container');
            const voiceList = document.getElementById('voice-list');
            const newVoiceBtn = document.getElementById('new-voice-btn');
            const voiceStorageForm = document.getElementById('voice-storage-form');
            const voiceStorageId = document.getElementById('voice-storage-id');
            const voiceStorageTitle = document.getElementById('voice-storage-title');
            const voiceStorageContent = document.getElementById('voice-storage-content');
            
            const deleteConfirmModal = document.getElementById('delete-confirm-modal');
            const cancelDeleteBtn = document.getElementById('cancel-delete-btn');
            const confirmDeleteBtn = document.getElementById('confirm-delete-btn');

            const eyeIconSVG = `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M10 12a2 2 0 100-4 2 2 0 000 4z" /><path fill-rule="evenodd" d="M.458 10C3.732 4.943 7.523 3 10 3s6.268 1.943 9.542 7c-3.274 5.057-7.523 7-9.542 7S3.732 15.057.458 10zM14 10a4 4 0 11-8 0 4 4 0 018 0z" clip-rule="evenodd" /></svg>`;
            const eyeOffIconSVG = `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M3.707 2.293a1 1 0 00-1.414 1.414l14 14a1 1 0 001.414-1.414l-1.473-1.473A10.014 10.014 0 0019.542 10C18.268 8.517 16.635 7.412 14.722 6.708l-1.414-1.414A10.009 10.009 0 0010 3C7.523 3 5.268 4.943 2.458 10a11.97 11.97 0 003.876 3.655l-2.227-2.228a1 1 0 00-1.414-1.414L.293 8.293a1 1 0 000 1.414l2 2a1 1 0 001.414 0l1.293-1.293A8.003 8.003 0 0110 7a8 8 0 012.828.532l1.432-1.432A9.98 9.98 0 0010 5c-2.477 0-4.732 1.943-7.542 7 .57 1.1 1.254 2.063 2.07 2.912l-1.42-1.42a1 1 0 00-1.414-1.414L.293 15.707a1 1 0 001.414 1.414l14-14a1 1 0 00-1.414-1.414L3.707 2.293z" clip-rule="evenodd" /><path d="M10.707 10.293a1 1 0 10-1.414-1.414 1 1 0 001.414 1.414z" /></svg>`;
            
             const googleVoices = [
                { name: 'Zephyr', desc: 'Tươi sáng' }, { name: 'Puck', desc: 'Lạc quan' }, { name: 'Charon', desc: 'Truyền cảm' }, 
                { name: 'Kore', desc: 'Dứt khoát' }, { name: 'Fenrir', desc: 'Sôi nổi' }, { name: 'Leda', desc: 'Trẻ trung' },
                { name: 'Orus', desc: 'Dứt khoát' }, { name: 'Aoede', desc: 'Nhẹ nhàng' }, { name: 'Callirrhoe', desc: 'Thoải mái' },
                { name: 'Autonoe', desc: 'Tươi sáng' }, { name: 'Enceladus', desc: 'Hơi thở' }, { name: 'Iapetus', desc: 'Rõ ràng' },
                { name: 'Umbriel', desc: 'Thoải mái' }, { name: 'Algieba', desc: 'Mượt mà' }, { name: 'Despina', desc: 'Mượt mà' },
                { name: 'Erinome', desc: 'Rõ ràng' }, { name: 'Algenib', desc: 'Trầm khàn' }, { name: 'Rasalgethi', desc: 'Truyền cảm' },
                { name: 'Laomedeia', desc: 'Lạc quan' }, { name: 'Achernar', desc: 'Mềm mại' }, { name: 'Alnilam', desc: 'Dứt khoát' },
                { name: 'Schedar', desc: 'Đều đặn' }, { name: 'Gacrux', desc: 'Trưởng thành' }, { name: 'Pulcherrima', desc: 'Thẳng thắn' },
                { name: 'Achird', desc: 'Thân thiện' }, { name: 'Zubenelgenubi', desc: 'Tự nhiên' }, { name: 'Vindemiatrix', desc: 'Dịu dàng' },
                { name: 'Sadachbia', desc: 'Sôi động' }, { name: 'Sadaltager', desc: 'Hiểu biết' }, { name: 'Sulafat', desc: 'Ấm áp' }
            ];

            let voices = JSON.parse(localStorage.getItem('voices')) || [];
            let voiceIdToDelete = null;

            // --- TTS Helper Functions ---
            function base64ToArrayBuffer(base64) {
                const binaryString = window.atob(base64);
                const len = binaryString.length;
                const bytes = new Uint8Array(len);
                for (let i = 0; i < len; i++) { bytes[i] = binaryString.charCodeAt(i); }
                return bytes.buffer;
            }

            function pcmToWav(pcmData, sampleRate) {
                const header = new ArrayBuffer(44);
                const view = new DataView(header);
                view.setUint32(0, 0x52494646, false); // "RIFF"
                view.setUint32(4, 36 + pcmData.byteLength, true);
                view.setUint32(8, 0x57415645, false); // "WAVE"
                view.setUint32(12, 0x666d7420, false); // "fmt "
                view.setUint32(16, 16, true);
                view.setUint16(20, 1, true); 
                view.setUint16(22, 1, true);
                view.setUint32(24, sampleRate, true);
                view.setUint32(28, sampleRate * 2, true);
                view.setUint16(32, 2, true);
                view.setUint16(34, 16, true);
                view.setUint32(36, 0x64617461, false); // "data"
                view.setUint32(40, pcmData.byteLength, true);
                return new Blob([view, pcmData], { type: 'audio/wav' });
            }
            
            // --- UI Functions ---
            function hideAllContainers() {
                welcomeView.classList.add('hidden');
                textToVoiceContainer.classList.add('hidden');
                voiceStorageContainer.classList.add('hidden');
            }

            // --- General Functions ---
            function openSettings() {
                apiKeyInput.value = localStorage.getItem('apiKey') || '';
                aiModelSelect.value = localStorage.getItem('aiModel') || 'gemini-2.5-flash';
                apiKeyInput.type = 'password';
                toggleApiKeyVisibilityBtn.innerHTML = eyeIconSVG;
                settingContainer.classList.remove('hidden');
            }

            function closeSettings() {
                settingContainer.classList.add('hidden');
            }

            function populateVoicesDropdown() {
                googleVoices.forEach(voice => {
                    const option = document.createElement('option');
                    option.value = voice.name;
                    option.textContent = `${voice.name} (${voice.desc})`;
                    voiceSelect.appendChild(option);
                });
            }

            function populateStyleInstructionsDropdown() {
                savedStyleSelect.innerHTML = '';
                const placeholder = document.createElement('option');
                placeholder.value = '';
                placeholder.textContent = 'Chọn từ mô tả đã lưu...';
                savedStyleSelect.appendChild(placeholder);

                voices.forEach(voice => {
                    const option = document.createElement('option');
                    option.value = voice.id;
                    option.textContent = voice.title;
                    savedStyleSelect.appendChild(option);
                });
            }

            // --- Voice Storage Functions ---
            function saveVoicesToStorage() {
                localStorage.setItem('voices', JSON.stringify(voices));
            }
            
            function renderVoiceList() {
                voiceList.innerHTML = '';
                const currentId = voiceStorageId.value;
                voices.forEach(voice => {
                    const item = document.createElement('div');
                    item.className = `w-full text-left p-3 rounded-md transition-colors voice-item cursor-pointer ${voice.id == currentId ? 'active' : 'hover:bg-gray-700'}`;
                    item.dataset.id = voice.id;
                    item.innerHTML = `
                        <span class="truncate pointer-events-none">${voice.title}</span>
                        <button class="delete-voice-btn text-gray-400 hover:text-red-500 p-1 rounded-full" data-id="${voice.id}">
                             <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 pointer-events-none" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm4 0a1 1 0 012 0v6a1 1 0 11-2 0V8z" clip-rule="evenodd" />
                            </svg>
                        </button>
                    `;
                    voiceList.appendChild(item);
                });
            }

            function clearVoiceForm() {
                voiceStorageForm.reset();
                voiceStorageId.value = '';
                renderVoiceList();
            }

            function loadVoiceIntoForm(id) {
                const voice = voices.find(v => v.id == id);
                if (voice) {
                    voiceStorageId.value = voice.id;
                    voiceStorageTitle.value = voice.title;
                    voiceStorageContent.value = voice.content;
                }
                renderVoiceList();
            }

            function openDeleteModal(id) {
                voiceIdToDelete = id;
                deleteConfirmModal.classList.remove('hidden');
            }

            function closeDeleteModal() {
                voiceIdToDelete = null;
                deleteConfirmModal.classList.add('hidden');
            }

            function performDelete() {
                if (!voiceIdToDelete) return;

                voices = voices.filter(v => v.id != voiceIdToDelete);
                saveVoicesToStorage();
                
                if (voiceStorageId.value == voiceIdToDelete) {
                    clearVoiceForm();
                } else {
                    renderVoiceList();
                }
                
                closeDeleteModal();
            }

            // --- Initial Setup ---
            toggleApiKeyVisibilityBtn.innerHTML = eyeIconSVG;
            populateVoicesDropdown();
            
            // --- Event Listeners ---
            settingBtn.addEventListener('click', openSettings);
            cancelSettingBtn.addEventListener('click', closeSettings);

            textToVoiceBtn.addEventListener('click', () => {
                 hideAllContainers();
                 populateStyleInstructionsDropdown();
                 textToVoiceContainer.classList.remove('hidden');
            });
            
            voiceStorageBtn.addEventListener('click', () => {
                hideAllContainers();
                voiceStorageContainer.classList.remove('hidden');
                renderVoiceList();
                clearVoiceForm();
            });


            settingContainer.addEventListener('click', (e) => {
                if (e.target === settingContainer) closeSettings();
            });

            settingForm.addEventListener('submit', (e) => {
                e.preventDefault();
                localStorage.setItem('apiKey', apiKeyInput.value.trim());
                localStorage.setItem('aiModel', aiModelSelect.value);
                alert('Đã lưu Cài đặt thành công!');
                closeSettings();
            });
            
            async function generateAndPlayAudio(text, voice, buttonEl) {
                 const apiKey = localStorage.getItem('apiKey');
                if (!apiKey) {
                    alert('Vui lòng nhập API Key trong phần Cài đặt.');
                    openSettings();
                    return;
                }
                
                const originalContent = buttonEl.innerHTML;
                const loader = document.createElement('span');
                loader.className = 'loader';
                buttonEl.innerHTML = '';
                buttonEl.appendChild(loader);
                buttonEl.disabled = true;

                try {
                    const payload = {
                        contents: [{ parts: [{ text }] }],
                        generationConfig: {
                            responseModalities: ["AUDIO"],
                            speechConfig: { voiceConfig: { prebuiltVoiceConfig: { voiceName: voice } } }
                        },
                    };
                    const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-tts:generateContent?key=${apiKey}`, {
                        method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload)
                    });

                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(errorData.error.message || `HTTP error! status: ${response.status}`);
                    }
                    const result = await response.json();
                    const audioPart = result?.candidates?.[0]?.content?.parts?.[0];
                    if (audioPart?.inlineData?.data) {
                        const sampleRate = parseInt(audioPart.inlineData.mimeType.match(/rate=(\d+)/)[1], 10);
                        const pcmData = base64ToArrayBuffer(audioPart.inlineData.data);
                        const pcm16 = new Int16Array(pcmData);
                        const wavBlob = pcmToWav(pcm16, sampleRate);
                        const audioUrl = URL.createObjectURL(wavBlob);
                        return audioUrl;
                    } else {
                        throw new Error('Không nhận được dữ liệu âm thanh hợp lệ.');
                    }
                } catch (error) {
                    console.error("Lỗi khi tạo audio:", error);
                    alert(`Tạo audio thất bại: ${error.message}`);
                    return null;
                } finally {
                     buttonEl.innerHTML = originalContent;
                     buttonEl.disabled = false;
                }
            }
            
            listenPreviewBtn.addEventListener('click', async () => {
                const selectedVoice = voiceSelect.value;
                const audioUrl = await generateAndPlayAudio("Đây là giọng nói mẫu.", selectedVoice, listenPreviewBtn);
                if (audioUrl) {
                    new Audio(audioUrl).play();
                }
            });

            savedStyleSelect.addEventListener('change', (e) => {
                const selectedId = e.target.value;
                 if (!selectedId) {
                    styleInstructionsInput.value = '';
                    return;
                }
                const selectedVoice = voices.find(v => v.id == selectedId);
                if (selectedVoice) {
                    styleInstructionsInput.value = selectedVoice.content;
                }
            });

            textToVoiceForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const style = styleInstructionsInput.value;
                const script = document.getElementById('script-input').value;
                const voice = voiceSelect.value;
                const promptText = style ? `Say with this style: ${style}. Now, read the following script:\n\n${script}` : script;

                const audioUrl = await generateAndPlayAudio(promptText, voice, ttsSubmitBtn);
                if (audioUrl) {
                    audioPlayer.src = audioUrl;
                    audioResultContainer.classList.remove('hidden');
                } else {
                     audioResultContainer.classList.add('hidden');
                }
            });

            toggleApiKeyVisibilityBtn.addEventListener('click', () => {
                if (apiKeyInput.type === 'password') {
                    apiKeyInput.type = 'text';
                    toggleApiKeyVisibilityBtn.innerHTML = eyeOffIconSVG;
                } else {
                    apiKeyInput.type = 'password';
                    toggleApiKeyVisibilityBtn.innerHTML = eyeIconSVG;
                }
            });

            // Voice Storage Event Listeners
            newVoiceBtn.addEventListener('click', clearVoiceForm);

            voiceList.addEventListener('click', (e) => {
                 const deleteBtn = e.target.closest('.delete-voice-btn');
                const voiceItem = e.target.closest('.voice-item');
                
                if (deleteBtn) {
                    openDeleteModal(deleteBtn.dataset.id);
                } else if (voiceItem) {
                    loadVoiceIntoForm(voiceItem.dataset.id);
                }
            });

            voiceStorageForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const id = voiceStorageId.value;
                const title = voiceStorageTitle.value;
                const content = voiceStorageContent.value;

                if (id) { // Update existing
                    const index = voices.findIndex(v => v.id == id);
                    if (index > -1) {
                        voices[index] = { ...voices[index], title, content };
                    }
                } else { // Create new
                    const newVoice = { id: Date.now(), title, content };
                    voices.push(newVoice);
                    voiceStorageId.value = newVoice.id;
                }
                saveVoicesToStorage();
                renderVoiceList();
                alert('Đã lưu thành công!');
            });
            
            cancelDeleteBtn.addEventListener('click', closeDeleteModal);
            confirmDeleteBtn.addEventListener('click', performDelete);

        });
    </script>
</body>
</html>

